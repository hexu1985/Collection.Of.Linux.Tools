<!DOCTYPE html>
<!-- saved from url=(0038)https://zhuanlan.zhihu.com/p/406832315 -->
<html lang="zh" data-hairline="true" class="itcauecng" data-theme="light" data-rh="data-theme"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>深入浅出：如何正确使用 protobuf - 知乎</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=10,chrome=1"><meta name="google-site-verification" content="FTeR0c8arOPKh8c5DYh_9uu98_zJbaWw53J-Sch9MTg"><meta data-rh="true" name="keywords" content="protobuf,编程语言,编程"><meta data-rh="true" name="description" content="目录导航1 写在前面2 初识 protobuf 语法3 基于 Protobuf 的编程示例4 Protobuf 的数据类型5 Protobuf 编码方法5.1 Varint5.1.1 Varint 是什么？5.1.2 Tag 信息5.1.3 Data 信息5.2 ZigZag 编码5.2.1 ZigZag 编码解…"><meta data-rh="true" property="og:title" content="深入浅出：如何正确使用 protobuf"><meta data-rh="true" property="og:url" content="https://zhuanlan.zhihu.com/p/406832315"><meta data-rh="true" property="og:description" content="目录导航1 写在前面2 初识 protobuf 语法3 基于 Protobuf 的编程示例4 Protobuf 的数据类型5 Protobuf 编码方法5.1 Varint5.1.1 Varint 是什么？5.1.2 Tag 信息5.1.3 Data 信息5.2 ZigZag 编码5.2.1 ZigZag 编码解…"><meta data-rh="true" property="og:image" content="https://pic1.zhimg.com/v2-b1c16e5a81bd4ae56aa6651d34f7a7be_720w.jpg?source=172ae18b"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="og:site_name" content="知乎专栏"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-152.81060cab.png" sizes="152x152"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-120.d5793cac.png" sizes="120x120"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-76.7abf3393.png" sizes="76x76"><link data-rh="true" rel="apple-touch-icon" href="https://static.zhihu.com/heifetz/assets/apple-touch-icon-60.362a8eac.png" sizes="60x60"><link crossorigin="" rel="shortcut icon" type="image/x-icon" href="https://static.zhihu.com/heifetz/favicon.ico"><link crossorigin="" rel="search" type="application/opensearchdescription+xml" href="https://static.zhihu.com/heifetz/search.xml" title="知乎"><link rel="dns-prefetch" href="https://static.zhimg.com/"><link rel="dns-prefetch" href="https://pica.zhimg.com/"><link rel="dns-prefetch" href="https://pic1.zhimg.com/"><link rel="dns-prefetch" href="https://pic2.zhimg.com/"><link rel="dns-prefetch" href="https://pic3.zhimg.com/"><link rel="dns-prefetch" href="https://pic4.zhimg.com/"><link rel="dns-prefetch" href="https://static.zhihu.com/"><script nonce="" data-web-reporter-config="{&quot;platform&quot;:&quot;web&quot;,&quot;project&quot;:&quot;heifetz&quot;}">!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).webReporter={})}(this,function(e){"use strict";var t={},n=!1,o=function(){var e,o,r,a,i;return n||(e=document.querySelector("script[data-web-reporter-config]"),o=e&&e.dataset.webReporterConfig||"{}",r=JSON.parse(o),a=r.platform,i=r.project,t={platform:a,project:i},n=!0),t};function r(e){return a(function(){return localStorage.getItem(e)})()}function a(e){return function(){try{return e.apply(void 0,arguments)}catch(e){}}}var i=a(function(e,t){var n={platform:"web",project:o().project,clientTimestamp:+new Date};!function(e,t,n){"1"===r("weber:logenabled")&&console.log("[web-reporter]%o",{type:e,base:t,data:n})}(e,n,t),function(e,t){var n=btoa(JSON.stringify(t));if("undefined"!=typeof Blob&&window.navigator&&window.navigator.sendBeacon){var o=new Blob([n],{type:"text/plain"});navigator.sendBeacon(e,o)}else{var r=new XMLHttpRequest;r.open("POST",e),r.withCredentials=!1,r.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),r.send(n)}}(r("weber:api")||"https://apm.zhihu.com/collector/web_json",{type:e,base:n,data:t})});e.report=i,Object.defineProperty(e,"__esModule",{value:!0})});
</script><link href="./深入浅出：如何正确使用 protobuf - 知乎_files/5459.216a26f4.ae3f916f2bf048ca377d.css" crossorigin="" rel="stylesheet"><link href="./深入浅出：如何正确使用 protobuf - 知乎_files/column.216a26f4.f32f3564fcccdb253e7d.css" crossorigin="" rel="stylesheet"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/user-hover-card.216a26f4.7f1de7c441470974ce17.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/Labels.216a26f4.81c9ce8725560c5bcc6a.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/GoodsRecommendGoodsCardList.216a26f4.d95ce79191cdf8d7ac28.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/3757.216a26f4.bf8d6607cd19b4dd1bab.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/ECommerceAd.216a26f4.9fa9535cc2efe2b3edb4.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/5242.216a26f4.d85c1258a9cf7ea8720a.css" crossorigin="anonymous"><link rel="stylesheet" type="text/css" href="./深入浅出：如何正确使用 protobuf - 知乎_files/EditableV2.216a26f4.86147906b330fd7351a9.css" crossorigin="anonymous"><script nonce="">!function(){"use strict";!function(e,n){var r=[];function t(e){return function(){r.push([e,arguments])}}n.Raven={captureException:t("captureException"),captureMessage:t("captureMessage"),captureBreadcrumb:t("captureBreadcrumb")};var a,o,c,i,s,u="undefined"!=typeof DOMError;function d(e){var n=e instanceof Error||e instanceof ErrorEvent||u&&e instanceof DOMError||e instanceof DOMException;Raven.captureException(n?e:new Error(e.message||e.reason))}n.addEventListener("unhandledrejection",d),n.addEventListener("error",d,!0),a=e.src,o=e,c=function(){r.forEach(function(e){var n;(n=Raven)[e[0]].apply(n,e[1])}),n.removeEventListener("unhandledrejection",d),n.removeEventListener("error",d,!0)},i=document.head||document.getElementsByTagName("head")[0],(s=document.createElement("script")).crossOrigin=o.crossOrigin,s.dataset.sentryConfig=o["data-sentry-config"],s.onload=c,s.src=a,i.appendChild(s)}({"defer":true,"crossOrigin":"anonymous","src":"https://unpkg.zhimg.com/@cfe/sentry-script@1.3.1/dist/init.js","data-sentry-config":"{\"dsn\":\"https://2d8d764432cc4f6fb3bc78ab9528299d@crash2.zhihu.com/1224\",\"sampleRate\":0.1,\"release\":\"721-49f562a5\",\"ignoreErrorNames\":[\"NetworkError\",\"SecurityError\"],\"ignoreErrorsPreset\":\"ReactApp\",\"tags\":{\"app_name\":\"heifetz\"}}"},window)}();
</script><script crossorigin="anonymous" data-sentry-config="{&quot;dsn&quot;:&quot;https://2d8d764432cc4f6fb3bc78ab9528299d@crash2.zhihu.com/1224&quot;,&quot;sampleRate&quot;:0.1,&quot;release&quot;:&quot;721-49f562a5&quot;,&quot;ignoreErrorNames&quot;:[&quot;NetworkError&quot;,&quot;SecurityError&quot;],&quot;ignoreErrorsPreset&quot;:&quot;ReactApp&quot;,&quot;tags&quot;:{&quot;app_name&quot;:&quot;heifetz&quot;}}" src="./深入浅出：如何正确使用 protobuf - 知乎_files/init.js"></script><style data-emotion-css="uzm3ri">.css-uzm3ri{position:fixed;top:0;right:0;left:0;z-index:101;display:none;height:2px;pointer-events:none;background:#056DE8;-webkit-transform:translateX(-100%);-ms-transform:translateX(-100%);transform:translateX(-100%);}</style><style data-emotion-css="1l12z7y">.css-1l12z7y{box-shadow:0px 16px 32px rgba(0,0,0,0.04);}</style><style data-emotion-css="1hlrcxk">.css-1hlrcxk{-webkit-transition-property:fill;transition-property:fill;-webkit-transition-duration:0.25s;transition-duration:0.25s;-webkit-transition-timing-function:ease-in;transition-timing-function:ease-in;}</style><style data-emotion-css="icip60">.css-icip60{border-radius:2px;}</style><style data-emotion-css="1tzrnvf">.css-1tzrnvf{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;background-color:#FFFFFF;width:30px;height:30px;border-radius:2px;}</style><style data-emotion-css="78p1r9">.css-78p1r9{box-sizing:border-box;margin:0;min-width:0;margin-left:auto;margin-right:auto;max-width:690px;margin-top:0;}@media screen and (min-width:40em){.css-78p1r9{margin-top:1em;}}</style><style data-emotion-css="aa8hoc">.css-aa8hoc{position:relative;padding-bottom:64.5%;height:0;border-radius:inherit;}</style><style data-emotion-css="1stvxt9">.css-1stvxt9{box-sizing:border-box;margin:0;min-width:0;position:relative;padding-bottom:64.5%;height:0;border-radius:inherit;}</style><style data-emotion-css="1ld0bim">.css-1ld0bim{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:inherit;}</style><style data-emotion-css="1ujtx97">.css-1ujtx97{object-fit:cover;background-color:#F6F6F6;}</style><style data-emotion-css="uodor8">.css-uodor8{border-radius:50%;}</style><style data-emotion-css="1y9jkzv">.css-1y9jkzv{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;background-color:#FFFFFF;width:38px;height:38px;border-radius:50%;}</style><style data-emotion-css="1cd9gw4">.css-1cd9gw4{margin-left:.3em;}</style><style data-emotion-css="1yuhvjn">.css-1yuhvjn{margin-top:16px;}</style><style data-emotion-css="376mun">.css-376mun{position:relative;display:inline;}</style><style data-emotion-css="1hhle02">.css-1hhle02 .FileLinkCard{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(246,246,246,0.88);border-radius:12px;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1em auto;max-width:100%;overflow:hidden;padding:12px;position:relative;width:390px;}.css-1hhle02 .FileLinkCard-icon{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:30px;width:30px;}.css-1hhle02 .FileLinkCard-info{margin-left:12px;}.css-1hhle02 .FileLinkCard-name{color:#121212;font-size:15px;font-weight:500;line-height:21px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1hhle02 .FileLinkCard-meta{color:#999999;font-size:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;line-height:14px;margin-top:5px;}.css-1hhle02 .FileLinkCard-source{white-space:pre;}.css-1hhle02 img[data-uncomfortable]{content:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20344.88888888888886%20194%22%3E%3CforeignObject%20width%3D%22344.88888888888886%22%20height%3D%22194%22%3E%0A%20%20%20%20%20%20%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22font-size%3A%2013px%3B%20font-family%3A%20-apple-system%2C%20BlinkMacSystemFont%2C%20Microsoft%20YaHei%2C%20sans-serif%3B%20color%3A%20%23fff%3B%20width%3A100%25%3B%20height%3A194px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20height%3A%20100%25%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2218%22%20height%3D%2218%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22currentColor%22%3E%3Cpath%20d%3D%22M8%203.65a7%207%200%2000-1.353.128.65.65%200%2011-.25-1.275A8.3%208.3%200%20018%202.35c2.387%200%204.172.954%205.357%202.125C14.511%205.615%2015.15%207.022%2015.15%208c0%20.621-.257%201.391-.699%202.134a7.076%207.076%200%2001-1.403%201.68l.495.46a.65.65%200%2011-.886.951l-.998-.929a.645.645%200%2001-.104-.097L9.73%2010.501a.647.647%200%2001-.29.301%203.15%203.15%200%2001-4.313-4.094.647.647%200%2001.234-.275L3.908%205.08a5.774%205.774%200%2000-1.283%201.522C2.282%207.198%202.15%207.707%202.15%208c0%20.522.41%201.616%201.407%202.6.965.954%202.43%201.75%204.443%201.75.468%200%20.905-.043%201.311-.12a.65.65%200%2001.243%201.277A8.322%208.322%200%20018%2013.65c-2.387%200-4.172-.954-5.357-2.125C1.49%2010.385.85%208.978.85%208c0-.598.238-1.333.648-2.046A7.054%207.054%200%20012.95%204.188l-.547-.509a.65.65%200%2011.886-.951l8.8%208.194a5.793%205.793%200%20001.244-1.453c.372-.624.516-1.163.516-1.469%200-.522-.41-1.616-1.407-2.6-.965-.954-2.43-1.75-4.443-1.75zM6.29%207.296a1.85%201.85%200%20002.534%202.36l-2.535-2.36zM8%204.85a.65.65%200%20100%201.3%201.85%201.85%200%20011.843%201.694.65.65%200%20101.296-.11A3.15%203.15%200%20008%204.85z%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22margin%3A%20.6em%200%201.2em%22%3E%E8%AF%A5%E5%9B%BE%E7%89%87%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E4%B8%8D%E9%80%82%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbutton%20style%3D%22padding%3A%204px%201em%3B%20font-size%3A%201.1em%3B%20color%3A%20inherit%3B%20background%3A%20none%3B%20border%3A%201px%20solid%20rgba%28255%2C255%2C255%2C.5%29%3B%20border-radius%3A%209999px%3B%22%3E%E7%BB%A7%E7%BB%AD%E6%9F%A5%E7%9C%8B%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FforeignObject%3E%3C%2Fsvg%3E);width:100%;height:194px;background:url(https://pic1.zhimg.com/v2-cf70d0759d787c70091857151c1cad4a.jpeg) no-repeat rgba(191,191,191,0.7);background-size:cover;cursor:pointer!important;}</style><style data-emotion-css="1wr1m8">.css-1wr1m8 .LinkCard.new{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:390px;min-height:84px;border-radius:8px;max-width:100%;overflow:hidden;margin:16px auto;padding:12px 12px 9px 12px;background-color:#F6F6F6;}.css-1wr1m8 .LinkCard.new,.css-1wr1m8 .LinkCard.new:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1wr1m8 .LinkCard.new .LinkCard-contents{display:block;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;position:relative;}.css-1wr1m8 .LinkCard.new .LinkCard-contents .loading{height:14px;background:#EBEBEB;border-radius:7px;}.css-1wr1m8 .LinkCard.new .LinkCard-contents.withTitle{margin-bottom:3px;}.css-1wr1m8 .LinkCard.new .LinkCard-title{display:-webkit-box;font-size:15px;font-weight:500;line-height:1.4;margin-bottom:2px;color:#121212;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1wr1m8 .LinkCard.new .LinkCard-title.two-line{line-height:20px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1wr1m8 .LinkCard.new .LinkCard-title.loading{margin-bottom:8px;width:80%;}.css-1wr1m8 .LinkCard.new .LinkCard-title.loading.withTitle{margin-bottom:6px;}.css-1wr1m8 .LinkCard.new .LinkCard-title.loadingTitle{margin-bottom:5px;}.css-1wr1m8 .LinkCard.new .LinkCard-excerpt{display:-webkit-box;text-overflow:ellipsis;font-size:13px;line-height:18px;color:#999999;margin-bottom:4px;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1wr1m8 .LinkCard.new .LinkCard-excerpt .LinkCard-author{color:#444444;}.css-1wr1m8 .LinkCard.new .LinkCard-desc{display:-webkit-box;font-size:13px;height:18px;line-height:18px;color:#999999;word-break:break-all;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1wr1m8 .LinkCard.new .LinkCard-desc .LinkCard-tag,.css-1wr1m8 .LinkCard.new .LinkCard-desc .tag{display:inline-block;font-size:11px;margin-left:8px;padding:0 4px;border-radius:3px;background:rgba(211,211,211,0.3);}.css-1wr1m8 .LinkCard.new .LinkCard-desc.loading{width:40%;}.css-1wr1m8 .LinkCard.new .LinkCard-desc svg{margin-right:2px;}.css-1wr1m8 .LinkCard.new .LinkCard-image{-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;background-color:#EBEBEB;background-size:cover;background-position:center;position:relative;display:block;width:60px;height:60px;margin-left:20px;object-fit:cover;border-radius:inherit;overflow:hidden;}.css-1wr1m8 .LinkCard.new .LinkCard-image.LinkCard-image--default{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:#EBEBEB;color:#D3D3D3;}.css-1wr1m8 .LinkCard.new .LinkCard-image.LinkCard-image--default svg{color:#999999;}.css-1wr1m8 .LinkCard.new .LinkCard-image img{width:100%;height:100%;object-fit:cover;}.css-1wr1m8 .LinkCard.new .LinkCard-image .LinkCard-image--video{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:24px;height:24px;border-radius:12px;background:rgba(255,255,255,0.9);pointer-events:none;}.css-1wr1m8 .LinkCard.new .LinkCard-image .LinkCard-image--video svg{color:#444444;}.css-1wr1m8 .LinkCard.new .LinkCard-richText .text{color:#444444;}.css-1wr1m8 .LinkCard.new .LinkCard-richText .bold{font-weight:600;}.css-1wr1m8 .LinkCard.new .LinkCard-richText .tag{margin-left:4px;}.css-1wr1m8 .LinkCard.old{position:relative;display:block;margin:1em auto;width:390px;box-sizing:border-box;border-radius:12px;max-width:100%;overflow:hidden;}.css-1wr1m8 .LinkCard.old,.css-1wr1m8 .LinkCard.old:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1wr1m8 .LinkCard-ecommerceLoadingCard{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding:12px;border-radius:inherit;height:80px;box-sizing:border-box;background:rgba(246,246,246,0.88);color:#D3D3D3;}.css-1wr1m8 .LinkCard-ecommerceLoadingCardAvatarWrapper{width:60px;height:60px;background:#EBEBEB;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;border-radius:6px;margin-right:10px;}.css-1wr1m8 .LinkCard-ecommerceLoadingCardNetwork{width:20px;height:20px;}.css-1wr1m8 .LinkCard-ecommerceLoadingCardLoadingbar{height:60px;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1wr1m8 .LinkCard-ecommerceLoadingCardLoadingbar span{height:16px;display:inline-block;background:#EBEBEB;}.css-1wr1m8 .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(1){width:60px;margin-bottom:4px;}.css-1wr1m8 .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(2){width:127px;}</style><style data-emotion-css="1dnyyvy">.css-1dnyyvy .LinkCard.old{position:relative;display:block;margin:1em auto;width:390px;box-sizing:border-box;border-radius:12px;max-width:100%;overflow:hidden;}.css-1dnyyvy .LinkCard.old,.css-1dnyyvy .LinkCard.old:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1dnyyvy .LinkCard-ecommerceLoadingCard{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding:12px;border-radius:inherit;height:80px;box-sizing:border-box;background:rgba(246,246,246,0.88);color:#D3D3D3;}.css-1dnyyvy .LinkCard-ecommerceLoadingCardAvatarWrapper{width:60px;height:60px;background:#EBEBEB;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;border-radius:6px;margin-right:10px;}.css-1dnyyvy .LinkCard-ecommerceLoadingCardNetwork{width:20px;height:20px;}.css-1dnyyvy .LinkCard-ecommerceLoadingCardLoadingbar{height:60px;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1dnyyvy .LinkCard-ecommerceLoadingCardLoadingbar span{height:16px;display:inline-block;background:#EBEBEB;}.css-1dnyyvy .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(1){width:60px;margin-bottom:4px;}.css-1dnyyvy .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(2){width:127px;}.css-1dnyyvy .LinkCard.new{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:390px;min-height:84px;border-radius:8px;max-width:100%;overflow:hidden;margin:16px auto;padding:12px 12px 9px 12px;background-color:#F6F6F6;}.css-1dnyyvy .LinkCard.new,.css-1dnyyvy .LinkCard.new:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1dnyyvy .LinkCard.new .LinkCard-contents{display:block;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;position:relative;}.css-1dnyyvy .LinkCard.new .LinkCard-contents .loading{height:14px;background:#EBEBEB;border-radius:7px;}.css-1dnyyvy .LinkCard.new .LinkCard-contents.withTitle{margin-bottom:3px;}.css-1dnyyvy .LinkCard.new .LinkCard-title{display:-webkit-box;font-size:15px;font-weight:500;line-height:1.4;margin-bottom:2px;color:#121212;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1dnyyvy .LinkCard.new .LinkCard-title.two-line{line-height:20px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1dnyyvy .LinkCard.new .LinkCard-title.loading{margin-bottom:8px;width:80%;}.css-1dnyyvy .LinkCard.new .LinkCard-title.loading.withTitle{margin-bottom:6px;}.css-1dnyyvy .LinkCard.new .LinkCard-title.loadingTitle{margin-bottom:5px;}.css-1dnyyvy .LinkCard.new .LinkCard-excerpt{display:-webkit-box;text-overflow:ellipsis;font-size:13px;line-height:18px;color:#999999;margin-bottom:4px;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1dnyyvy .LinkCard.new .LinkCard-excerpt .LinkCard-author{color:#444444;}.css-1dnyyvy .LinkCard.new .LinkCard-desc{display:-webkit-box;font-size:13px;height:18px;line-height:18px;color:#999999;word-break:break-all;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1dnyyvy .LinkCard.new .LinkCard-desc .LinkCard-tag,.css-1dnyyvy .LinkCard.new .LinkCard-desc .tag{display:inline-block;font-size:11px;margin-left:8px;padding:0 4px;border-radius:3px;background:rgba(211,211,211,0.3);}.css-1dnyyvy .LinkCard.new .LinkCard-desc.loading{width:40%;}.css-1dnyyvy .LinkCard.new .LinkCard-desc svg{margin-right:2px;}.css-1dnyyvy .LinkCard.new .LinkCard-image{-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;background-color:#EBEBEB;background-size:cover;background-position:center;position:relative;display:block;width:60px;height:60px;margin-left:20px;object-fit:cover;border-radius:inherit;overflow:hidden;}.css-1dnyyvy .LinkCard.new .LinkCard-image.LinkCard-image--default{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:#EBEBEB;color:#D3D3D3;}.css-1dnyyvy .LinkCard.new .LinkCard-image.LinkCard-image--default svg{color:#999999;}.css-1dnyyvy .LinkCard.new .LinkCard-image img{width:100%;height:100%;object-fit:cover;}.css-1dnyyvy .LinkCard.new .LinkCard-image .LinkCard-image--video{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:24px;height:24px;border-radius:12px;background:rgba(255,255,255,0.9);pointer-events:none;}.css-1dnyyvy .LinkCard.new .LinkCard-image .LinkCard-image--video svg{color:#444444;}.css-1dnyyvy .LinkCard.new .LinkCard-richText .text{color:#444444;}.css-1dnyyvy .LinkCard.new .LinkCard-richText .bold{font-weight:600;}.css-1dnyyvy .LinkCard.new .LinkCard-richText .tag{margin-left:4px;}.css-1dnyyvy .FileLinkCard{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(246,246,246,0.88);border-radius:12px;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1em auto;max-width:100%;overflow:hidden;padding:12px;position:relative;width:390px;}.css-1dnyyvy .FileLinkCard-icon{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:30px;width:30px;}.css-1dnyyvy .FileLinkCard-info{margin-left:12px;}.css-1dnyyvy .FileLinkCard-name{color:#121212;font-size:15px;font-weight:500;line-height:21px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1dnyyvy .FileLinkCard-meta{color:#999999;font-size:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;line-height:14px;margin-top:5px;}.css-1dnyyvy .FileLinkCard-source{white-space:pre;}.css-1dnyyvy img[data-uncomfortable]{content:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20344.88888888888886%20194%22%3E%3CforeignObject%20width%3D%22344.88888888888886%22%20height%3D%22194%22%3E%0A%20%20%20%20%20%20%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22font-size%3A%2013px%3B%20font-family%3A%20-apple-system%2C%20BlinkMacSystemFont%2C%20Microsoft%20YaHei%2C%20sans-serif%3B%20color%3A%20%23fff%3B%20width%3A100%25%3B%20height%3A194px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20height%3A%20100%25%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2218%22%20height%3D%2218%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22currentColor%22%3E%3Cpath%20d%3D%22M8%203.65a7%207%200%2000-1.353.128.65.65%200%2011-.25-1.275A8.3%208.3%200%20018%202.35c2.387%200%204.172.954%205.357%202.125C14.511%205.615%2015.15%207.022%2015.15%208c0%20.621-.257%201.391-.699%202.134a7.076%207.076%200%2001-1.403%201.68l.495.46a.65.65%200%2011-.886.951l-.998-.929a.645.645%200%2001-.104-.097L9.73%2010.501a.647.647%200%2001-.29.301%203.15%203.15%200%2001-4.313-4.094.647.647%200%2001.234-.275L3.908%205.08a5.774%205.774%200%2000-1.283%201.522C2.282%207.198%202.15%207.707%202.15%208c0%20.522.41%201.616%201.407%202.6.965.954%202.43%201.75%204.443%201.75.468%200%20.905-.043%201.311-.12a.65.65%200%2001.243%201.277A8.322%208.322%200%20018%2013.65c-2.387%200-4.172-.954-5.357-2.125C1.49%2010.385.85%208.978.85%208c0-.598.238-1.333.648-2.046A7.054%207.054%200%20012.95%204.188l-.547-.509a.65.65%200%2011.886-.951l8.8%208.194a5.793%205.793%200%20001.244-1.453c.372-.624.516-1.163.516-1.469%200-.522-.41-1.616-1.407-2.6-.965-.954-2.43-1.75-4.443-1.75zM6.29%207.296a1.85%201.85%200%20002.534%202.36l-2.535-2.36zM8%204.85a.65.65%200%20100%201.3%201.85%201.85%200%20011.843%201.694.65.65%200%20101.296-.11A3.15%203.15%200%20008%204.85z%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22margin%3A%20.6em%200%201.2em%22%3E%E8%AF%A5%E5%9B%BE%E7%89%87%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E4%B8%8D%E9%80%82%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbutton%20style%3D%22padding%3A%204px%201em%3B%20font-size%3A%201.1em%3B%20color%3A%20inherit%3B%20background%3A%20none%3B%20border%3A%201px%20solid%20rgba%28255%2C255%2C255%2C.5%29%3B%20border-radius%3A%209999px%3B%22%3E%E7%BB%A7%E7%BB%AD%E6%9F%A5%E7%9C%8B%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FforeignObject%3E%3C%2Fsvg%3E);width:100%;height:194px;background:url(https://pic1.zhimg.com/v2-cf70d0759d787c70091857151c1cad4a.jpeg) no-repeat rgba(191,191,191,0.7);background-size:cover;cursor:pointer!important;}</style><style data-emotion-css="1g0fqss animation-1yvu044">.css-1g0fqss{word-break:break-word;line-height:1.6;}.css-1g0fqss > [data-first-child]{margin-top:0;}.css-1g0fqss > :last-child{margin-bottom:0;}.css-1g0fqss h1,.css-1g0fqss h2{clear:left;margin-top:calc((1.4em * 2) / 1.2);margin-bottom:calc(1.4em / 1.2);font-size:1.2em;line-height:1.5;font-weight:600;}.css-1g0fqss h3,.css-1g0fqss h4,.css-1g0fqss h5,.css-1g0fqss h6{clear:left;margin-top:calc((1.4em * 1.5) / 1.1);margin-bottom:calc(1.4em / 1.1);font-size:1.1em;line-height:1.5;font-weight:600;}.css-1g0fqss u{-webkit-text-decoration:none;text-decoration:none;border-bottom:1px solid #444444;}.css-1g0fqss b{font-weight:600;}.css-1g0fqss sup{font-size:0.8em;}.css-1g0fqss sup[data-draft-type='reference']{color:#175199;}.css-1g0fqss a:focus{outline:none;-webkit-transition:box-shadow 0.3s;transition:box-shadow 0.3s;}html[data-focus-visible] .css-1g0fqss a:focus{box-shadow:0 0 0 2px #FFFFFF,0 0 0 4px rgba(5,109,232,0.3);}.css-1g0fqss a.ztext-link,.css-1g0fqss a.internal,.css-1g0fqss a.external{-webkit-text-decoration:none;text-decoration:none;cursor:pointer;border-bottom:1px solid #808080;}.css-1g0fqss a.ztext-link:hover,.css-1g0fqss a.internal:hover,.css-1g0fqss a.external:hover{color:#175199;border-bottom:1px solid #175199;}.css-1g0fqss a.ztext-link > .ellipsis::after,.css-1g0fqss a.internal > .ellipsis::after,.css-1g0fqss a.external > .ellipsis::after{content:'...';}.css-1g0fqss a.ztext-link > .invisible,.css-1g0fqss a.internal > .invisible,.css-1g0fqss a.external > .invisible{font:0/0 a;color:transparent;text-shadow:none;background-color:transparent;}.css-1g0fqss a.ztext-link u,.css-1g0fqss a.internal u,.css-1g0fqss a.external u{border:none;}.css-1g0fqss a.member_mention{color:#175199;}.css-1g0fqss a.member_mention:hover{border-bottom:1px solid #175199;}.css-1g0fqss a.UserLink-link{color:#175199;}.css-1g0fqss a.UserLink-link:hover{border-bottom:1px solid #175199;}.css-1g0fqss p{margin:1.4em 0;}.css-1g0fqss p.ztext-empty-paragraph{margin:calc((2.8em- (1.4em * 2 + 1.6em)) / 2) 0;}.css-1g0fqss p.ztext-empty-paragraph + .ztext-empty-paragraph{margin:1.4em 0;}.css-1g0fqss hr{margin:4em auto;width:240px;max-width:100%;border:none;border-top:1px solid #D3D3D3;}.css-1g0fqss img[eeimg]{max-width:100%;vertical-align:middle;}.css-1g0fqss img[eeimg="1"]{margin:0 3px;max-width:calc(100% - 6px);display:inline-block;}.css-1g0fqss img[eeimg="2"]{margin:1.4em auto;display:block;}.css-1g0fqss blockquote{margin:1.4em 0;padding-left:1em;color:#646464;border-left:3px solid #D3D3D3;}.css-1g0fqss ol,.css-1g0fqss ul{margin:1.4em 0;padding:0;width:100%;}.css-1g0fqss ol ol,.css-1g0fqss ul ol,.css-1g0fqss ol ul,.css-1g0fqss ul ul{margin:0;}.css-1g0fqss ol li::before,.css-1g0fqss ul li::before{width:1em;}.css-1g0fqss ol > ol,.css-1g0fqss ul > ol,.css-1g0fqss ol > ul,.css-1g0fqss ul > ul{display:table-row;}.css-1g0fqss ol > ol::before,.css-1g0fqss ul > ol::before,.css-1g0fqss ol > ul::before,.css-1g0fqss ul > ul::before{display:table-cell;content:'';}.css-1g0fqss ul{display:table;}.css-1g0fqss ul>li{display:table-row;list-style:none;}.css-1g0fqss ul>li::before{display:table-cell;content:'•  ';white-space:pre;}.css-1g0fqss ol{display:table;counter-reset:ol;}.css-1g0fqss ol > li{display:table-row;list-style:none;}.css-1g0fqss ol > li::before{display:table-cell;text-align:right;counter-increment:ol;content:counter(ol) '. ';white-space:pre;}.css-1g0fqss ol ol{counter-reset:ol2;}.css-1g0fqss ol ol li::before{counter-increment:ol2;content:counter(ol2) '. ';}.css-1g0fqss ol ol ol{counter-reset:ol3;}.css-1g0fqss ol ol ol li::before{counter-increment:ol3;content:counter(ol3) '. ';}.css-1g0fqss ol ol ol ol{counter-reset:ol4;}.css-1g0fqss ol ol ol ol li::before{counter-increment:ol4;content:counter(ol4) '. ';}.css-1g0fqss figure{margin:1.4em 0;}.css-1g0fqss figure .content_image,.css-1g0fqss figure .origin_image{margin:0 auto;}.css-1g0fqss figure figcaption{margin-top:calc(0.6em / 0.9);padding:0 1em;font-size:0.9em;line-height:1.5;text-align:center;color:#999999;}.css-1g0fqss figure + figure{margin-top:calc(1.4em * 1.6);}.css-1g0fqss figure[data-size='small'],.css-1g0fqss figure:not([data-size]) > [data-size='small']{clear:both;}.css-1g0fqss figure[data-size='left'],.css-1g0fqss figure:not([data-size]) > [data-size='left']{float:left;margin:0 20px 20px 0;max-width:33%;}.css-1g0fqss figure[data-size='right'],.css-1g0fqss figure:not([data-size]) > [data-size='right']{float:right;margin:0 0 20px 20px;max-width:33%;}.css-1g0fqss figure[data-size='collapse']{margin-bottom:0;}.css-1g0fqss figure[data-size='collapse'] + figure{margin-top:0;}.css-1g0fqss .content_image,.css-1g0fqss .origin_image{display:block;max-width:100%;height:auto;margin:1.4em auto;}.css-1g0fqss .content_image[data-size='small'],.css-1g0fqss .origin_image[data-size='small']{max-width:40%;}.css-1g0fqss .content_image.zh-lightbox-thumb,.css-1g0fqss .origin_image.zh-lightbox-thumb{cursor:-webkit-zoom-in;cursor:-moz-zoom-in;cursor:zoom-in;}.css-1g0fqss code{margin:0 2px;padding:3px 4px;border-radius:3px;font-family:Menlo,Monaco,Consolas,'Andale Mono','lucida console','Courier New',monospace;font-size:0.9em;background-color:#F6F6F6;}.css-1g0fqss pre{margin:1.4em 0;padding:calc(0.8em / 0.9);font-size:0.9em;word-break:initial;word-wrap:initial;white-space:pre;overflow:auto;-webkit-overflow-scrolling:touch;background:#F6F6F6;border-radius:4px;}.css-1g0fqss pre code{margin:0;padding:0;font-size:inherit;border-radius:0;background-color:inherit;}.css-1g0fqss li pre{white-space:pre-wrap;}.css-1g0fqss table[data-draft-type='table']{border-collapse:collapse;font-size:15px;margin:1.4em auto;max-width:100%;table-layout:fixed;text-align:left;width:100%;}.css-1g0fqss table[data-draft-type='table'][data-size='small']{min-width:260px;width:40%;}.css-1g0fqss table[data-draft-type='table'][data-row-style='striped'] tr:nth-of-type(2n + 1){background:#F6F6F6;}.css-1g0fqss table[data-draft-type='table'] td,.css-1g0fqss table[data-draft-type='table'] th{border:1px solid #D3D3D3;line-height:24px;height:24px;padding:3px 12px;}.css-1g0fqss table[data-draft-type='table'] th{background:#EBEBEB;color:#121212;font-weight:500;}.css-1g0fqss .video-box,.css-1g0fqss .link-box{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;margin:1.4em 0;overflow:auto;white-space:normal;cursor:pointer;border:solid 1px #EBEBEB;border-radius:4px;}.css-1g0fqss .lazy[data-lazy-status]{background-color:#F6F6F6;}.css-1g0fqss .lazy[data-lazy-status="ok"]{background-color:transparent;-webkit-animation:animation-1yvu044 0.5s ease-in;animation:animation-1yvu044 0.5s ease-in;}.css-1g0fqss .highlight{margin:1em 0;}.css-1g0fqss .highlight pre{margin:0;}.css-1g0fqss .highlight .hll{background-color:#FDFDFD;}.css-1g0fqss .highlight .c{font-style:italic;color:#999999;}.css-1g0fqss .highlight .err{color:#F1403C;}.css-1g0fqss .highlight .k{font-weight:600;}.css-1g0fqss .highlight .o{font-weight:600;}.css-1g0fqss .highlight .cm{font-style:italic;color:#999999;}.css-1g0fqss .highlight .cp{font-weight:600;color:#999999;}.css-1g0fqss .highlight .c1{font-style:italic;color:#999999;}.css-1g0fqss .highlight .cs{font-style:italic;font-weight:600;color:#999999;}.css-1g0fqss .highlight .gd{color:#FF3366;}.css-1g0fqss .highlight .ge{font-style:italic;}.css-1g0fqss .highlight .gr{color:#F1403C;}.css-1g0fqss .highlight .gh{color:#999999;}.css-1g0fqss .highlight .gi{color:#12b370;}.css-1g0fqss .highlight .go{color:#808080;}.css-1g0fqss .highlight .gp{color:#646464;}.css-1g0fqss .highlight .gs{font-weight:600;}.css-1g0fqss .highlight .gu{color:#999999;}.css-1g0fqss .highlight .gt{color:#F1403C;}.css-1g0fqss .highlight .kc{font-weight:600;}.css-1g0fqss .highlight .kd{font-weight:600;}.css-1g0fqss .highlight .kn{font-weight:600;}.css-1g0fqss .highlight .kp{font-weight:600;}.css-1g0fqss .highlight .kr{font-weight:600;}.css-1g0fqss .highlight .kt{font-weight:600;color:#175199;}.css-1g0fqss .highlight .m{color:#056DE8;}.css-1g0fqss .highlight .s{color:#F1403C;}.css-1g0fqss .highlight .na{color:#056DE8;}.css-1g0fqss .highlight .nb{color:#056DE8;}.css-1g0fqss .highlight .nc{font-weight:600;color:#175199;}.css-1g0fqss .highlight .no{color:#056DE8;}.css-1g0fqss .highlight .ni{color:#5555DD;}.css-1g0fqss .highlight .ne{font-weight:600;color:#F1403C;}.css-1g0fqss .highlight .nf{font-weight:600;color:#F1403C;}.css-1g0fqss .highlight .nn{color:#646464;}.css-1g0fqss .highlight .nt{color:#175199;}.css-1g0fqss .highlight .nv{color:#056DE8;}.css-1g0fqss .highlight .ow{font-weight:600;}.css-1g0fqss .highlight .w{color:#BFBFBF;}.css-1g0fqss .highlight .mf{color:#056DE8;}.css-1g0fqss .highlight .mh{color:#056DE8;}.css-1g0fqss .highlight .mi{color:#056DE8;}.css-1g0fqss .highlight .mo{color:#056DE8;}.css-1g0fqss .highlight .sb{color:#F1403C;}.css-1g0fqss .highlight .sc{color:#F1403C;}.css-1g0fqss .highlight .sd{color:#F1403C;}.css-1g0fqss .highlight .s2{color:#F1403C;}.css-1g0fqss .highlight .se{color:#F1403C;}.css-1g0fqss .highlight .sh{color:#F1403C;}.css-1g0fqss .highlight .si{color:#F1403C;}.css-1g0fqss .highlight .sx{color:#F1403C;}.css-1g0fqss .highlight .sr{color:#A5542F;}.css-1g0fqss .highlight .s1{color:#F1403C;}.css-1g0fqss .highlight .ss{color:#F1403C;}.css-1g0fqss .highlight .bp{color:#999999;}.css-1g0fqss .highlight .vc{color:#056DE8;}.css-1g0fqss .highlight .vg{color:#056DE8;}.css-1g0fqss .highlight .vi{color:#056DE8;}.css-1g0fqss .highlight .il{color:#056DE8;}.css-1g0fqss .highlight::-webkit-scrollbar{width:6px;height:6px;}.css-1g0fqss .highlight::-webkit-scrollbar-thumb:horizontal{background-color:rgba(18,18,18,0.5);border-radius:6px;}.css-1g0fqss .highlight::-webkit-scrollbar-thumb:horizontal:hover{background-color:rgba(18,18,18,0.6);}.css-1g0fqss .LinkCard.old{position:relative;display:block;margin:1em auto;width:390px;box-sizing:border-box;border-radius:12px;max-width:100%;overflow:hidden;}.css-1g0fqss .LinkCard.old,.css-1g0fqss .LinkCard.old:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1g0fqss .LinkCard-ecommerceLoadingCard{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding:12px;border-radius:inherit;height:80px;box-sizing:border-box;background:rgba(246,246,246,0.88);color:#D3D3D3;}.css-1g0fqss .LinkCard-ecommerceLoadingCardAvatarWrapper{width:60px;height:60px;background:#EBEBEB;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;border-radius:6px;margin-right:10px;}.css-1g0fqss .LinkCard-ecommerceLoadingCardNetwork{width:20px;height:20px;}.css-1g0fqss .LinkCard-ecommerceLoadingCardLoadingbar{height:60px;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1g0fqss .LinkCard-ecommerceLoadingCardLoadingbar span{height:16px;display:inline-block;background:#EBEBEB;}.css-1g0fqss .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(1){width:60px;margin-bottom:4px;}.css-1g0fqss .LinkCard-ecommerceLoadingCardLoadingbar span:nth-of-type(2){width:127px;}.css-1g0fqss .LinkCard.new{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;box-sizing:border-box;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:390px;min-height:84px;border-radius:8px;max-width:100%;overflow:hidden;margin:16px auto;padding:12px 12px 9px 12px;background-color:#F6F6F6;}.css-1g0fqss .LinkCard.new,.css-1g0fqss .LinkCard.new:hover{-webkit-text-decoration:none;text-decoration:none;border:none !important;color:inherit !important;}.css-1g0fqss .LinkCard.new .LinkCard-contents{display:block;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;position:relative;}.css-1g0fqss .LinkCard.new .LinkCard-contents .loading{height:14px;background:#EBEBEB;border-radius:7px;}.css-1g0fqss .LinkCard.new .LinkCard-contents.withTitle{margin-bottom:3px;}.css-1g0fqss .LinkCard.new .LinkCard-title{display:-webkit-box;font-size:15px;font-weight:500;line-height:1.4;margin-bottom:2px;color:#121212;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1g0fqss .LinkCard.new .LinkCard-title.two-line{line-height:20px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1g0fqss .LinkCard.new .LinkCard-title.loading{margin-bottom:8px;width:80%;}.css-1g0fqss .LinkCard.new .LinkCard-title.loading.withTitle{margin-bottom:6px;}.css-1g0fqss .LinkCard.new .LinkCard-title.loadingTitle{margin-bottom:5px;}.css-1g0fqss .LinkCard.new .LinkCard-excerpt{display:-webkit-box;text-overflow:ellipsis;font-size:13px;line-height:18px;color:#999999;margin-bottom:4px;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1g0fqss .LinkCard.new .LinkCard-excerpt .LinkCard-author{color:#444444;}.css-1g0fqss .LinkCard.new .LinkCard-desc{display:-webkit-box;font-size:13px;height:18px;line-height:18px;color:#999999;word-break:break-all;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:1;}.css-1g0fqss .LinkCard.new .LinkCard-desc .LinkCard-tag,.css-1g0fqss .LinkCard.new .LinkCard-desc .tag{display:inline-block;font-size:11px;margin-left:8px;padding:0 4px;border-radius:3px;background:rgba(211,211,211,0.3);}.css-1g0fqss .LinkCard.new .LinkCard-desc.loading{width:40%;}.css-1g0fqss .LinkCard.new .LinkCard-desc svg{margin-right:2px;}.css-1g0fqss .LinkCard.new .LinkCard-image{-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;background-color:#EBEBEB;background-size:cover;background-position:center;position:relative;display:block;width:60px;height:60px;margin-left:20px;object-fit:cover;border-radius:inherit;overflow:hidden;}.css-1g0fqss .LinkCard.new .LinkCard-image.LinkCard-image--default{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;background-color:#EBEBEB;color:#D3D3D3;}.css-1g0fqss .LinkCard.new .LinkCard-image.LinkCard-image--default svg{color:#999999;}.css-1g0fqss .LinkCard.new .LinkCard-image img{width:100%;height:100%;object-fit:cover;}.css-1g0fqss .LinkCard.new .LinkCard-image .LinkCard-image--video{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:50%;left:50%;-webkit-transform:translateX(-50%) translateY(-50%);-ms-transform:translateX(-50%) translateY(-50%);transform:translateX(-50%) translateY(-50%);width:24px;height:24px;border-radius:12px;background:rgba(255,255,255,0.9);pointer-events:none;}.css-1g0fqss .LinkCard.new .LinkCard-image .LinkCard-image--video svg{color:#444444;}.css-1g0fqss .LinkCard.new .LinkCard-richText .text{color:#444444;}.css-1g0fqss .LinkCard.new .LinkCard-richText .bold{font-weight:600;}.css-1g0fqss .LinkCard.new .LinkCard-richText .tag{margin-left:4px;}.css-1g0fqss .FileLinkCard{-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:rgba(246,246,246,0.88);border-radius:12px;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:1em auto;max-width:100%;overflow:hidden;padding:12px;position:relative;width:390px;}.css-1g0fqss .FileLinkCard-icon{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:30px;width:30px;}.css-1g0fqss .FileLinkCard-info{margin-left:12px;}.css-1g0fqss .FileLinkCard-name{color:#121212;font-size:15px;font-weight:500;line-height:21px;display:-webkit-box;text-overflow:ellipsis;overflow:hidden;-webkit-box-orient:vertical;-webkit-line-clamp:2;}.css-1g0fqss .FileLinkCard-meta{color:#999999;font-size:12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;line-height:14px;margin-top:5px;}.css-1g0fqss .FileLinkCard-source{white-space:pre;}.css-1g0fqss img[data-uncomfortable]{content:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20344.88888888888886%20194%22%3E%3CforeignObject%20width%3D%22344.88888888888886%22%20height%3D%22194%22%3E%0A%20%20%20%20%20%20%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22font-size%3A%2013px%3B%20font-family%3A%20-apple-system%2C%20BlinkMacSystemFont%2C%20Microsoft%20YaHei%2C%20sans-serif%3B%20color%3A%20%23fff%3B%20width%3A100%25%3B%20height%3A194px%3B%22%3E%0A%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22display%3A%20flex%3B%20flex-direction%3A%20column%3B%20align-items%3A%20center%3B%20justify-content%3A%20center%3B%20height%3A%20100%25%3B%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2218%22%20height%3D%2218%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22currentColor%22%3E%3Cpath%20d%3D%22M8%203.65a7%207%200%2000-1.353.128.65.65%200%2011-.25-1.275A8.3%208.3%200%20018%202.35c2.387%200%204.172.954%205.357%202.125C14.511%205.615%2015.15%207.022%2015.15%208c0%20.621-.257%201.391-.699%202.134a7.076%207.076%200%2001-1.403%201.68l.495.46a.65.65%200%2011-.886.951l-.998-.929a.645.645%200%2001-.104-.097L9.73%2010.501a.647.647%200%2001-.29.301%203.15%203.15%200%2001-4.313-4.094.647.647%200%2001.234-.275L3.908%205.08a5.774%205.774%200%2000-1.283%201.522C2.282%207.198%202.15%207.707%202.15%208c0%20.522.41%201.616%201.407%202.6.965.954%202.43%201.75%204.443%201.75.468%200%20.905-.043%201.311-.12a.65.65%200%2001.243%201.277A8.322%208.322%200%20018%2013.65c-2.387%200-4.172-.954-5.357-2.125C1.49%2010.385.85%208.978.85%208c0-.598.238-1.333.648-2.046A7.054%207.054%200%20012.95%204.188l-.547-.509a.65.65%200%2011.886-.951l8.8%208.194a5.793%205.793%200%20001.244-1.453c.372-.624.516-1.163.516-1.469%200-.522-.41-1.616-1.407-2.6-.965-.954-2.43-1.75-4.443-1.75zM6.29%207.296a1.85%201.85%200%20002.534%202.36l-2.535-2.36zM8%204.85a.65.65%200%20100%201.3%201.85%201.85%200%20011.843%201.694.65.65%200%20101.296-.11A3.15%203.15%200%20008%204.85z%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cdiv%20style%3D%22margin%3A%20.6em%200%201.2em%22%3E%E8%AF%A5%E5%9B%BE%E7%89%87%E6%9C%89%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%BC%95%E8%B5%B7%E4%B8%8D%E9%80%82%3C%2Fdiv%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cbutton%20style%3D%22padding%3A%204px%201em%3B%20font-size%3A%201.1em%3B%20color%3A%20inherit%3B%20background%3A%20none%3B%20border%3A%201px%20solid%20rgba%28255%2C255%2C255%2C.5%29%3B%20border-radius%3A%209999px%3B%22%3E%E7%BB%A7%E7%BB%AD%E6%9F%A5%E7%9C%8B%3C%2Fbutton%3E%0A%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%20%20%20%20%3C%2FforeignObject%3E%3C%2Fsvg%3E);width:100%;height:194px;background:url(https://pic1.zhimg.com/v2-cf70d0759d787c70091857151c1cad4a.jpeg) no-repeat rgba(191,191,191,0.7);background-size:cover;cursor:pointer!important;}@-webkit-keyframes animation-1yvu044{from{opacity:0;}to{opacity:1;}}@keyframes animation-1yvu044{from{opacity:0;}to{opacity:1;}}</style><style data-emotion-css="1s3a4zw">.css-1s3a4zw{position:relative;display:inline-block;height:30px;padding:0 12px;font-size:14px;line-height:30px;color:#056DE8;vertical-align:top;border-radius:100px;background:rgba(5,109,232,0.1);}.css-1s3a4zw:hover{background-color:rgba(5,109,232,0.15);}</style><style data-emotion-css="1xlfegr">.css-1xlfegr{background:transparent;box-shadow:none;}</style><style data-emotion-css="1gomreu">.css-1gomreu{position:relative;display:inline-block;}</style><style data-emotion-css="1any501">.css-1any501{box-sizing:border-box;margin:0;min-width:0;max-width:100%;height:auto;background-color:#FFFFFF;width:40px;height:40px;border-radius:50%;}</style><style data-emotion="css"></style></head><body class="WhiteBg-body PostIndex-body" aria-basefontsize="16" data-rh="class"><a id="ariaTipText" role="pagedescription" aria-label="欢迎进入 深入浅出：如何正确使用 protobuf - 知乎,盲人用户使用操作智能引导，请按快捷键Ctrl+Alt+R；阅读详细操作说明请按快捷键Ctrl+Alt+问号键。" aria-atomic="true" href="javascript:void(0)" class="skipAutoFix" style="width: 1px; height: 1px;"><img src="https://zhuanlan.zhihu.com/p/406832315" style="width:1px !important;height:1px !important;position:absolute;top:0;"></a><div id="root"><div class="App"><div class="LoadingBar  css-uzm3ri"></div><div><span style="position:absolute;top:-10000px;left:-10000px" role="log" aria-live="assertive"></span></div><main role="main" class="App-main"><div class="Post-content" data-zop-usertoken="{&quot;userToken&quot;:&quot;hexu1985&quot;}" data-zop="{&quot;authorName&quot;:&quot;津的技术专栏&quot;,&quot;itemId&quot;:406832315,&quot;title&quot;:&quot;深入浅出：如何正确使用 protobuf&quot;,&quot;type&quot;:&quot;article&quot;}" data-za-detail-view-path-module="PostItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;token&quot;:&quot;406832315&quot;}}}"><div class="ColumnPageHeader-Wrapper"><div><div class="Sticky ColumnPageHeader is-fixed css-1l12z7y" style="width: 1905px; top: 0px; left: 0px;"><div class="ColumnPageHeader-content"><a href="https://www.zhihu.com/" aria-label="知乎"><svg viewBox="0 0 64 30" fill="#056DE8" width="64" height="30" class="css-1hlrcxk"><path d="M29.05 4.582H16.733V25.94h3.018l.403 2.572 4.081-2.572h4.815V4.582zm-5.207 18.69l-2.396 1.509-.235-1.508h-1.724V7.233h6.78v16.04h-2.425zM14.46 14.191H9.982c0-.471.033-.954.039-1.458v-5.5h5.106V5.935a1.352 1.352 0 0 0-.404-.957 1.378 1.378 0 0 0-.968-.396H5.783c.028-.088.056-.177.084-.255.274-.82 1.153-3.326 1.153-3.326a4.262 4.262 0 0 0-2.413.698c-.57.4-.912.682-1.371 1.946-.532 1.453-.997 2.856-1.31 3.693C1.444 8.674.28 11.025.28 11.025a5.85 5.85 0 0 0 2.52-.61c1.119-.593 1.679-1.502 2.054-2.883l.09-.3h2.334v5.5c0 .5-.045.982-.073 1.46h-4.12c-.71 0-1.39.278-1.893.775a2.638 2.638 0 0 0-.783 1.874h6.527a17.717 17.717 0 0 1-.778 3.649 16.796 16.796 0 0 1-3.012 5.273A33.104 33.104 0 0 1 0 28.74s3.13 1.175 5.425-.954c1.388-1.292 2.631-3.814 3.23-5.727a28.09 28.09 0 0 0 1.12-5.229h5.967v-1.37a1.254 1.254 0 0 0-.373-.899 1.279 1.279 0 0 0-.909-.37z"></path><path d="M11.27 19.675l-2.312 1.491 5.038 7.458a6.905 6.905 0 0 0 .672-2.218 3.15 3.15 0 0 0-.28-2.168l-3.118-4.563zM51.449 15.195V5.842c4.181-.205 7.988-.405 9.438-.483l.851-.05c.387-.399.885-2.395.689-3.021-.073-.25-.213-.666-.638-.555a33.279 33.279 0 0 1-4.277.727c-2.766.321-3.97.404-7.804.682-6.718.487-12.709.72-12.709.72a2.518 2.518 0 0 0 .788 1.834 2.567 2.567 0 0 0 1.883.706c2.278-.095 5.598-.25 8.996-.41v9.203h-12.78c0 .703.281 1.377.783 1.874a2.69 2.69 0 0 0 1.892.777h10.105v7.075c0 .887-.464 1.192-1.231 1.214h-3.92a4.15 4.15 0 0 0 .837 1.544 4.2 4.2 0 0 0 1.403 1.067 6.215 6.215 0 0 0 2.71.277c1.36-.066 2.967-.826 2.967-3.57v-7.607h11.28c.342 0 .67-.135.91-.374.242-.239.378-.563.378-.902v-1.375H51.449z"></path><path d="M42.614 8.873a2.304 2.304 0 0 0-1.508-.926 2.334 2.334 0 0 0-1.727.405l-.376.272 4.255 5.85 2.24-1.62-2.884-3.98zM57.35 8.68l-3.125 4.097 2.24 1.663 4.517-5.927-.375-.277a2.32 2.32 0 0 0-1.722-.452 2.327 2.327 0 0 0-1.536.896z"></path></svg></a><i class="ColumnPageHeader-Line"></i><div class="ColumnPageHeader-Title"><div class="ColumnPageHeader-TitleName"><span class="ColumnPageHeader-TitleMeta">首发于</span><a class="ColumnLink ColumnPageHeader-TitleColumn" href="https://www.zhihu.com/column/c_1417572457507713024">我和我的架构师</a></div></div><div class="ColumnPageHeader-Button"><div class="Popover"><button title="更多" id="Popover1-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover1-content" type="button" class="Button ColumnPageHeader-MenuToggler Button--plain"><svg width="24" height="24" viewBox="0 0 24 24" class="Zi Zi--Dots" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></button></div><button type="button" class="Button ColumnPageHeader-WriteButton Button--blue"><svg width="24" height="24" viewBox="0 0 24 24" class="Zi Zi--EditSurround" fill="currentColor"><path fill-rule="evenodd" d="M3.55 5.97a2.415 2.415 0 0 1 2.415-2.416h7.56a.75.75 0 0 1 0 1.5h-7.56a.915.915 0 0 0-.915.915v12.072c0 .505.41.915.915.915h12.074c.506 0 .915-.41.915-.915v-7.557a.75.75 0 0 1 1.5 0v7.557a2.415 2.415 0 0 1-2.415 2.415H5.965A2.415 2.415 0 0 1 3.55 18.04V5.969Z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M20.239 3.77a.75.75 0 0 1 0 1.06l-8.206 8.206a.75.75 0 0 1-1.06-1.06l8.205-8.206a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd"></path></svg>写文章</button></div></div><div class="ColumnPageHeader-profile"><div class="Popover AppHeader-menu"><button id="Popover4-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover4-content" type="button" class="Button AppHeader-profileEntry FEfUrdfMIKpQDJDqkjte Button--plain fEPKGkUK5jyc4fUuT0QP"><img class="Avatar AppHeader-profileAvatar css-1tzrnvf" src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg" srcset="https://pica.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=32738c0c 2x" alt="点击打开hexu1985的主页"></button></div><div class="Popover ddLajxN_Q0AuobBZjX9m AppHeaderProfileMenu-creatorHintPopover"><div class="AppHeaderProfileMenu-creatorHintToggler" id="Popover5-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover5-content"></div></div></div></div><div class="Sticky--holder" style="position: relative; inset: 0px; display: block; float: none; margin: 0px; height: 52px;"></div></div></div><div class="css-78p1r9"><div class="css-1stvxt9"><div class="css-1ld0bim"><img src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-b1c16e5a81bd4ae56aa6651d34f7a7be_720w.jpg" alt="深入浅出：如何正确使用 protobuf" width="100%" height="100%" class="css-1phd9a0" srcset="https://pic1.zhimg.com/v2-b1c16e5a81bd4ae56aa6651d34f7a7be_200x0.jpg?source=172ae18b 200w,https://pic1.zhimg.com/v2-b1c16e5a81bd4ae56aa6651d34f7a7be_qhd.jpg?source=172ae18b 480w,https://pic1.zhimg.com/v2-b1c16e5a81bd4ae56aa6651d34f7a7be_720w.jpg?source=172ae18b 720w,https://pic1.zhimg.com/v2-b1c16e5a81bd4ae56aa6651d34f7a7be_1440w.jpg?source=172ae18b 1440w" loading="lazy"></div></div></div><article class="Post-Main Post-NormalMain" tabindex="-1"><header class="Post-Header"><h1 class="Post-Title">深入浅出：如何正确使用 protobuf</h1><div class="Post-Author"><div class="AuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><div class="AuthorInfo"><meta itemprop="name" content="津的技术专栏"><meta itemprop="image" content="https://pica.zhimg.com/v2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b"><meta itemprop="url" content="https://www.zhihu.com/people/qing-feng-32-87-12"><meta itemprop="zhihu:followerCount"><span class="UserLink AuthorInfo-avatarWrapper"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/qing-feng-32-87-12" target="_blank" class="UserLink-link" data-za-detail-view-element_name="User"><img class="Avatar AuthorInfo-avatar css-1y9jkzv" src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-5555b2affad0a417b148c9e8977612f6_l.jpg" srcset="https://pica.zhimg.com/v2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b 2x" alt="津的技术专栏"></a></div></span><div class="AuthorInfo-content"><div class="AuthorInfo-head"><span class="UserLink AuthorInfo-name"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/qing-feng-32-87-12" target="_blank" class="UserLink-link" data-za-detail-view-element_name="User">津的技术专栏</a></div></span></div><div class="AuthorInfo-detail"><div class="AuthorInfo-badge"><div class="ztext AuthorInfo-badgeText css-0">编程开发、系统架构、开源软件等技术干货分享中 ~</div></div></div></div></div></div><button type="button" class="Button FollowButton Button--primary Button--blue"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Plus FollowButton-icon" fill="currentColor"><path fill-rule="evenodd" d="M13.25 3.25a1.25 1.25 0 1 0-2.5 0v7.5h-7.5a1.25 1.25 0 1 0 0 2.5h7.5v7.5a1.25 1.25 0 1 0 2.5 0v-7.5h7.5a1.25 1.25 0 0 0 0-2.5h-7.5v-7.5Z" clip-rule="evenodd"></path></svg></span>关注他</button></div><div class="LabelContainer-wrapper"></div><div role="button" tabindex="0"><span class="Voters"><button type="button" class="Button Button--plain">20 人<!-- -->赞同了该文章</button></span></div></header><div class="Post-RichTextContainer"><div class="css-1yuhvjn"><div class="css-376mun"><div class="RichText ztext Post-RichText css-1g0fqss" options="[object Object]"><h2 data-first-child="">目录导航</h2><ul><li data-pid="E-yPo0Jf">1 写在前面</li><li data-pid="z2cltjQc">2 初识 protobuf 语法</li><li data-pid="lkVxRmaS">3 基于 Protobuf 的编程示例</li><li data-pid="a39CDWhj">4 Protobuf 的数据类型</li><li data-pid="b35WdAJs">5 Protobuf 编码方法</li><ul><li data-pid="_MktiJSR">5.1 Varint</li><ul><li data-pid="9EWBj3Lm">5.1.1 Varint 是什么？</li><li data-pid="IqLPb13A">5.1.2 Tag 信息</li><li data-pid="QJnRo1fa">5.1.3 Data 信息</li></ul><li data-pid="pp_33rAC">5.2 ZigZag 编码</li><ul><li data-pid="bIg4ksiE">5.2.1 ZigZag 编码解决了什么问题？</li><li data-pid="0IR7an5X">5.2.2 ZigZag是怎么编码的？</li></ul><li data-pid="PEI6E88E">5.3 Length-delimited</li></ul><li data-pid="NA0Jom5q">6 如何正确使用每种类型</li><ul><li data-pid="My7eoVRs">6.1 int32/uint32/sint32/int64/uint64/sint64</li><li data-pid="qLuTJp2e">6.2 fixed32/sfixed32/fixed64/sfixed64</li><li data-pid="wwZlqMru">6.3 float/double</li><li data-pid="w3J9yoMu">6.4 string/bytes</li><li data-pid="zOxcgO30">6.5 repeated</li><li data-pid="ciLxfHkQ">6.6 embedding message</li><li data-pid="AszVgbL4">6.7 map</li><li data-pid="ubGY3ChF">6.8 any</li><li data-pid="MVR3Ou--">6.9 oneof</li></ul><li data-pid="-RoWDfUU">7 可选项 optimize_for</li><li data-pid="36ISi7Y0">8 附录</li><ul><li data-pid="iW6Axwff">8.1 补码编码</li></ul><li data-pid="rFl1DPYt">9 参考文献</li></ul><hr><p data-pid="3rL0VC8y"><b>1 写在前面</b></p><p data-pid="Rqr_O03V">本文适合 <code>Protobuf</code> 入门、进阶的开发者阅读，是一篇讲原理的文章，主要是介绍了如何正确使用 <code>Protobuf</code> 的特性，以比较大地发挥它的优势。阅读本文之后，开发者能够对Protobuf实现原理有深入的理解，在日常开发中能够熟练运用。</p><p data-pid="PUsLQ7Cg">本文基于 <code>Protobuf</code> 的 <code>3.17.3</code> 版本进行分析、<code>proto3</code> 的语法、编码示例使用 <code>C++</code> 语言实现。</p><h2><b>2 初识 protobuf 语法</b></h2><p data-pid="bIZfInf9"><code>Protobuf</code>  官方实现了一门语言，专门用来自定义数据结构。<code>protoc</code> 是这门语言的编译工具，可编译生成指定编程语言（如<code>C++</code>、<code>Java</code>、<code>Golang</code>、<code>Python</code>、<code>C#</code> 等）的源代码，然后开发者可以轻松在这些语言中使用该源代码进行编程。</p><p data-pid="DrJQlBKm">以下  <code>test.proto</code>  就是一个 <code>Protobuf</code> 语言的示例。</p><div class="highlight"><pre><code class="language-protobuf"><span class="c1">//选择  proto2 或者 proto3 的语法，这里指定了 proto3 的语法
</span><span class="c1"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span><span class="err">
</span><span class="err">​
</span><span class="err"></span><span class="c1">//包名，在 C++ 里表现为 namespace
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">mytest</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="c1">//option optimize_for = LITE_RUNTIME;
</span><span class="c1"></span><span class="err">​
</span><span class="err"></span><span class="c1">//依赖的其他 proto 源文件，
</span><span class="c1">//在依赖的数据类型在其他 proto 源文件中定义的情况下，
</span><span class="c1">//需要通过 import 导入其他 proto 源文件
</span><span class="c1"></span><span class="k">import</span> <span class="s">"google/protobuf/any.proto"</span><span class="p">;</span><span class="err">
</span><span class="err">​
</span><span class="err"></span><span class="c1">//message 是消息体，它就是一个结构体/类
</span><span class="c1"></span><span class="kd">message</span> <span class="nc">SubTest</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">int32</span>              <span class="n">i32</span>      <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">​
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Test</span> <span class="p">{</span><span class="err">
</span><span class="err"></span><span class="c1">//数据类型            字段          field-number (还是用英文原文好一点)
</span><span class="c1"></span>  <span class="kt">int32</span>              <span class="n">i32</span>      <span class="o">=</span>   <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int64</span>              <span class="n">i64</span>      <span class="o">=</span>   <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">uint32</span>             <span class="n">u32</span>      <span class="o">=</span>   <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">uint64</span>             <span class="n">u64</span>      <span class="o">=</span>   <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">sint32</span>             <span class="n">si32</span>     <span class="o">=</span>   <span class="mi">5</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">sint64</span>             <span class="n">si64</span>     <span class="o">=</span>   <span class="mi">6</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">fixed32</span>            <span class="n">fx32</span>     <span class="o">=</span>   <span class="mi">7</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">fixed64</span>            <span class="n">fx64</span>     <span class="o">=</span>   <span class="mi">8</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">sfixed32</span>           <span class="n">sfx32</span>    <span class="o">=</span>   <span class="mi">9</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">sfixed64</span>           <span class="n">sfx64</span>    <span class="o">=</span>   <span class="mi">10</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">bool</span>               <span class="n">bl</span>       <span class="o">=</span>   <span class="mi">11</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">float</span>              <span class="n">f32</span>      <span class="o">=</span>   <span class="mi">12</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">double</span>             <span class="n">d64</span>      <span class="o">=</span>   <span class="mi">13</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span>             <span class="n">str</span>      <span class="o">=</span>   <span class="mi">14</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">bytes</span>              <span class="n">bs</span>       <span class="o">=</span>   <span class="mi">15</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="k">repeated</span> <span class="kt">int32</span>     <span class="n">vec</span>      <span class="o">=</span>   <span class="mi">16</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="n">map</span><span class="p">&lt;</span><span class="kt">int32</span><span class="p">,</span> <span class="kt">int32</span><span class="p">&gt;</span>  <span class="n">mp</span>       <span class="o">=</span>   <span class="mi">17</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="n">SubTest</span>            <span class="n">test</span>     <span class="o">=</span>   <span class="mi">18</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="k">oneof</span> <span class="n">object</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="kt">float</span>            <span class="n">obj_f32</span>  <span class="o">=</span>   <span class="mi">19</span><span class="p">;</span><span class="err">
</span><span class="err"></span>    <span class="kt">string</span>           <span class="n">obj_str</span>  <span class="o">=</span>   <span class="mi">20</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span>  <span class="n">google.protobuf.Any</span> <span class="n">any</span>     <span class="o">=</span>   <span class="mi">21</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div><h2><b>3 基于 Protobuf 的编程示例</b></h2><p data-pid="lc2wLxpZ">这是一个基于 <code>C++</code> 语言编写的程序，由  <code>Makefile</code>、<code>test.cc</code>、<code>test.proto</code> 三个源代码文件组成。</p><div class="highlight"><pre><code class="language-bash">$ tree
.
├── Makefile
├── test.cc
└── test.proto</code></pre></div><p data-pid="6HIIGZ43">编写源文件 <code>test.cc</code></p><div class="highlight"><pre><code class="language-cpp"><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">"test.pb.h"</span><span class="cp">
</span><span class="cp"></span><span class="err">​</span>
<span class="c1">//输出十六进制编码
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="n">dump_hexstring</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">tag</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tag</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%02x "</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="Tvv5T-FS">编写源文件 <code>Makefile</code></p><div class="highlight"><pre><code class="language-make"><span class="nf">all</span><span class="o">:</span> <span class="n">test</span>
<span class="nf">test</span><span class="o">:</span> <span class="n">test</span>.<span class="n">pb</span>.<span class="n">o</span> <span class="n">test</span>.<span class="n">o</span>
  g++ -std<span class="o">=</span>c++11 -o <span class="nb">test</span> -lprotobuf $^
  <span class="c1">#g++ -std=c++11 -o test -lprotobuf-lite $^</span>
<span class="nf">%.o</span><span class="o">:</span> %.<span class="n">cc</span>
  g++ -std<span class="o">=</span>c++11 -c -o <span class="nv">$@</span> $&lt;
<span class="nf">proto</span><span class="o">:</span>
  <span class="c1"># 生成 C++ 源代码</span>
  protoc --cpp_out<span class="o">=</span>./ test.proto
<span class="nf">clean</span><span class="o">:</span>
  rm -f *.o <span class="nb">test</span> test.pb.*
<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">clean</span> <span class="n">proto</span>
</code></pre></div><p data-pid="fDlmjjJR">编译和执行</p><div class="highlight"><pre><code class="language-bash">$ make clean
rm -f *.o <span class="nb">test</span> test.pb.*
$ make proto
<span class="c1"># 生成 C++ 源代码</span>
protoc --cpp_out<span class="o">=</span>./ test.proto
$ tree
.
├── Makefile
├── test.cc
├── test.pb.cc  <span class="c1"># 由 test.proto 编译生成的源文件</span>
├── test.pb.h   <span class="c1"># 同上</span>
└── test.proto
​
$ make
g++ -std<span class="o">=</span>c++11 -c -o test.pb.o test.pb.cc
g++ -std<span class="o">=</span>c++11 -c -o test.o test.cc
g++ -std<span class="o">=</span>c++11 -o <span class="nb">test</span> -lprotobuf test.pb.o test.o
$ ./test
<span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">08</span> ac <span class="m">02</span>
​</code></pre></div><h2><b>4 Protobuf 的数据类型</b></h2><p data-pid="oxEPDL_k">以下是一个 <code>Protobuf</code> 数据类型和其他编程语言的数据类型的映射关系表。</p><table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><th>Protobuf Type</th><th>说明</th><th>C++ Type</th><th>Java Type</th><th>Python Type[2]</th><th>Go Type</th></tr><tr><td>float</td><td>固定4个字节</td><td>float</td><td>float</td><td>float</td><td>float32</td></tr><tr><td>double</td><td>固定8个字节</td><td>double</td><td>double</td><td>float</td><td>float64</td></tr><tr><td>int32</td><td>varint编码</td><td>int32</td><td>int</td><td>int</td><td>int32</td></tr><tr><td>uint32</td><td>varint编码</td><td>uint32</td><td>int</td><td>int/long</td><td>uint32</td></tr><tr><td>uint64</td><td>varint编码</td><td>uint64</td><td>long</td><td>int/long</td><td>uint64</td></tr><tr><td>sint32</td><td>zigzag 和 varint编码</td><td>int32</td><td>int</td><td>int</td><td>int32</td></tr><tr><td>sint64</td><td>zigzag 和 varint编码</td><td>int64</td><td>long</td><td>int/long</td><td>int64</td></tr><tr><td>fixed32</td><td>固定4个字节</td><td>uint32</td><td>int</td><td>int</td><td>uint32</td></tr><tr><td>fixed64</td><td>固定8个字节</td><td>uint64</td><td>long</td><td>int/long</td><td>uint64</td></tr><tr><td>sfixed32</td><td>固定4个字节</td><td>int32</td><td>int</td><td>int</td><td>int32</td></tr><tr><td>sfixed64</td><td>固定8个字节</td><td>int64</td><td>long</td><td>int/long</td><td>int64</td></tr><tr><td>bool</td><td>固定一个字节</td><td>bool</td><td>boolean</td><td>bool</td><td>bool</td></tr><tr><td>string</td><td>Lenth-Delimited</td><td>uint64</td><td>String</td><td>str/unicode</td><td>string</td></tr><tr><td>bytes</td><td>Lenth-Delimited</td><td>string</td><td>ByteString</td><td>str</td><td>[]byte</td></tr><tr><td>bytes</td><td>Lenth-Delimited</td><td>string</td><td>ByteString</td><td>str</td><td>[]byte</td></tr></tbody></table><blockquote data-pid="SbhGhNfw">⚡ 注：这里读者先有个大概的印象，后面会详细介绍每个数据类型。</blockquote><h2><b>5 Protobuf 编码方法</b></h2><p data-pid="N4w9zWWy">在详细介绍 <code>Protobuf</code> 的数据类型之前，这里先了解一下 <code>Protobuf</code> 的编码，在后面介绍每个数据类型的时候会用到这些知识点。</p><table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><th>wire-type</th><th>名称</th><th>说明</th><th>类型</th></tr><tr><td>0</td><td>Varint</td><td>可变长整形</td><td>非ZigZag编码类型：int32, uint32, int64, uint64, bool, enum；<br>ZigZag编码类型：sint32, sint64</td></tr><tr><td>1</td><td>64-bits</td><td>固定8个字节大小</td><td>fixed64, sfixed64, double</td></tr><tr><td>2</td><td>Length-delimited</td><td>Length + Body方式</td><td>string, bytes, embedding message, packed repeated fields</td></tr><tr><td>5</td><td>32-bits</td><td>固定4个字节大小</td><td>fixed32, sfixed32, float</td></tr></tbody></table><blockquote data-pid="SPulhCha">⚡ 注意：wire_type 为 3、4 的编码类型官方已经弃用，所以这里也不在介绍。</blockquote><h2><b>5.1 Varint</b></h2><h3><b>5.1.1 Varint 是什么？</b></h3><p data-pid="hv5kL6F6"><code>Varint</code>  编码是一种可变长的编码方式，值越小的数字，使用越少的字节数表示。它的原理是通过减少表示数字的字节数从而实现数据体积压缩。</p><p data-pid="boN_2bAF">首先，先理解几个概念，因为后面需要用到这些概念：</p><ul><li data-pid="hyvqnDIz"><b>field-number</b>：如以下 <code>message</code> 中的最后一列的数字；</li><li data-pid="d0i5K-zt"><b>wire-type</b>：编码类型，比如 <code>Varint</code> 的编码类型为 0；</li><li data-pid="HaOMU8zS"><b>msb</b>：全称 <code>most significant bit</code>，指的是每个字节的最高位 （例如：<code>0x80</code> 的 二进制是 <code>10000000</code>，其最高位是 1，即 msb 为 1）。</li></ul><p data-pid="fW7afuZ3">然后，我们看 <code>Varint</code> 是怎样编码的，先了解一下 <code>Tag信息</code> 和 <code>Data信息</code>：</p><ul><li data-pid="J-4vth8S"><b>Tag 信息</b>：主要存储 <code>field-number</code> 和 <code>wire-type</code>；</li><li data-pid="VdsXrS8A"><b>Data 信息</b>：编码后的序列。</li></ul><blockquote data-pid="RxvgPKFz">Varint 编码序列 = Tag信息  + Data信息。</blockquote><h3><b>5.1.2 Tag 信息</b></h3><p data-pid="Cu61oH6U">使用一个字节来表示 Tag 信息，高 5 位表示 <code>field-number</code>，低 3 位表示 <code>wire-type</code>。</p><div class="highlight"><pre><code class="language-text"> [7] [6] [5] [4] [3] [2]  [1]  [0]
|&lt;----- field -----&gt;|&lt;-- wire --&gt;|
        number           type </code></pre></div><blockquote data-pid="zVjtQus6">注：这个使用一个字节并非编码后的一个字节，而是编码前的一个字节，编码后可能是两个字节。为什么呢？因为 计算好 Tag 之后，还要经过 Varint 编码才是最终的编码，即  Tag = VarintEncode( field-number &lt;&lt; 3 | wire_type)。</blockquote><h3><b>5.1.3 Data 信息</b></h3><p data-pid="mPUWIv-V">在 <code>C++</code> 中，<code>int</code> 类型的编码是固定的，无论数值大小，都使用固定 <code>4</code> 个字节来存储。假如数值为 <code>1</code>，二进制为 <code>00000000 00000000 00000000 00000001</code>，其实有效值只有最后一个字节 <code>00000001</code>，前三个字节是<b>浪费</b>的。</p><p data-pid="vqBc5m35">如果使用 <code>length</code> + <code>body</code> 的方式编码呢？</p><ul><li data-pid="2iCuRESM"><code>length</code> 能不能和 <code>Tag</code> 公用一个字节？整形最大 <code>8</code> 个字节，二进制 <code>1000</code>，所以需要占用 <code>4</code> 位，<code>wire-type</code>不能再压缩了，<code>field-number</code> 压缩之后只剩下 <code>1 bit （5 - 4  = 1）</code>，这限制了 <code>message</code> 中的字段数量，此方案不可行；</li><li data-pid="64mEGa11">使用单独字段表示length，那么编码之后为 <code>00000001 00000001</code>，第一个<code>00000001</code> 为 <code>length</code>，第二个为值，加上 <code>Tag</code> 一个字节，总共 <code>3</code> 个字节。</li></ul><p data-pid="7pnVIJs2">但是，<code>Varint</code> 编码可以做到总共可以只用 <code>2</code> 个字节来表示值  <code>1</code>。这是怎么做到的？</p><blockquote data-pid="LE1aNOdG">注：Varint的每个字节只有低7位存储数据，最高位（即msb）作为标志位，0 代表后面没有再跟字节了，1 代表后面的字节还是属于当前字段的，可以继续读一个字节，以此类推 ……。</blockquote><p data-pid="mJXpgmyr"><code>1</code> 的 <code>Varint</code> 编码的 <code>data</code> 为 <code>00000001</code>，即<code>0（msb） + 0000001</code>（低 <code>7</code> 位）。</p><p data-pid="poIn2Vq6">下面详细分析该编码。</p><p data-pid="uCkpCM3z">在 「基于 Protobuf 的编程示例」一节的示例中，<code>int32</code> 类型的 <code>i32</code> 字段（<code>field-number</code> 为 <code>1</code>），其值为 <code>300</code> 的时候，编码结果为 <code>08 ac 02</code>，怎么得来的？</p><div class="highlight"><pre><code class="language-text">比如这个int32类型字段的值为300，那么序列化之后：
08 ac 02
 |  |__|___ 值
 |_________ 元数据 (field-number &lt;&lt; 3 | wire-type) = (1 &lt;&lt; 3 | 0) = 0x08
​
ac 02 是怎么得来的？
​
i32的值为 300
|__ 0x012c             //十六进制
|__ 00000001 00101100  //二进制
|__ 0000000100101100   //合并
|__ 00 0000010 0101100 //重新按7位一组切割
|__ 0000010 0101100    //高位全0的组省略
|__ 0101100 0000010    //逆序，因为使用小端字节序，
|__ 10101100 00000010  //每一组加上msb，除了最后一组是msb是0，其他的都为1
|__ ac 02               //十六进制</code></pre></div><blockquote data-pid="hRldp8ws">⚡  注：<br>计算机硬件有两种储存数据的方式：大端字节序（big endian）和小端字节序（little endian）。<br>举例来说，数值<code>0x2211</code>使用两个字节储存：高位字节是<code>0x22</code>，低位字节是<code>0x11</code>。<br>大端字节序：高位字节在前，低位字节在后，这是人类读写数值的方法，即以<code>0x2211</code>形式存储；<br>小端字节序：低位字节在前，高位字节在后，即以<code>0x1122</code>形式储存。</blockquote><h2><b>5.2 ZigZag 编码</b></h2><h3><b>5.2.1 ZigZag 编码解决了什么问题？</b></h3><p data-pid="lvTwWuF4"><b>先看下背景</b>。假如 <code>int32</code> 类型的字段，其值为 <code>-1</code> 时，在内存中，因为使用了补码，所以存储为 <code>ffffffff</code>（4个字节），然后在 <code>Varint</code> 序列化的之前会强制转换成 <code>int64</code> 类型，这样其值会变为<code>ffffffff ffffffff</code>。转换成 <code>Varint</code> 编码时，会加上 <code>Tag</code> ，以及 <code>msb</code> ，总共是 <code>10</code> 个字节。我们希望其绝对值越小，编码之后使用越少的字节数表示，显然这里编码之后得到的结果和我们期望的结果相悖的，基于这样的原因，才引入了 <code>ZigZag</code> 编码，主要作用是对负数的压缩处理。</p><h3><b>5.2.2 ZigZag是怎么编码的？</b></h3><p data-pid="fBaxFlkh">很简单，两个公式就搞定了，没有复杂的编码转换。</p><div class="highlight"><pre><code class="language-cpp"><span class="n">zigzag32</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span>  <span class="c1">//对于 sint32
</span><span class="c1"></span><span class="n">zigzag64</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">63</span><span class="p">)</span>  <span class="c1">//对于 sint64
</span></code></pre></div><p data-pid="Q6gUQwKY">一般情况下我们认为，使用较多的是小整数（确切地说应该是绝对值小的整数），那么较小的整数应使用更少的字节数来编码，<code>ZigZag</code> 编码正是如此，如下表格：</p><table data-draft-node="block" data-draft-type="table" data-size="normal" data-row-style="normal"><tbody><tr><th>n</th><th>十六进制</th><th>zigzag(n)</th><th>varint(zigzag(n))</th></tr><tr><td>0</td><td>00 00 00 00</td><td>00 00 00 00</td><td>00</td></tr><tr><td>-1</td><td>ff ff ff ff</td><td>00 00 00 01</td><td>01</td></tr><tr><td>1</td><td>00 00 00 01</td><td>00 00 00 02</td><td>02</td></tr><tr><td>-2</td><td>ff ff ff fe</td><td>00 00 00 03</td><td>03</td></tr><tr><td>2</td><td>00 00 00 02</td><td>00 00 00 04</td><td>04</td></tr><tr><td>...</td><td>...</td><td>...</td><td>...</td></tr><tr><td>2147483647</td><td>7f ff ff ff</td><td>ff ff ff fe</td><td>ff ff ff fe</td></tr><tr><td>-2147483648</td><td>80 00 00 00</td><td>ff ff ff ff</td><td>ff ff ff ff</td></tr></tbody></table><h2><b>5.3 Length-delimited</b></h2><p data-pid="UcywhwAU">这种编码很容易理解，就是 <code>length + body</code> 的方式，使用一个 <code>Varint</code> 类型表示 <code>length</code>，然后 <code>length</code> 的后面接着 <code>length</code> 个字节的内容。</p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message {
</span><span class="cm"> *   string str = 14;
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_str</span><span class="p">(</span><span class="s">"string"</span><span class="p">);</span> <span class="c1">//field_number = 14, wire_type = 5 (varint)
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="U_ZDAJAH">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">72</span> <span class="m">06</span> <span class="m">73</span> <span class="m">74</span> <span class="m">72</span> <span class="m">69</span> 6e <span class="m">67</span>
​</code></pre></div><p data-pid="eKW408RR">分析结果：</p><div class="highlight"><pre><code class="language-text">72 06 73 74 72 69 6e 67
|  |  s  t  r  i  n  g
|  |  |__|__|__|__|__|__ body 的 ASCII 码
|  |__ length = 6 = 0x06
|__ Tag (field-number &lt;&lt; 3 | wire-type) = (14 &lt;&lt; 3 | 5) = 114 = 0x72</code></pre></div><h2><b>6 如何正确使用每种类型</b></h2><h2><b>6.1 int32/uint32/sint32/int64/uint64/sint64</b></h2><p data-pid="D56vUEHV"><b>测试 - 1</b></p><div class="highlight"><pre><code class="language-cpp"><span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//field_number = 1, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_i64</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>  <span class="c1">//field_number = 2, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_u32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//field_number = 3, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_u64</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>  <span class="c1">//field_number = 4, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_si32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//field_number = 5, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_si64</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//field_number = 6, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="9pDx6tw3">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">08</span> <span class="m">01</span> <span class="m">10</span> <span class="m">02</span> <span class="m">18</span> <span class="m">01</span> <span class="m">20</span> <span class="m">02</span> <span class="m">28</span> <span class="m">02</span> <span class="m">30</span> <span class="m">04</span>
​</code></pre></div><p data-pid="hgqVGC7C">分析结果：</p><div class="highlight"><pre><code class="language-text">08 01  |__ i32
10 02  |__ i64
18 01  |__ u32
20 02  |__ u64
28 02  |__ si32
30 04  |__ si64</code></pre></div><p data-pid="Qhen-ZhB"><b>测试 - 2</b></p><div class="highlight"><pre><code class="language-cpp"><span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_i32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//field_number = 1, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>  <span class="c1">//field_number = 2, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_u32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//field_number = 3, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_u64</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>  <span class="c1">//field_number = 4, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_si32</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//field_number = 5, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_si64</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//field_number = 6, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="nmNFttcS">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">08</span> ff ff ff ff ff ff ff ff ff <span class="m">01</span> <span class="m">10</span> fe ff ff ff ff ff ff ff ff <span class="m">01</span> <span class="m">18</span> ff ff ff ff 0f <span class="m">20</span> fe ff ff ff ff ff ff ff ff <span class="m">01</span> <span class="m">28</span> <span class="m">01</span> <span class="m">30</span> <span class="m">03</span>
​</code></pre></div><p data-pid="ujmTmAsH">分析结果：</p><div class="highlight"><pre><code class="language-text">08 ff ff ff ff ff ff ff ff ff 01  |___ i32
10 fe ff ff ff ff ff ff ff ff 01  |___ i64
18 ff ff ff ff 0f                 |___ u32
20 fe ff ff ff ff ff ff ff ff 01  |___ u64
28 01                             |___ si32
30 03                             |___ si64</code></pre></div><p data-pid="uVpRrTRG"><b>如何选型？</b></p><p data-pid="tMj5oUZq">从编码步骤来看：</p><ul><li data-pid="JLUbs-k5"><code>int32/uint32/int64/uint64</code>：直接进行 <code>Varint</code> 编码；</li><li data-pid="kp_Ls9tN"><code>sint32/sint64</code>：先进行 <code>ZigZag</code> 编号，然后再对前者结果进行 <code>Varint</code> 编码，多了一个步骤。</li></ul><p data-pid="pHqKfUTT">从编码结果字节数来看：</p><ul><li data-pid="FPNin88Z"><code>int32/int64</code>：横向比较 <code>int32</code> 和 <code>int64</code> 编码结果一样，但是 <code>int64</code> 能够表示更大的数；</li><li data-pid="PnLarWYm"><code>uint32/uint64</code>：横向比较 <code>uint32</code> 和 <code>uint64</code> 编码结果一样，但是 <code>uint64</code> 能够表示更大的数；</li><li data-pid="qoH_H2a9"><code>sint32/sint64</code>：横向比较 <code>sint32</code> 和 <code>sint64</code> 编码结果一样，但是 <code>sint64</code> 能够表示更大的数；</li><li data-pid="dHlV-epe">纵向比较：正数的时候，编码都一样，反而 <code>sint32</code> 和 <code>sint64</code> 多了一个步骤（<code>ZigZag</code>编码），但是负数的情况 <code>sint32</code> 和 <code>sint64</code> 使用的字节数较少。</li></ul><p data-pid="sG_qu7kQ">综上所述，这样选型：</p><ul><li data-pid="pbcZfS41">如果确定是正数：<br></li><ul><li data-pid="ydr82aqb">如果数值确定小于等于 <code>UINT32_MAX</code>，可以用 <code>uint32</code>；</li><li data-pid="Q-TN-YCT">如果数值可能大于 <code>UINT32_MAX</code>，则可以用 <code>uint64</code>；</li><li data-pid="lyU8QxQL">虽然序列化后结果一样，但是考虑到前者可能在内存分配上会少一点，这里说“可能”，是因为还和内存对齐有关系）。</li></ul><li data-pid="Sl0oVREv">如果可能是负数，其ZigZag编码之后确定是正数：<br></li><ul><li data-pid="uwDtckkf">如果ZigZag编码后的值确定小于等于 <code>INT32_MAX</code> 且大于等于 <code>INT32_MIN</code>，可以用 <code>sint32</code>；</li><li data-pid="7dpslEcY">如果ZigZag编码后的值确定可能大于 <code>INT32_MAX</code> 或者 <code>小于 INT32_MIN</code>，则用 <code>sint64</code>；</li><li data-pid="070Aucze">虽然序列化后结果一样，但是考虑到前者可能在内存分配上会少一点，这里说“可能”，是因为还和内存对齐有关系）。</li></ul></ul><blockquote data-pid="l1eGSsDI">⚡ 注：到这里，如果是对 <code>Protobuf</code> 比较了解的读者，可能已经发现，以上少考虑了一种情况。因为 <code>Varint</code> 编码后的每个字节只有低 <code>7</code> 位表示 数据（最高位是 <code>msb</code>），那样的话，<code>4</code> 个字节能够表示的最大数为 <code>2^28 - 1</code>（不考虑符号），<code>8</code> 个字节能够表示的最大数为 <code>2^56 - 1</code>（不考虑符号）。<br><code>C++</code> 中的 <code>uint32_t</code>  可以表示的最大数为  <code>2^32-1</code>，<code>uint64_t</code> 可以表示的最大数为 <code>2^64 - 1</code>，那岂不是说在值 大于 <code>2^28 - 1</code> 或者 <code>2^56 - 1</code> 的情况下，其 <code>Protobuf</code> 编码后字节数还比对应的 <code>C++</code> 类型的字节数还多了？<br>在 「6.2 fixed32/sfixed32/fixed64/sfixed64」中就提供了解决方案。</blockquote><h2><b>6.2 fixed32/sfixed32/fixed64/sfixed64</b></h2><p data-pid="q88bbDxq"><code>fixed32/fixed64</code> 分别对应 <code>C++</code> 类型的 <code>uint32_t</code> 和 <code>uint64_t</code>，<code>sfixed32/sfixed64</code> 分别对应 <code>C++</code> 类型的 <code>int32_t</code> 和 <code>int64_t</code>。没有经过任何编码，分别使用固定的 <code>4</code> 个字节 和 <code>8</code> 个字节表示该值。</p><p data-pid="HWR7faqQ"><code>sfixed32/sfixed64</code> 也是分别使用了固定 <code>4</code> 个字节 和 <code>8</code> 个字节表示该值，只不过先经过 <code>ZigZag</code> 编码然后再存储。</p><p data-pid="Ol2g1H4P">综上所述，可以这样选型：</p><ul><li data-pid="o0xymBAA">如果确定是正数：</li><ul><li data-pid="Smbcp86O">如果数值确定小于等于 <code>UINT32_MAX</code> 且大于 <code>2^28-1</code>，可以用 <code>fixed32</code>（比如：这是一个表示时间戳的字段）；</li><li data-pid="JsUBXpIZ">如果数值确定可能大于 <code>2^56-1</code>，则可以用 <code>fixed64</code>（比如纯数字订单号：<code>2021083011405200001</code>，<code>20210830</code>（日期）+<code>114052</code>（时间）+ <code>00001</code>（<code>5</code> 位系列号））</li></ul><li data-pid="kKpKsyPN">如果可能是负数，其 <code>ZigZag</code> 编码后确定是正数：</li><ul><li data-pid="JgWRJhh4">如果 <code>ZigZag</code> 编码后的值确定小于等于 <code>INT32_MAX</code> 且大于 <code>2^28-1</code>，可以用 <code>sfixed32</code>；</li><li data-pid="CODua6bT">如果 <code>ZigZag</code> 编码后的值确定可能大于 <code>2^56-1</code>，则可以用 <code>sfixed64</code>。</li></ul></ul><h2><b>6.3 float/double</b></h2><p data-pid="yAat-hAy"><code>float</code> 是使用固定 <code>4</code> 个字节来表示浮点数，<code>double</code> 是使用固定 <code>8</code> 个字节来表示浮点数。</p><p data-pid="ImWsfOOf">有时候我们可以灵活一点，不一定需要用浮点数的类型类表示浮点数，比如有这样一个需求：使用一个字段来表示分数，满分一分，有效值扩展到小数点后 <code>2</code> 位小数（如：<code>99.98</code>分），如果使用 <code>float</code> 编码结果为 <code>5</code> 个字节（<code>Tag</code> <code>1</code>个字节 + 固定 <code>4</code> 个字节）。</p><p data-pid="YStpraKw">我们换一种思路，把分数转换成整型（如：<code>9998</code>），选型为 <code>int32</code>，那么使用的是 <code>Varint</code> 编码，最后的结果只需 <code>3</code> 个字节。</p><p data-pid="GkVhR6jt"><b>测试-1</b></p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message Test {
</span><span class="cm"> *   int32 i32 = 1;
</span><span class="cm"> *   float fl  = 12;
</span><span class="cm"> * }
</span><span class="cm"> * */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">9998</span><span class="p">);</span>     <span class="c1">//field_number = 1, wire_type = 0 (varint)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">set_fl</span><span class="p">(</span><span class="mf">99.98</span><span class="p">);</span>     <span class="c1">//field_number = 12, wire_type = 5 (float)
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="ZD_waLtN">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">08</span> 8e 4e <span class="m">65</span> c3 f5 c7 <span class="m">42</span>
​</code></pre></div><p data-pid="gSbTv333">分析结果：</p><div class="highlight"><pre><code class="language-text">08 8e 4e        |__ i32
65 c3 f5 c7 42  |__ fl</code></pre></div><p data-pid="lH3POCSQ"><code>double</code> 也是按同样的思路分析，这里就不再细抠图。</p><h2><b>6.4 string/bytes</b></h2><p data-pid="arLx-0Zy"><code>string</code> 和 <code>bytes</code> 都是字符串，使用了 <code>Length-delimited</code> 的编码方式，见「5.3 Length-delimited」。但是string会做 字符串编码检查，仅支持<code>UTF-8</code>编码或者<code>7-bit ASCII</code>编码的文本，而 <code>bytes</code> 可以是任意字符串。</p><h2><b>6.5 repeated</b></h2><p data-pid="60FLWZp_"><code>repeated</code> 顾名思义，是重复这个字段，其主要是补充数组功能这块的空白，类似于 <code>C++</code> 语言中的 <code>vector</code>。</p><p data-pid="giUYqyT8"><code>repeated</code> 使用了 <code>Length-delimited</code> 的编码方式，见「5.3 Length-delimited」。先看一下它的序列化模型：</p><div class="highlight"><pre><code class="language-bash"><span class="o">[</span>Tag<span class="o">]</span> <span class="o">[</span>Length<span class="o">]</span> <span class="o">[</span>Data-1<span class="o">][</span>Data-2<span class="o">][</span>Data-3<span class="o">]</span>...<span class="o">[</span>Data-n<span class="o">]</span></code></pre></div><p data-pid="XTccNrpy"><b>测试 - 1</b></p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message Test {
</span><span class="cm"> *   repeated int32 vec = 16;
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">add_vec</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//field_number = 16, wire_type = 2 (Length-Delimited)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">add_vec</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>  <span class="c1">//field_number = 16, wire_type = 2 (Length-Delimited)
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="suQP_czQ">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">82</span> <span class="m">01</span> <span class="m">02</span> <span class="m">01</span> <span class="m">02</span>
​</code></pre></div><p data-pid="Vf9BNsd8">分析结果：</p><div class="highlight"><pre><code class="language-text">82 01  |__ Tag
02     |__ Length
01 02  |__ 值 1 和 2</code></pre></div><p data-pid="HK-o2hlT"><b>测试 - 2</b></p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message Test {
</span><span class="cm"> *   repeated SubTest vec = 16;
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">add_vec</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//field_number = 16, wire_type = 2 (Length-Delimited)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">add_vec</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="c1">//field_number = 16, wire_type = 2 (Length-Delimited)
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="27iI12V2">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">82</span> <span class="m">01</span> <span class="m">02</span> <span class="m">08</span> <span class="m">01</span> <span class="m">82</span> <span class="m">01</span> <span class="m">02</span> <span class="m">08</span> <span class="m">02</span>
​</code></pre></div><p data-pid="1u9F32zh">分析结果：</p><div class="highlight"><pre><code class="language-text">82 01 02 08 01 //vec[0]
82 01  |__ Tag
02     |__ Length
08 01  |__ Subtest值, 08-&gt; Tag, 01 -&gt; 值
​
82 01 02 08 02 //vec[1]
82 01  |__ Tag
02     |__ Length
08 02  |__ Subtest值, 08-&gt; Tag, 02 -&gt; 值</code></pre></div><p data-pid="WBwba9h1">这里笔者觉得很怪，为什么每个 <code>repeated item</code> 都要重复 <code>Tag</code> 和 <code>Length</code> 呢，这不是会增加无畏的字节码？</p><blockquote data-pid="yku0yMAv">❓ 问题：不应该是这种方式编码后体积更小吗？为什么不用这种方法呢？</blockquote><div class="highlight"><pre><code class="language-text">82 01 02 08 01 08 02
82 01  |__ Tag
02     |__ Length
08 01  |__ vec[0] SubTest值, 08 -&gt; Tag, 01 -&gt; 值
08 02  |__ vec[1] SubTest值, 08 -&gt; Tag, 02 -&gt; 值</code></pre></div><p data-pid="f3VB23MN">这是因为如果 <code>repeated</code> 类型是基础类型（比如 <code>Varint</code>） 时，会做 <code>packed</code> 优化（也就是压缩）。</p><p data-pid="d-i2hypr"><b>综上所述</b>：</p><p data-pid="FXSyQjqs">如果不是很必要，<code>repeated</code> 不要使用复杂的类型，就使用 <code>Varint</code> 的类型就可以了。</p><p data-pid="3y1ZE_T8">比如有这样一个需求，需要存储一个列表，列表的 <code>item</code> 包含两个字段，一个是 <code>appid</code>，一个是整形的 <code>score</code>。那么不建议使用这种：</p><div class="highlight"><pre><code class="language-protobuf"><span class="kd">message</span> <span class="nc">Item</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">int64</span> <span class="n">appid</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">int64</span> <span class="n">score</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Test</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">repeated</span> <span class="n">Item</span> <span class="n">vec</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div><p data-pid="tjXS6NBj">可以使用下面这种（这种序列化知乎包体会小很多，<code>vec size</code> 越大，小得越明显）：</p><div class="highlight"><pre><code class="language-protobuf"><span class="kd">message</span> <span class="nc">Test</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">repeated</span> <span class="kt">int64</span> <span class="n">vec_appid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="k">repeated</span> <span class="kt">int64</span> <span class="n">vec_score</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div><h2><b>6.6 embedding message</b></h2><p data-pid="iFiTeRT8"><code>embedding message</code>，也就是 <code>message</code> 中某个字段的类型是一个 <code>message</code> 的类型，使用了 <code>Length-delimited</code> 编码方式。</p><p data-pid="97YXsIXO"><b>测试 - 1</b></p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message SubTest {
</span><span class="cm"> *   int32 i32 = 1;
</span><span class="cm"> * }
</span><span class="cm"> * message Test {
</span><span class="cm"> *   SubTest test = 18; //embedding message
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="c1">//field_number = 18, wire_type = 2 (Length-delimited)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">mutable_test</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="PsR8bZwB">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
<span class="m">92</span> <span class="m">01</span> <span class="m">02</span> <span class="m">08</span> <span class="m">01</span>
​</code></pre></div><p data-pid="K8kbfHJb">分析结果：</p><div class="highlight"><pre><code class="language-text">92 01   |__ Tag
02      |__ Length
08 01   |__ Data, SubTest值, 08 -&gt; Tag, 01 -&gt; 值</code></pre></div><h2><b>6.7 map</b></h2><p data-pid="TmAtU1TE"><code>map</code> 的底层实现是哈希表。类似 <code>C++</code> 语言中的 <code>unordered_map</code>。</p><p data-pid="NusIYpjI"><code>map</code> 使用了  <code>Length-delimited</code> 编码方式。</p><p data-pid="fE94KwBV"><b>测试-1</b></p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message Test {
</span><span class="cm"> *   map&lt;int32, int32&gt;  mp = 17;
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="c1">//field_number = 17, wire_type = 2 (Length-Delimited)
</span><span class="c1"></span>  <span class="n">t1</span><span class="p">.</span><span class="n">mutable_mp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">});</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">mutable_mp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">({</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">});</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">mutable_mp</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span> <span class="mi">12</span><span class="p">});</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p data-pid="YPi30Zrh">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
8a <span class="m">01</span> <span class="m">04</span> <span class="m">08</span> <span class="m">01</span> <span class="m">10</span> 0a 8a <span class="m">01</span> <span class="m">04</span> <span class="m">08</span> <span class="m">02</span> <span class="m">10</span> 0b 8a <span class="m">01</span> <span class="m">04</span> <span class="m">08</span> <span class="m">03</span> <span class="m">10</span> 0c
​</code></pre></div><p data-pid="MZofSf_x">分析结果：</p><div class="highlight"><pre><code class="language-text"> 8a 01  04 08 01 10 0a  |__ Key-Value-Group[0]
 |__|   |  |__|  |__|______ Value (10-&gt; Tag ①, 0a -&gt; 值)
    |   |     |____________ Key   (08-&gt; Tag ②, 01 -&gt; 值)
    |   |__________________ Length
    |______________________ Tag
    
    ①：10 = 2 &lt;&lt; 3 | 0 = 16 = 0x10 
       (map的value field-number 固定为 2)
    ②：08 = 1 &lt;&lt; 3 | 0 = 8 = 0x08 
       (map的Key field-number 固定为 1)
 
 8a 01  04 08 02 10 0b  |__ Key-Value-Group[1]
 8a 01  04 08 03 10 0c  |__ Key-Value-Group[2]</code></pre></div><blockquote data-pid="ksjBdWqC">⚠️  注：值得注意的是每一组 <code>key-value</code> 都会带上  <code>8a 01</code>  这个 <code>Tag</code>，以及  <code>04</code>  这个 <code>Length</code>。</blockquote><h2><b>6.8 any</b></h2><blockquote data-pid="DL3ZPLmN">源文件：<code>include/google/protobuf/any.proto</code></blockquote><div class="highlight"><pre><code class="language-protobuf"><span class="n">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span><span class="err">
</span><span class="err">​
</span><span class="err"></span><span class="kn">package</span> <span class="nn">google</span><span class="o">.</span><span class="n">protobuf</span><span class="p">;</span><span class="err">
</span><span class="err">​
</span><span class="err"></span><span class="k">option</span> <span class="n">csharp_namespace</span> <span class="o">=</span> <span class="s">"Google.Protobuf.WellKnownTypes"</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">go_package</span> <span class="o">=</span> <span class="s">"google.golang.org/protobuf/types/known/anypb"</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">java_package</span> <span class="o">=</span> <span class="s">"com.google.protobuf"</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">java_outer_classname</span> <span class="o">=</span> <span class="s">"AnyProto"</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">java_multiple_files</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">objc_class_prefix</span> <span class="o">=</span> <span class="s">"GPB"</span><span class="p">;</span><span class="err">
</span><span class="err">​
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Any</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">type_url</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="kt">bytes</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div><p data-pid="a6GW5FPk">去掉注释之后，也就一个 <code>message</code>，<code>type_url</code> 用来存储类型描述信息，<code>value</code> 用来存储序列化（ <code>C++</code> 是<code>SerializeToString</code> 函数）之后的字符串。</p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message SubTest {
</span><span class="cm"> *   int32 i32 = 1;
</span><span class="cm"> * }
</span><span class="cm"> * message Test {
</span><span class="cm"> *   google.protobuf.Any any = 21;
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">SubTest</span> <span class="n">st1</span><span class="p">;</span>
  <span class="n">st1</span><span class="p">.</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">mutable_any</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">PackFrom</span><span class="p">(</span><span class="n">st1</span><span class="p">);</span>  <span class="c1">//field_number = 21, wire_type = 2 (Lenth-Delimited)
</span><span class="c1"></span>  <span class="c1">//std::cout &lt;&lt; t1.any().type_url() &lt;&lt; std::endl;
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="gU7yXxJg">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash"><span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
aa <span class="m">01</span> <span class="m">28</span> 0a <span class="m">22</span> <span class="m">74</span> <span class="m">79</span> <span class="m">70</span> <span class="m">65</span> 2e <span class="m">67</span> 6f 6f <span class="m">67</span> 6c <span class="m">65</span> <span class="m">61</span> <span class="m">70</span> <span class="m">69</span> <span class="m">73</span> 2e <span class="m">63</span> 6f 6d 2f 6d <span class="m">79</span> <span class="m">74</span> <span class="m">65</span> <span class="m">73</span> <span class="m">74</span> 2e <span class="m">53</span> <span class="m">75</span> <span class="m">62</span> <span class="m">54</span> <span class="m">65</span> <span class="m">73</span> <span class="m">74</span> <span class="m">12</span> <span class="m">02</span> <span class="m">08</span> <span class="m">01</span>
​</code></pre></div><p data-pid="vhgSTvHs">分析结果：</p><div class="highlight"><pre><code class="language-text">aa 01           |__ Tag
28              |__ Length (40个字符)
0a 22 74 79 70 65 2e 67 6f 6f 67 6c 65 61 70 69 73 2e 63 6f 6d 2f 6d 79 74 65 73 74 2e 53 75 62 54 65 73 74  |__ 第一个字段（string type_url）
12 02 08 01     |__ 第二个字段（bytes value = 2）
​
第一个字段（string type_url）：
0a              |__ Tag
22              |__ Length (34个字符)
74 79 70 65 2e 67 6f 6f 67 6c 65 61 70 69 73 2e 63 6f 6d 2f 6d 79 74 65 73 74 2e 53 75 62 54 65 73 74        |__ 字符串的ASCCII码（以下是对应的字符）
t  y  p  e  .  g  o  o  g  l  e  a  p  i  s  .  c  o  m  /  m  y  t  e  s  t  .  S  u  b  T  e  s  t
​
第二个字段（bytes value = 2）：
12              |__ Tag
02              |__ Length
08 01           |__ mytest::SubTest的编码: 08 -&gt; Tag, 01 -&gt; 值</code></pre></div><blockquote data-pid="43dENhHb">⚡ 注：Any 使用到了<code>reflecttion</code>（反射）功能，<code>C++</code> 编译链接时不能使用 <code>-lprotobuf-lite</code>，而要使用 <code>-lprotobuf</code>。相关介绍请见 「7 可选项 optimize_for」。</blockquote><h2><b>6.9 oneof</b></h2><p data-pid="RSoKsV55"> 如果需求有一条包含许多字段的消息，并且最多同时设置一个字段，那么可以使用 <code>oneof</code> 特性来节省内存。</p><p data-pid="sU68zilg"><code>oneof</code> 字段类似于常规字段，除了 <code>oneof</code> 共享内存的所有字段之外，最多可以同时设置一个字段。设置 <code>oneof</code>  的任何成员都会自动清除所有其他成员。可以使用 <code>case()</code> 或 <code>WhichOneof()</code>方法检查 <code>oneof</code>  中的哪个值被设置(如果有的话)，具体取决于您选择的语言。</p><p data-pid="G52fHnar"><code>oneof</code> 不能使用 <code>repeated</code> 字段。</p><p data-pid="cU7bwFtl"><b>测试-1</b>：</p><div class="highlight"><pre><code class="language-cpp"><span class="cm">/* message Test {
</span><span class="cm"> *   oneof object {
</span><span class="cm"> *     float   one_fl  = 19;
</span><span class="cm"> *     string  one_str = 20;
</span><span class="cm"> *   }
</span><span class="cm"> * } */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">test_1</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">SubTest</span> <span class="n">st1</span><span class="p">;</span>
  <span class="n">st1</span><span class="p">.</span><span class="n">set_i32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">mytest</span><span class="o">::</span><span class="n">Test</span> <span class="n">t1</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_one_fl</span><span class="p">(</span><span class="mf">0.1</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"one_str:"</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="n">one_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">", one_fl:"</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="n">one_fl</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">set_one_str</span><span class="p">(</span><span class="s">"string"</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"one_str:"</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="n">one_str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">", one_fl:"</span> <span class="o">&lt;&lt;</span> <span class="n">t1</span><span class="p">.</span><span class="n">one_fl</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// optimize_for = LITE_RUNTIME 时会 crash，因为 one_fl 被释放掉。
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">dump_hexstring</span><span class="p">(</span><span class="s">"==== test_1 ===="</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="err">​</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">test_1</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p data-pid="TbR9KR5D">编译和执行结果：</p><div class="highlight"><pre><code class="language-bash">one_str:, one_fl:0.1
one_str:string, one_fl:0
<span class="o">====</span> <span class="nv">test_1</span> <span class="o">====</span>:
a2 <span class="m">01</span> <span class="m">06</span> <span class="m">73</span> <span class="m">74</span> <span class="m">72</span> <span class="m">69</span> 6e <span class="m">67</span>
​</code></pre></div><p data-pid="f-TEOmc1">分析结果：</p><div class="highlight"><pre><code class="language-text">one_str:, one_fl:0.1
one_str:string, one_fl:0
| 设置 one_str 的时候，one_fl被清空了，
| 操作（触发内存分配如执行set_xxx或者mutable_xxxx函数）
| 任何一个成员的时候，会清空所有其他成员。
==== test_1 ====:
a2 01 06 73 74 72 69 6e 67
|__|  |  s  t  r  i  n  g  _____ 字符串
   |  |_________________________ Length
   |____________________________ Tag</code></pre></div><h2><b>7 可选项 optimize_for</b></h2><div class="highlight"><pre><code class="language-protobuf"><span class="n">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">optimize_for</span> <span class="o">=</span> <span class="n">SPEED</span><span class="p">;</span> <span class="o">//</span><span class="n">SPEED</span><span class="err">（默认）、</span><span class="n">CODE_SIZE</span><span class="err">、</span><span class="n">LITE_RUNTIME</span></code></pre></div><p data-pid="jvZvX3oL"><b>SPEED</b></p><p data-pid="QnjEUTnT">表示生成的代码运行效率高，但是由此生成的代码编译后会占用更多的空间。 </p><p data-pid="Vd2qT8Eb"><b>CODE_SIZE</b></p><p data-pid="y1XGOX28">和SPEED恰恰相反，代码运行效率较低，但是由此生成的代码编译后会占用更少的空间，通常用于资源有限的平台，如移动设备。</p><p data-pid="odQgC9jW"><b>LITE_RUNTIME</b></p><p data-pid="Sa-nZiob">生成的代码执行效率高，同时生成代码编译后的所占用的空间也是非常少，但是它会缺少一些属性像 <code>reflection</code>（反射）功能。在 <code>C++</code> 中依赖 <code>libprotobuf-lite</code> 库，而非 <code>libprotobuf</code> 库。</p><div class="highlight"><pre><code class="language-bash">$ <span class="nb">cd</span> /usr/local/Cellar/protobuf/3.17.3/lib/
$ ls -lh *.a
-r--r--r--  <span class="m">1</span> baron  admin   835K Jun  <span class="m">8</span> 22:15 libprotobuf-lite.a
-r--r--r--  <span class="m">1</span> baron  admin   4.1M Jun  <span class="m">8</span> 22:15 libprotobuf.a
...</code></pre></div><blockquote data-pid="d1AInIsu">⚡ 注：看 lite 库的体积大小仅仅 非lite库的 1/5 ~ 1/4 左右。</blockquote><h2><b>8 附录</b></h2><h2><b>8.1 补码编码</b></h2><p data-pid="cEDY_WQc">我们先来看一下三个概念：源码、反码、补码</p><ul><li data-pid="ieuU_wuh">原码：最高位为符号位，剩余位表示绝对值；</li><li data-pid="YCB856Uv">反码：除符号位外，对原码剩余位依次取反；</li><li data-pid="lfofuf97">补码：正数补码为其自身，负数补码为除符号位外对原码剩余位依次取反然后加1。</li></ul><p data-pid="VF5WZ9Ef">如果计算机存储正数时，存储的是原码：</p><ul><li data-pid="kXMuuLOb">数字 <code>0</code>  的表示</li></ul><div class="highlight"><pre><code class="language-text">正数0： [0000 0000]原 
负数0： [1000 0000]原 </code></pre></div><ul><li data-pid="7jIyEDzv">原码中还存在加法错误的问题</li></ul><div class="highlight"><pre><code class="language-text">1 + (−1) = [0000 0001]原 + [1000 0001]原 = [1000 0010]原 = −2</code></pre></div><p data-pid="V-o7LS11">如果存储的是补码呢？</p><div class="highlight"><pre><code class="language-text">正数0 = 负数0 = [0000 0000]补
​
1 + (−1) = [0000 0001]补 + [1111 1111]补 = [0000 0000]补 = 0</code></pre></div><p data-pid="cAJ1g-1H">没错，计算机存储整数时采用的是<code>补码</code>。</p><p data-pid="FUChDuez">此外，整数的补码有一些有趣的性质：</p><ul><li data-pid="wTSQZYrD">左移 <code>1</code> 位（<code>n &lt;&lt; 1</code>），无论正数还是负数，相当于乘以 <code>2</code> ；对于正数，若大于<code>MAX_INT/2</code>（<code>1076741823</code>），则会发生溢出，导致左移1位后为负数</li><li data-pid="_maZax4I">右移 <code>31</code> 位（<code>n &gt;&gt; 31</code>），对于正数，则返回<code>0x00000000</code>；对于负数，则返回<code>0xffffffff</code>。</li></ul><h2><b>9 参考文献</b></h2><p data-pid="un1kfJq_"><a href="https://link.zhihu.com/?target=https%3A//developers.google.com/protocol-buffers/docs/proto3%23json" class=" wrap external" target="_blank" rel="nofollow noreferrer" data-za-detail-view-id="1043">Language Guide (proto3)  |  Protocol Buffers  |  Google Developer</a></p></div></div></div></div><div role="button" tabindex="0" class="ContentItem-time">编辑于 2021-09-04 20:05</div><div class="Post-topicsAndReviewer"><div class="TopicList Post-Topics"><div class="Tag Topic css-1s3a4zw" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19564722&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="https://www.zhihu.com/topic/19564722" target="_blank"><div class="css-1gomreu">protobuf</div></a></span></div><div class="Tag Topic css-1s3a4zw" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19552826&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="https://www.zhihu.com/topic/19552826" target="_blank"><div class="css-1gomreu">编程语言</div></a></span></div><div class="Tag Topic css-1s3a4zw" data-za-detail-view-path-module="TopicItem" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Topic&quot;,&quot;token&quot;:&quot;19554298&quot;}}}"><span class="Tag-content"><a class="TopicLink" href="https://www.zhihu.com/topic/19554298" target="_blank"><div class="css-1gomreu">编程</div></a></span></div></div></div><div><div class="Sticky RichContent-actions is-bottom" style=""><div class="ContentItem-actions" data-za-detail-view-path-module="BottomBar" data-za-extra-module="{&quot;card&quot;:{&quot;content&quot;:{&quot;type&quot;:&quot;Post&quot;,&quot;id&quot;:&quot;406832315&quot;}}}"><span><button aria-label="赞同 20 " aria-live="polite" type="button" class="Button VoteButton VoteButton--up"><span style="display:inline-flex;align-items:center">​<svg width="10" height="10" viewBox="0 0 24 24" class="Zi Zi--TriangleUp VoteButton-TriangleUp" fill="currentColor"><path fill-rule="evenodd" d="M13.792 3.681c-.781-1.406-2.803-1.406-3.584 0l-7.79 14.023c-.76 1.367.228 3.046 1.791 3.046h15.582c1.563 0 2.55-1.68 1.791-3.046l-7.79-14.023Z" clip-rule="evenodd"></path></svg></span>赞同 20</button><button aria-label="反对" aria-live="polite" type="button" class="Button VoteButton VoteButton--down"><span style="display:inline-flex;align-items:center">​<svg width="10" height="10" viewBox="0 0 24 24" class="Zi Zi--TriangleDown" fill="currentColor"><path fill-rule="evenodd" d="M13.792 20.319c-.781 1.406-2.803 1.406-3.584 0L2.418 6.296c-.76-1.367.228-3.046 1.791-3.046h15.582c1.563 0 2.55 1.68 1.791 3.046l-7.79 14.023Z" clip-rule="evenodd"></path></svg></span></button></span><button type="button" class="Button BottomActions-CommentBtn Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Comment Button-zi" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>4 条评论</button><div class="Popover ShareMenu"><div class="ShareMenu-toggler" id="Popover2-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover2-content"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Share Button-zi" fill="currentColor"><path d="M19.47 1.914a.8.8 0 0 1 1.204.778l-1.872 16.386a.9.9 0 0 1-1.204.743l-4.615-1.692a.7.7 0 0 0-.831.28l-1.927 3.02c-.43.674-1.474.369-1.474-.43v-3.865a.8.8 0 0 1 .179-.504l5.808-7.148a.595.595 0 0 0-.897-.781l-5.93 6.354a1.1 1.1 0 0 1-1.258.252L2.57 13.46a.8.8 0 0 1-.08-1.415l16.98-10.13Z"></path></svg></span>分享</button></div></div><button aria-live="polite" type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Heart Button-zi" fill="currentColor"><path fill-rule="evenodd" d="M12.004 4.934c1.015-.944 2.484-1.618 3.98-1.618 3.48 0 6.53 3.265 6.15 7.614-.11 1.254-.686 2.55-1.458 3.753-.778 1.215-1.79 2.392-2.845 3.419-1.054 1.028-2.168 1.923-3.161 2.566a9.96 9.96 0 0 1-1.41.777c-.418.182-.862.32-1.268.32s-.848-.137-1.267-.317a9.918 9.918 0 0 1-1.407-.771c-.992-.64-2.103-1.53-3.156-2.555-1.052-1.024-2.062-2.2-2.84-3.417-.77-1.208-1.346-2.51-1.456-3.775-.38-4.349 2.67-7.614 6.15-7.614 1.484 0 2.983.673 3.988 1.618Z" clip-rule="evenodd"></path></svg></span>喜欢</button><button type="button" class="Button Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Star Button-zi" fill="currentColor"><path d="M10.484 3.307c.673-1.168 2.358-1.168 3.032 0l2.377 4.122a.25.25 0 0 0 .165.12l4.655.987c1.319.28 1.84 1.882.937 2.884l-3.186 3.535a.25.25 0 0 0-.063.193l.5 4.733c.142 1.34-1.222 2.33-2.453 1.782l-4.346-1.938a.25.25 0 0 0-.204 0l-4.346 1.938c-1.231.549-2.595-.442-2.453-1.782l.5-4.733a.25.25 0 0 0-.064-.193L2.35 11.42c-.903-1.002-.382-2.604.937-2.884l4.655-.987a.25.25 0 0 0 .164-.12l2.378-4.122Z"></path></svg></span>收藏</button><button type="button" class="Button ContentItem-action Button--plain Button--withIcon Button--withLabel"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Deliver Button-zi" fill="currentColor"><g fill-rule="evenodd" clip-rule="evenodd"><path d="M7.821 12a.75.75 0 0 1 .75-.75h6.857a.75.75 0 0 1 0 1.5H8.571a.75.75 0 0 1-.75-.75ZM8.965 8a.75.75 0 0 1 .75-.75h4.571a.75.75 0 0 1 0 1.5H9.715a.75.75 0 0 1-.75-.75Z"></path><path d="M7.527 3.15a2.35 2.35 0 0 0-2.309 1.91L3.165 15.84a.85.85 0 0 0-.015.16v2.5a2.35 2.35 0 0 0 2.35 2.35h13a2.35 2.35 0 0 0 2.35-2.35V16a.848.848 0 0 0-.015-.16L18.78 5.06a2.35 2.35 0 0 0-2.308-1.91H7.527Zm0 1.7a.65.65 0 0 0-.639.528l-1.88 9.872h13.984l-1.88-9.872a.65.65 0 0 0-.64-.528H7.528Z"></path></g></svg></span>申请转载</button><div class="Post-ActionMenuButton"><div class="Popover"><div id="Popover3-toggle" aria-haspopup="true" aria-expanded="false" aria-owns="Popover3-content"><button type="button" class="Button Button--plain Button--withIcon Button--iconOnly undefined"><span style="display:inline-flex;align-items:center">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="Zi Zi--Dots Button-zi" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></span></button></div></div></div></div></div></div></article><div class="Post-Sub Post-NormalSub"><div style="overflow: unset;" data-za-detail-view-path-module="CommentList" data-za-extra-module="{}"><div class="Comments-container css-plbgu"><div class="css-79elbk"><div><div class="css-1fo89v5"><img class="Avatar css-1oi6kgx" src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg" srcset="https://pica.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=32738c0c 2x"><div class="css-x0pxoz"><div class="css-i6bazn"><div class="css-0"><div class="InputLike css-ip4bff Editable"><div class="Dropzone Editable-content RichText RichText--editable RichText--clearBoth ztext" style="min-height: 38px;"><div class="DraftEditor-root"><div class="public-DraftEditorPlaceholder-root"><div class="public-DraftEditorPlaceholder-inner" id="placeholder-47ic3" style="white-space: pre-wrap;">评论千万条，友善第一条</div></div><div class="DraftEditor-editorContainer"><div aria-describedby="placeholder-47ic3" class="notranslate public-DraftEditor-content" contenteditable="true" role="textbox" spellcheck="true" tabindex="0" style="outline: none; user-select: text; white-space: pre-wrap; overflow-wrap: break-word;"><div data-contents="true"><div class="Editable-unstyled" data-block="true" data-editor="47ic3" data-offset-key="p3s5-0-0"><div data-offset-key="p3s5-0-0" class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr"><span data-offset-key="p3s5-0-0"><br data-text="true"></span></div></div></div></div></div></div></div><div></div><input multiple="" type="file" accept="image/webp,image/jpg,image/jpeg,image/png,image/gif" style="display: none;"></div></div></div></div></div></div><div class="css-z07uxh"><div class="css-we6n55"><div class="css-vpssrj"><div class="css-1k10w8f">4 条评论</div></div><div class="css-59erns"></div><div class="css-1hnxfhy"><div class="css-gjiv4z">默认</div><div class="css-1v9si9f">最新</div></div></div><div class="css-840pn3"><div class="css-1frn93x"><div><div class="css-194v73m"><div class="css-1jll2aj"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/9e9a402c7961be9f48f86689563c04be" target="_blank" class="css-y06ck6"><img class="Avatar css-1s1htbw" src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-abed1a8c04700ba7d72b45195223e0ff_l(1).jpg" srcset="https://pic1.zhimg.com/v2-abed1a8c04700ba7d72b45195223e0ff_l.jpg?source=06d4cd63 2x" alt="知乎用户8hIFpn" loading="lazy"></a></div></div><div class="css-14nvvry"><div class="css-1besdh8"><div class="css-swj9d4"><div class="css-1tww9qq"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/9e9a402c7961be9f48f86689563c04be" target="_blank" class="css-1rd0h6f">知乎用户8hIFpn</a></div><div class="css-1qe0v6x"><div class="css-1ssbn0c"></div></div></div></div><svg width="16" height="16" viewBox="0 0 24 24" class="ZDI ZDI--Dots24 css-zgte1c" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></div><div class="CommentContent css-1ygdre8">谢谢博主的帖子，正在学 protobuf, 对我有帮助。</div><div class="css-140jo2"><div class="css-8hxn0r"><div class="css-x1xlu5"><span class="css-12cl38p">2021-10-26</span></div></div><div class="css-18opwoy"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel css-1o56bgb"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ChatBubbleFill24 css-15ro776" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>回复</button><button type="button" class="Button Button--plain Button--grey Button--withIcon Button--withLabel css-h1yvwn" style="transform: none;"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ThumbFill24 css-15ro776" fill="currentColor"><path d="M8.5 4.078c0-1.834 1.986-2.979 3.573-2.06a4.826 4.826 0 0 1 2.379 4.71l-.114 1.022h3.581c2.53 0 4.334 2.454 3.58 4.868l-1.823 5.833a3.784 3.784 0 0 1-3.848 2.64c-2.372-.147-6.042-.341-8.828-.341H4.5A1.75 1.75 0 0 1 2.75 19V9.5c0-.967.784-1.75 1.75-1.75h.637a3.418 3.418 0 0 0 3.19-2.191c.115-.296.173-.611.173-.928v-.553Z"></path></svg></span>1</button></div></div></div></div></div><div><div class="css-194v73m"><div class="css-1jll2aj"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/1bedd5682518137bf4899ae9ef6bd19b" target="_blank" class="css-y06ck6"><img class="Avatar css-1s1htbw" src="./深入浅出：如何正确使用 protobuf - 知乎_files/918439abcb2de4b62e2949523be00c1b_l.jpg" srcset="https://picx.zhimg.com/918439abcb2de4b62e2949523be00c1b_l.jpg?source=06d4cd63 2x" alt="firendlys" loading="lazy"></a></div></div><div class="css-14nvvry"><div class="css-1besdh8"><div class="css-swj9d4"><div class="css-1tww9qq"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/1bedd5682518137bf4899ae9ef6bd19b" target="_blank" class="css-1rd0h6f">firendlys</a></div><div class="css-1qe0v6x"><div class="css-1ssbn0c"></div></div></div></div><svg width="16" height="16" viewBox="0 0 24 24" class="ZDI ZDI--Dots24 css-zgte1c" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></div><div class="CommentContent css-1ygdre8"><p>文章5.3节错了.   (14 &lt;&lt; 3 | 5) = 117 , 不是114 。如果要求最终值为 114（0x72 ） ，那么 wire-type 应该是2 ， 而不是 5</p></div><div class="css-140jo2"><div class="css-8hxn0r"><div class="css-x1xlu5"><span class="css-12cl38p">04-10</span></div></div><div class="css-18opwoy"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel css-1o56bgb"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ChatBubbleFill24 css-15ro776" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>回复</button><button type="button" class="Button Button--plain Button--grey Button--withIcon Button--withLabel css-h1yvwn" style="transform: none;"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ThumbFill24 css-15ro776" fill="currentColor"><path d="M8.5 4.078c0-1.834 1.986-2.979 3.573-2.06a4.826 4.826 0 0 1 2.379 4.71l-.114 1.022h3.581c2.53 0 4.334 2.454 3.58 4.868l-1.823 5.833a3.784 3.784 0 0 1-3.848 2.64c-2.372-.147-6.042-.341-8.828-.341H4.5A1.75 1.75 0 0 1 2.75 19V9.5c0-.967.784-1.75 1.75-1.75h.637a3.418 3.418 0 0 0 3.19-2.191c.115-.296.173-.611.173-.928v-.553Z"></path></svg></span>赞</button></div></div></div></div></div><div><div class="css-194v73m"><div class="css-1jll2aj"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/b0ff67c7129cfacac779d18cc1096768" target="_blank" class="css-y06ck6"><img class="Avatar css-1s1htbw" src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-b0a5686340579f300a47ceae0db04b70_l.jpg" srcset="https://picx.zhimg.com/v2-b0a5686340579f300a47ceae0db04b70_l.jpg?source=06d4cd63 2x" alt="陈晨" loading="lazy"></a></div></div><div class="css-14nvvry"><div class="css-1besdh8"><div class="css-swj9d4"><div class="css-1tww9qq"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/b0ff67c7129cfacac779d18cc1096768" target="_blank" class="css-1rd0h6f">陈晨</a></div><div class="css-1qe0v6x"><div class="css-1ssbn0c"></div></div></div></div><svg width="16" height="16" viewBox="0 0 24 24" class="ZDI ZDI--Dots24 css-zgte1c" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></div><div class="CommentContent css-1ygdre8"><p>但是，Varint 编码可以做到总共可以只用 2 个字节来表示值 1。这是怎么做到的？</p><p>只用1个字节，这里写错了</p></div><div class="css-140jo2"><div class="css-8hxn0r"><div class="css-x1xlu5"><span class="css-12cl38p">04-07</span></div></div><div class="css-18opwoy"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel css-1o56bgb"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ChatBubbleFill24 css-15ro776" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>回复</button><button type="button" class="Button Button--plain Button--grey Button--withIcon Button--withLabel css-h1yvwn" style="transform: none;"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ThumbFill24 css-15ro776" fill="currentColor"><path d="M8.5 4.078c0-1.834 1.986-2.979 3.573-2.06a4.826 4.826 0 0 1 2.379 4.71l-.114 1.022h3.581c2.53 0 4.334 2.454 3.58 4.868l-1.823 5.833a3.784 3.784 0 0 1-3.848 2.64c-2.372-.147-6.042-.341-8.828-.341H4.5A1.75 1.75 0 0 1 2.75 19V9.5c0-.967.784-1.75 1.75-1.75h.637a3.418 3.418 0 0 0 3.19-2.191c.115-.296.173-.611.173-.928v-.553Z"></path></svg></span>赞</button></div></div></div></div></div><div><div class="css-194v73m"><div class="css-1jll2aj"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/98c41cc0c09fe4fa6e50ac1e1dfc816f" target="_blank" class="css-y06ck6"><img class="Avatar css-1s1htbw" src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-5555b2affad0a417b148c9e8977612f6_l(1).jpg" srcset="https://pic1.zhimg.com/v2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=06d4cd63 2x" alt="津的技术专栏" loading="lazy"></a></div></div><div class="css-14nvvry"><div class="css-1besdh8"><div class="css-swj9d4"><div class="css-1tww9qq"><div class="css-1gomreu"><a href="https://www.zhihu.com/people/98c41cc0c09fe4fa6e50ac1e1dfc816f" target="_blank" class="css-1rd0h6f">津的技术专栏</a></div><div class="css-1qe0v6x"><div class="css-1ssbn0c"></div><span class="css-h9ndtl" href="">作者</span></div></div></div><svg width="16" height="16" viewBox="0 0 24 24" class="ZDI ZDI--Dots24 css-zgte1c" fill="currentColor"><path fill-rule="evenodd" d="M5.83 12a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm7.835 0a1.665 1.665 0 1 1-3.33 0 1.665 1.665 0 0 1 3.33 0Zm6.17 1.665a1.665 1.665 0 1 0 0-3.33 1.665 1.665 0 0 0 0 3.33Z" clip-rule="evenodd"></path></svg></div><div class="CommentContent css-1ygdre8">希望对你有帮助<img src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-f5aa165e86b5c9ed3b7bee821da59365.png" class="sticker" alt="[握手]"></div><div class="css-140jo2"><div class="css-8hxn0r"><div class="css-x1xlu5"><span class="css-12cl38p">2022-01-13</span></div></div><div class="css-18opwoy"><button type="button" class="Button Button--plain Button--withIcon Button--withLabel css-1o56bgb"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ChatBubbleFill24 css-15ro776" fill="currentColor"><path fill-rule="evenodd" d="M12 2.75a9.25 9.25 0 1 0 4.737 17.197l2.643.817a1 1 0 0 0 1.25-1.25l-.8-2.588A9.25 9.25 0 0 0 12 2.75Z" clip-rule="evenodd"></path></svg></span>回复</button><button type="button" class="Button Button--plain Button--grey Button--withIcon Button--withLabel css-h1yvwn" style="transform: none;"><span style="display: inline-flex; align-items: center;">​<svg width="1.2em" height="1.2em" viewBox="0 0 24 24" class="ZDI ZDI--ThumbFill24 css-15ro776" fill="currentColor"><path d="M8.5 4.078c0-1.834 1.986-2.979 3.573-2.06a4.826 4.826 0 0 1 2.379 4.71l-.114 1.022h3.581c2.53 0 4.334 2.454 3.58 4.868l-1.823 5.833a3.784 3.784 0 0 1-3.848 2.64c-2.372-.147-6.042-.341-8.828-.341H4.5A1.75 1.75 0 0 1 2.75 19V9.5c0-.967.784-1.75 1.75-1.75h.637a3.418 3.418 0 0 0 3.19-2.191c.115-.296.173-.611.173-.928v-.553Z"></path></svg></span>赞</button></div></div></div></div></div><div></div></div></div></div></div></div></div><div class="PostIndex-Contributions" data-za-detail-view-path-module="ColumnList" data-za-detail-view-path-module_name="文章被以下专栏收录" data-za-extra-module="{}"><h3 class="BlockTitle">文章被以下专栏收录</h3><ul><div class="ContentItem Column-ColumnItem"><div class="ContentItem-main"><div class="ContentItem-image"><a class="ColumnLink" href="https://www.zhihu.com/column/c_1417572457507713024"><div class="css-1gomreu"><img class="Avatar css-1any501" src="./深入浅出：如何正确使用 protobuf - 知乎_files/4b70deef7_l.jpg" srcset="https://pica.zhimg.com/4b70deef7_l.jpg?source=172ae18b 2x" alt="我和我的架构师"></div></a></div><div class="ContentItem-head"><h2 class="ContentItem-title"><span><a class="ColumnLink ColumnItem-Title" href="https://www.zhihu.com/column/c_1417572457507713024"><div class="css-1gomreu">我和我的架构师</div></a></span></h2><div class="ContentItem-meta">编程开发、系统架构、开源软件等技术干货分享中 ~</div></div></div></div></ul></div><div role="complementary" aria-label="推荐阅读" class="Recommendations-Main" style="width: 1905px;"><h3 class="BlockTitle Recommendations-BlockTitle">推荐阅读</h3><ul class="Recommendations-List"><button class="PagingButton PagingButton-Previous" disabled="" data-za-detail-view-path-module="Unknown" data-za-detail-view-path-module_name="推荐阅读" data-za-extra-module="{}"><svg width="40" height="40" viewBox="0 0 24 24" fill="#d3d3d3" class="Zi Zi--ArrowLeft"><path fill-rule="evenodd" d="m10.752 12 4.025-3.78a.684.684 0 0 0 0-1.01.796.796 0 0 0-1.075 0l-4.42 4.15a.866.866 0 0 0 0 1.28l4.42 4.15a.796.796 0 0 0 1.075 0 .684.684 0 0 0 0-1.01L10.752 12Z" clip-rule="evenodd"></path></svg></button><a href="https://zhuanlan.zhihu.com/p/436041011" class="PostItem"><div><h1 class="PostItem-Title">深入解析protobuf 1-proto3 使用及编解码原理介绍</h1><p class="PostItem-Summary">前面已经讲了grpc基础使用，其中用到了Protocol buffers，这次先讲下Protocol Buffers的基本使用，和编解码原理。后面会有高级教程讲如何二次开发proto-gen-go ，protobuf 官方功能并不是很…</p><div class="PostItem-Footer"><span>杨桃不爱程...</span><span class="PostItem-FooterTitle">发表于go 开源...</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/38532869" class="PostItem"><div><img src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-efe9d55bb5f349734686a7be82ad7fa6_250x0.jpg" srcset="https://picx.zhimg.com/v2-efe9d55bb5f349734686a7be82ad7fa6_qhd.jpg?source=172ae18b 2x" class="PostItem-TitleImage" alt="Protobuf 作者不建议在 Deno 中使用 Protobuf"><h1 class="PostItem-Title">Protobuf 作者不建议在 Deno 中使用 Protobuf</h1><div class="PostItem-Footer"><span>justjavac</span><span class="PostItem-FooterTitle"></span></div></div></a><a href="https://zhuanlan.zhihu.com/p/458920061" class="PostItem"><div><img src="./深入浅出：如何正确使用 protobuf - 知乎_files/v2-1e3414ea39288174d2e2be9c82f5a404_250x0.jpg" srcset="https://pic1.zhimg.com/v2-1e3414ea39288174d2e2be9c82f5a404_qhd.jpg?source=172ae18b 2x" class="PostItem-TitleImage" alt="7天从零实现分布式缓存-Day7 使用 Protobuf 通信"><h1 class="PostItem-Title">7天从零实现分布式缓存-Day7 使用 Protobuf 通信</h1><div class="PostItem-Footer"><span>Golan...</span><span class="PostItem-FooterTitle">发表于Golan...</span></div></div></a><a href="https://zhuanlan.zhihu.com/p/459591333" class="PostItem"><div><h1 class="PostItem-Title">protobuf 一种更小、更快、更高效的协议</h1><p class="PostItem-Summary">B站千万级弹幕通信协议protobuf工程实践（linux服务器开发）_哔哩哔哩_bilibiliprotobuf的优点：更小、更快、更简单。支持多种编程语言 。解析速度快。可扩展性强。什么是protobuf、protobu…</p><div class="PostItem-Footer"><span>linux...</span><span class="PostItem-FooterTitle">发表于Linux...</span></div></div></a><button class="PagingButton PagingButton-Next" data-za-detail-view-path-module="Unknown" data-za-detail-view-path-module_name="推荐阅读" data-za-extra-module="{}"><svg width="40" height="40" viewBox="0 0 24 24" fill="#d3d3d3" class="Zi Zi--ArrowRight"><path fill-rule="evenodd" d="m13.248 12-4.025 3.78a.684.684 0 0 0 0 1.01.796.796 0 0 0 1.075 0l4.42-4.15a.867.867 0 0 0 0-1.28l-4.42-4.15a.796.796 0 0 0-1.075 0 .684.684 0 0 0 0 1.01L13.248 12Z" clip-rule="evenodd"></path></svg></button></ul></div></div></div></main><div role="complementary"><div class="CornerButtons"><div class="CornerAnimayedFlex"><button data-tooltip="回到顶部" data-tooltip-position="left" data-tooltip-will-hide-on-click="true" aria-label="回到顶部" type="button" class="Button CornerButton Button--plain css-gdd4kf"><svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" class="Zi Zi--BackToTop" fill="currentColor"><path fill-rule="evenodd" d="M13.204 3.107a1.75 1.75 0 0 0-2.408 0L3.806 9.73c-1.148 1.088-.378 3.02 1.204 3.02h2.24V20c0 .966.784 1.75 1.75 1.75h6A1.75 1.75 0 0 0 16.75 20v-7.25h2.24c1.582 0 2.353-1.932 1.204-3.02l-6.99-6.623Z" clip-rule="evenodd"></path></svg></button></div></div></div></div></div><script id="js-clientConfig" type="text/json">{"fetchRoot":{"www":"https:\u002F\u002Fwww.zhihu.com","api":"https:\u002F\u002Fapi.zhihu.com","lens":"https:\u002F\u002Flens.zhihu.com","zhuanlan":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fapi\u002F","walletpay":"https:\u002F\u002Fwalletpay.zhihu.com","captcha":"https:\u002F\u002Fcaptcha.zhihu.com","vzuu":"https:\u002F\u002Fv.vzuu.com","openapi":"https:\u002F\u002Fopenapi.zhihu.com","svip":"https:\u002F\u002Fsvip.zhihu.com"},"host":"zhihu.com","protocol":"https:","wwwHost":"www.zhihu.com","videoHost":"video.zhihu.com","zhuanlanHost":"zhuanlan.zhihu.com","allowSignUp":true,"refreshValidityPeriod":"30","release":"721-49f562a5","currentEntry":"column","isMobileEntry":false,"apollo":{"env":"prod","globalSilence":"","topstory_rec_adp":"1","test_canary":"member|0-100,1-0","use_new_player":"member|0-50,1-50","player_vendor":"member|0-50,1-50,2-0","use_hevc":"member|0-0,1-100","upload_use_signature":"member|0-0,1-100","use_backdrop_blur":"member|0-70,1-30","article_title_imagex":"member|0-70,1-30","play_station":"member|0-0,1-100"}}</script><script id="js-initialData" type="text/json">{"initialState":{"common":{"ask":{}},"loading":{"global":{"count":0},"local":{"env\u002FgetIpinfo\u002F":false,"article\u002Fget\u002F":false,"brand\u002FgetUrl\u002F":false,"article\u002FloadPostSearchEntity\u002F":false}},"entities":{"users":{"c29982ea4958b35f1d733b99ef5bf579":{"uid":1454038455692562400,"userType":"people","id":"c29982ea4958b35f1d733b99ef5bf579"},"qing-feng-32-87-12":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6.jpg?source=172ae18b","uid":"811149941132103680","userType":"people","isFollowing":false,"urlToken":"qing-feng-32-87-12","id":"98c41cc0c09fe4fa6e50ac1e1dfc816f","description":"","name":"津的技术专栏","isAdvertiser":false,"headline":"编程开发、系统架构、开源软件等技术干货分享中 ~","gender":1,"url":"\u002Fpeople\u002F98c41cc0c09fe4fa6e50ac1e1dfc816f","avatarUrl":"https:\u002F\u002Fpica.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b","isOrg":false,"type":"people","badge":[],"badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""},"exposedMedal":{"medalId":"972477022068568064","medalName":"备受瞩目","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-7565d834d652a9960da0cedd8d7952ee_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-7565d834d652a9960da0cedd8d7952ee_l.png?source=172ae18b","description":"被 100 个人关注","medalAvatarFrame":""}}},"questions":{},"answers":{},"articles":{"406832315":{"trackUrl":["https:\u002F\u002Fsugar.zhihu.com\u002Fplutus_adreaper\u002Fcontent_monitor_log?si=__SESSIONID__&ti=__ATOKEN__&at=view&pf=__OS__&ed=BiBUKF0xBSkqGGpfBWh6CVx3AAGOF_uGOiPJ&idfa=__IDFA__&imei=__IMEI__&androidid=__ANDROIDID__&oaid=__OAID__&ci=__CREATIVEID__&zid=__ZONEID__"],"entityWords":[{"name":"ffffffff","mention":"ffffffff","matchorder":1,"begin":20970,"end":20978,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Math","score":0,"attachedInfoBytes":"sgJSCghmZmZmZmZmZhIETWF0aBjqowEg8qMBKAE1AAAAADoHYXJ0aWNsZUAASABSJDljYmVkZWU1LTFhZGItNGE1Zi04NDgxLTk1YTAxZjUwZjUzNA==","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"编码序列","mention":"编码序列","matchorder":1,"begin":17951,"end":17955,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Unknown","score":0,"attachedInfoBytes":"sgJZCgznvJbnoIHluo\u002FliJcSB1Vua25vd24Yn4wBIKOMASgBNQAAAAA6B2FydGljbGVAAEgAUiQ5Y2JlZGVlNS0xYWRiLTRhNWYtODQ4MS05NWEwMWY1MGY1MzQ=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"libprotobuf-lite.a","mention":"libprotobuf-lite.a","matchorder":1,"begin":67422,"end":67440,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Medical","score":0,"attachedInfoBytes":"sgJfChJsaWJwcm90b2J1Zi1saXRlLmESB01lZGljYWwY3o4EIPCOBCgBNQAAAAA6B2FydGljbGVAAEgAUiQ5Y2JlZGVlNS0xYWRiLTRhNWYtODQ4MS05NWEwMWY1MGY1MzQ=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"value field-number","mention":"value field-number","matchorder":1,"begin":54056,"end":54074,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJhChJ2YWx1ZSBmaWVsZC1udW1iZXISCU90aGVyVGVybRiopgMguqYDKAE1AAAAADoHYXJ0aWNsZUAASABSJDljYmVkZWU1LTFhZGItNGE1Zi04NDgxLTk1YTAxZjUwZjUzNA==","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"Key field-number","mention":"Key field-number","matchorder":1,"begin":54134,"end":54150,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJfChBLZXkgZmllbGQtbnVtYmVyEglPdGhlclRlcm0Y9qYDIIanAygBNQAAAAA6B2FydGljbGVAAEgAUiQ5Y2JlZGVlNS0xYWRiLTRhNWYtODQ4MS05NWEwMWY1MGY1MzQ=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"Length-delimited","mention":"Length-delimited","matchorder":4,"begin":594,"end":610,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJdChBMZW5ndGgtZGVsaW1pdGVkEglPdGhlclRlcm0Y0gQg4gQoBDUAAAAAOgdhcnRpY2xlQABIAFIkOWNiZWRlZTUtMWFkYi00YTVmLTg0ODEtOTVhMDFmNTBmNTM0","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"sfixed32 sfx32","mention":"sfixed32 sfx32","matchorder":1,"begin":1329,"end":1343,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Medical","score":0,"attachedInfoBytes":"sgJZCg5zZml4ZWQzMiBzZngzMhIHTWVkaWNhbBixCiC\u002FCigBNQAAAAA6B2FydGljbGVAAEgAUiQ5Y2JlZGVlNS0xYWRiLTRhNWYtODQ4MS05NWEwMWY1MGY1MzQ=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"Key-Value-Group","mention":"Key-Value-Group","matchorder":1,"begin":53788,"end":53803,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"Physics","score":0,"attachedInfoBytes":"sgJcCg9LZXktVmFsdWUtR3JvdXASB1BoeXNpY3MYnKQDIKukAygBNQAAAAA6B2FydGljbGVAAEgAUiQ5Y2JlZGVlNS0xYWRiLTRhNWYtODQ4MS05NWEwMWY1MGY1MzQ=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""},{"name":"little endian","mention":"little endian","matchorder":1,"begin":20563,"end":20576,"entityid":0,"isBookMark":false,"link":{"linkType":0,"linkUrl":"","docType":"","topicToken":""},"entityClass":"OtherTerm","score":0,"attachedInfoBytes":"sgJcCg1saXR0bGUgZW5kaWFuEglPdGhlclRlcm0Y06ABIOCgASgBNQAAAAA6B2FydGljbGVAAEgAUiQ5Y2JlZGVlNS0xYWRiLTRhNWYtODQ4MS05NWEwMWY1MGY1MzQ=","isOnAB":false,"isNatural":1,"isDelete":false,"contentType":"","contentId":"","contentToken":""}],"id":406832315,"title":"深入浅出：如何正确使用 protobuf","type":"article","articleType":"normal","excerptTitle":"","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F406832315","imageUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-b1c16e5a81bd4ae56aa6651d34f7a7be_720w.jpg?source=172ae18b","titleImage":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-b1c16e5a81bd4ae56aa6651d34f7a7be_720w.jpg?source=172ae18b","excerpt":"目录导航1 写在前面2 初识 protobuf 语法3 基于 Protobuf 的编程示例4 Protobuf 的数据类型5 Protobuf 编码方法5.1 Varint5.1.1 Varint 是什么？5.1.2 Tag 信息5.1.3 Data 信息5.2 ZigZag 编码5.2.1 ZigZag 编码解决了什么问题？5.2.2 ZigZag是怎么编码的？…","created":1630755532,"updated":1630757152,"author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6.jpg?source=172ae18b","uid":"811149941132103680","userType":"people","isFollowing":false,"urlToken":"qing-feng-32-87-12","id":"98c41cc0c09fe4fa6e50ac1e1dfc816f","description":"","name":"津的技术专栏","isAdvertiser":false,"headline":"编程开发、系统架构、开源软件等技术干货分享中 ~","gender":1,"url":"\u002Fpeople\u002F98c41cc0c09fe4fa6e50ac1e1dfc816f","avatarUrl":"https:\u002F\u002Fpica.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b","isOrg":false,"type":"people","badge":[],"badgeV2":{"title":"","mergedBadges":[],"detailBadges":[],"icon":"","nightIcon":""},"exposedMedal":{"medalId":"972477022068568064","medalName":"备受瞩目","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-7565d834d652a9960da0cedd8d7952ee_r.png?source=172ae18b","miniAvatarUrl":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-7565d834d652a9960da0cedd8d7952ee_l.png?source=172ae18b","description":"被 100 个人关注","medalAvatarFrame":""}},"commentPermission":"all","copyrightPermission":"need_review","state":"published","ipInfo":"","imageWidth":463,"imageHeight":300,"content":"\u003Ch2\u003E目录导航\u003C\u002Fh2\u003E\u003Cul\u003E\u003Cli data-pid=\"E-yPo0Jf\"\u003E1 写在前面\u003C\u002Fli\u003E\u003Cli data-pid=\"z2cltjQc\"\u003E2 初识 protobuf 语法\u003C\u002Fli\u003E\u003Cli data-pid=\"lkVxRmaS\"\u003E3 基于 Protobuf 的编程示例\u003C\u002Fli\u003E\u003Cli data-pid=\"a39CDWhj\"\u003E4 Protobuf 的数据类型\u003C\u002Fli\u003E\u003Cli data-pid=\"b35WdAJs\"\u003E5 Protobuf 编码方法\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"_MktiJSR\"\u003E5.1 Varint\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"9EWBj3Lm\"\u003E5.1.1 Varint 是什么？\u003C\u002Fli\u003E\u003Cli data-pid=\"IqLPb13A\"\u003E5.1.2 Tag 信息\u003C\u002Fli\u003E\u003Cli data-pid=\"QJnRo1fa\"\u003E5.1.3 Data 信息\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"pp_33rAC\"\u003E5.2 ZigZag 编码\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"bIg4ksiE\"\u003E5.2.1 ZigZag 编码解决了什么问题？\u003C\u002Fli\u003E\u003Cli data-pid=\"0IR7an5X\"\u003E5.2.2 ZigZag是怎么编码的？\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"PEI6E88E\"\u003E5.3 Length-delimited\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"NA0Jom5q\"\u003E6 如何正确使用每种类型\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"My7eoVRs\"\u003E6.1 int32\u002Fuint32\u002Fsint32\u002Fint64\u002Fuint64\u002Fsint64\u003C\u002Fli\u003E\u003Cli data-pid=\"qLuTJp2e\"\u003E6.2 fixed32\u002Fsfixed32\u002Ffixed64\u002Fsfixed64\u003C\u002Fli\u003E\u003Cli data-pid=\"wwZlqMru\"\u003E6.3 float\u002Fdouble\u003C\u002Fli\u003E\u003Cli data-pid=\"w3J9yoMu\"\u003E6.4 string\u002Fbytes\u003C\u002Fli\u003E\u003Cli data-pid=\"zOxcgO30\"\u003E6.5 repeated\u003C\u002Fli\u003E\u003Cli data-pid=\"ciLxfHkQ\"\u003E6.6 embedding message\u003C\u002Fli\u003E\u003Cli data-pid=\"AszVgbL4\"\u003E6.7 map\u003C\u002Fli\u003E\u003Cli data-pid=\"ubGY3ChF\"\u003E6.8 any\u003C\u002Fli\u003E\u003Cli data-pid=\"MVR3Ou--\"\u003E6.9 oneof\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"-RoWDfUU\"\u003E7 可选项 optimize_for\u003C\u002Fli\u003E\u003Cli data-pid=\"36ISi7Y0\"\u003E8 附录\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"iW6Axwff\"\u003E8.1 补码编码\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"rFl1DPYt\"\u003E9 参考文献\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Chr\u002F\u003E\u003Cp data-pid=\"3rL0VC8y\"\u003E\u003Cb\u003E1 写在前面\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"Rqr_O03V\"\u003E本文适合 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 入门、进阶的开发者阅读，是一篇讲原理的文章，主要是介绍了如何正确使用 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 的特性，以比较大地发挥它的优势。阅读本文之后，开发者能够对Protobuf实现原理有深入的理解，在日常开发中能够熟练运用。\u003C\u002Fp\u003E\u003Cp data-pid=\"PUsLQ7Cg\"\u003E本文基于 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 的 \u003Ccode\u003E3.17.3\u003C\u002Fcode\u003E 版本进行分析、\u003Ccode\u003Eproto3\u003C\u002Fcode\u003E 的语法、编码示例使用 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 语言实现。\u003C\u002Fp\u003E\u003Ch2\u003E\u003Cb\u003E2 初识 protobuf 语法\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"bIZfInf9\"\u003E\u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E  官方实现了一门语言，专门用来自定义数据结构。\u003Ccode\u003Eprotoc\u003C\u002Fcode\u003E 是这门语言的编译工具，可编译生成指定编程语言（如\u003Ccode\u003EC++\u003C\u002Fcode\u003E、\u003Ccode\u003EJava\u003C\u002Fcode\u003E、\u003Ccode\u003EGolang\u003C\u002Fcode\u003E、\u003Ccode\u003EPython\u003C\u002Fcode\u003E、\u003Ccode\u003EC#\u003C\u002Fcode\u003E 等）的源代码，然后开发者可以轻松在这些语言中使用该源代码进行编程。\u003C\u002Fp\u003E\u003Cp data-pid=\"DrJQlBKm\"\u003E以下  \u003Ccode\u003Etest.proto\u003C\u002Fcode\u003E  就是一个 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 语言的示例。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-protobuf\"\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F选择  proto2 或者 proto3 的语法，这里指定了 proto3 的语法\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esyntax\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;proto3&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F包名，在 C++ 里表现为 namespace\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kn\"\u003Epackage\u003C\u002Fspan\u003E \u003Cspan class=\"nn\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002Foption optimize_for = LITE_RUNTIME;\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F依赖的其他 proto 源文件，\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F在依赖的数据类型在其他 proto 源文件中定义的情况下，\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F需要通过 import 导入其他 proto 源文件\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eimport\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;google\u002Fprotobuf\u002Fany.proto&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002Fmessage 是消息体，它就是一个结构体\u002F类\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Emessage\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ESubTest\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Eint32\u003C\u002Fspan\u003E              \u003Cspan class=\"n\"\u003Ei32\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Emessage\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002F数据类型            字段          field-number (还是用英文原文好一点)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Eint32\u003C\u002Fspan\u003E              \u003Cspan class=\"n\"\u003Ei32\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Eint64\u003C\u002Fspan\u003E              \u003Cspan class=\"n\"\u003Ei64\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Euint32\u003C\u002Fspan\u003E             \u003Cspan class=\"n\"\u003Eu32\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Euint64\u003C\u002Fspan\u003E             \u003Cspan class=\"n\"\u003Eu64\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E4\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Esint32\u003C\u002Fspan\u003E             \u003Cspan class=\"n\"\u003Esi32\u003C\u002Fspan\u003E     \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E5\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Esint64\u003C\u002Fspan\u003E             \u003Cspan class=\"n\"\u003Esi64\u003C\u002Fspan\u003E     \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E6\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Efixed32\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003Efx32\u003C\u002Fspan\u003E     \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E7\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Efixed64\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003Efx64\u003C\u002Fspan\u003E     \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E8\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Esfixed32\u003C\u002Fspan\u003E           \u003Cspan class=\"n\"\u003Esfx32\u003C\u002Fspan\u003E    \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E9\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Esfixed64\u003C\u002Fspan\u003E           \u003Cspan class=\"n\"\u003Esfx64\u003C\u002Fspan\u003E    \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E10\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Ebool\u003C\u002Fspan\u003E               \u003Cspan class=\"n\"\u003Ebl\u003C\u002Fspan\u003E       \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E11\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Efloat\u003C\u002Fspan\u003E              \u003Cspan class=\"n\"\u003Ef32\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E12\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Edouble\u003C\u002Fspan\u003E             \u003Cspan class=\"n\"\u003Ed64\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E13\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Estring\u003C\u002Fspan\u003E             \u003Cspan class=\"n\"\u003Estr\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E14\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Ebytes\u003C\u002Fspan\u003E              \u003Cspan class=\"n\"\u003Ebs\u003C\u002Fspan\u003E       \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E15\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"k\"\u003Erepeated\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint32\u003C\u002Fspan\u003E     \u003Cspan class=\"n\"\u003Evec\u003C\u002Fspan\u003E      \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E16\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Emap\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E&lt;\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Eint32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E&gt;\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Emp\u003C\u002Fspan\u003E       \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E17\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003ESubTest\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003Etest\u003C\u002Fspan\u003E     \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E18\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"k\"\u003Eoneof\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eobject\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"kt\"\u003Efloat\u003C\u002Fspan\u003E            \u003Cspan class=\"n\"\u003Eobj_f32\u003C\u002Fspan\u003E  \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E19\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E    \u003Cspan class=\"kt\"\u003Estring\u003C\u002Fspan\u003E           \u003Cspan class=\"n\"\u003Eobj_str\u003C\u002Fspan\u003E  \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E20\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Egoogle.protobuf.Any\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eany\u003C\u002Fspan\u003E     \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E   \u003Cspan class=\"mi\"\u003E21\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch2\u003E\u003Cb\u003E3 基于 Protobuf 的编程示例\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"lc2wLxpZ\"\u003E这是一个基于 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 语言编写的程序，由  \u003Ccode\u003EMakefile\u003C\u002Fcode\u003E、\u003Ccode\u003Etest.cc\u003C\u002Fcode\u003E、\u003Ccode\u003Etest.proto\u003C\u002Fcode\u003E 三个源代码文件组成。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E$ tree\n.\n├── Makefile\n├── test.cc\n└── test.proto\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"6HIIGZ43\"\u003E编写源文件 \u003Ccode\u003Etest.cc\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cp\"\u003E#include\u003C\u002Fspan\u003E \u003Cspan class=\"cpf\"\u003E&lt;cstdio&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"cp\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"cp\"\u003E#include\u003C\u002Fspan\u003E \u003Cspan class=\"cpf\"\u003E&lt;iostream&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"cp\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"cp\"\u003E#include\u003C\u002Fspan\u003E \u003Cspan class=\"cpf\"\u003E&#34;test.pb.h&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"cp\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"cp\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"c1\"\u003E\u002F\u002F输出十六进制编码\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etag\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"k\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Eprintf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;%s:\u003C\u002Fspan\u003E\u003Cspan class=\"se\"\u003E\\n\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etag\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ec_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E());\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize_t\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ei\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ei\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Esize\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E++\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ei\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"n\"\u003Eprintf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;%02x &#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"kt\"\u003Eunsigned\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Echar\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Edata\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ei\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E]);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Eprintf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"se\"\u003E\\n\\n\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E300\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"Tvv5T-FS\"\u003E编写源文件 \u003Ccode\u003EMakefile\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-make\"\u003E\u003Cspan class=\"nf\"\u003Eall\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etest\u003C\u002Fspan\u003E\n\u003Cspan class=\"nf\"\u003Etest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etest\u003C\u002Fspan\u003E.\u003Cspan class=\"n\"\u003Epb\u003C\u002Fspan\u003E.\u003Cspan class=\"n\"\u003Eo\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etest\u003C\u002Fspan\u003E.\u003Cspan class=\"n\"\u003Eo\u003C\u002Fspan\u003E\n  g++ -std\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Ec++11 -o \u003Cspan class=\"nb\"\u003Etest\u003C\u002Fspan\u003E -lprotobuf $^\n  \u003Cspan class=\"c1\"\u003E#g++ -std=c++11 -o test -lprotobuf-lite $^\u003C\u002Fspan\u003E\n\u003Cspan class=\"nf\"\u003E%.o\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E %.\u003Cspan class=\"n\"\u003Ecc\u003C\u002Fspan\u003E\n  g++ -std\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Ec++11 -c -o \u003Cspan class=\"nv\"\u003E$@\u003C\u002Fspan\u003E $&lt;\n\u003Cspan class=\"nf\"\u003Eproto\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n  \u003Cspan class=\"c1\"\u003E# 生成 C++ 源代码\u003C\u002Fspan\u003E\n  protoc --cpp_out\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E.\u002F test.proto\n\u003Cspan class=\"nf\"\u003Eclean\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E\n  rm -f *.o \u003Cspan class=\"nb\"\u003Etest\u003C\u002Fspan\u003E test.pb.*\n\u003Cspan class=\"nf\"\u003E.PHONY\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eclean\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eproto\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"fDlmjjJR\"\u003E编译和执行\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E$ make clean\nrm -f *.o \u003Cspan class=\"nb\"\u003Etest\u003C\u002Fspan\u003E test.pb.*\n$ make proto\n\u003Cspan class=\"c1\"\u003E# 生成 C++ 源代码\u003C\u002Fspan\u003E\nprotoc --cpp_out\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E.\u002F test.proto\n$ tree\n.\n├── Makefile\n├── test.cc\n├── test.pb.cc  \u003Cspan class=\"c1\"\u003E# 由 test.proto 编译生成的源文件\u003C\u002Fspan\u003E\n├── test.pb.h   \u003Cspan class=\"c1\"\u003E# 同上\u003C\u002Fspan\u003E\n└── test.proto\n​\n$ make\ng++ -std\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Ec++11 -c -o test.pb.o test.pb.cc\ng++ -std\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Ec++11 -c -o test.o test.cc\ng++ -std\u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003Ec++11 -o \u003Cspan class=\"nb\"\u003Etest\u003C\u002Fspan\u003E -lprotobuf test.pb.o test.o\n$ .\u002Ftest\n\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E ac \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch2\u003E\u003Cb\u003E4 Protobuf 的数据类型\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"oxEPDL_k\"\u003E以下是一个 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 数据类型和其他编程语言的数据类型的映射关系表。\u003C\u002Fp\u003E\u003Ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Cth\u003EProtobuf Type\u003C\u002Fth\u003E\u003Cth\u003E说明\u003C\u002Fth\u003E\u003Cth\u003EC++ Type\u003C\u002Fth\u003E\u003Cth\u003EJava Type\u003C\u002Fth\u003E\u003Cth\u003EPython Type[2]\u003C\u002Fth\u003E\u003Cth\u003EGo Type\u003C\u002Fth\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Efloat\u003C\u002Ftd\u003E\u003Ctd\u003E固定4个字节\u003C\u002Ftd\u003E\u003Ctd\u003Efloat\u003C\u002Ftd\u003E\u003Ctd\u003Efloat\u003C\u002Ftd\u003E\u003Ctd\u003Efloat\u003C\u002Ftd\u003E\u003Ctd\u003Efloat32\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Edouble\u003C\u002Ftd\u003E\u003Ctd\u003E固定8个字节\u003C\u002Ftd\u003E\u003Ctd\u003Edouble\u003C\u002Ftd\u003E\u003Ctd\u003Edouble\u003C\u002Ftd\u003E\u003Ctd\u003Efloat\u003C\u002Ftd\u003E\u003Ctd\u003Efloat64\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003Ctd\u003Evarint编码\u003C\u002Ftd\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Euint32\u003C\u002Ftd\u003E\u003Ctd\u003Evarint编码\u003C\u002Ftd\u003E\u003Ctd\u003Euint32\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u002Flong\u003C\u002Ftd\u003E\u003Ctd\u003Euint32\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Euint64\u003C\u002Ftd\u003E\u003Ctd\u003Evarint编码\u003C\u002Ftd\u003E\u003Ctd\u003Euint64\u003C\u002Ftd\u003E\u003Ctd\u003Elong\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u002Flong\u003C\u002Ftd\u003E\u003Ctd\u003Euint64\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Esint32\u003C\u002Ftd\u003E\u003Ctd\u003Ezigzag 和 varint编码\u003C\u002Ftd\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Esint64\u003C\u002Ftd\u003E\u003Ctd\u003Ezigzag 和 varint编码\u003C\u002Ftd\u003E\u003Ctd\u003Eint64\u003C\u002Ftd\u003E\u003Ctd\u003Elong\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u002Flong\u003C\u002Ftd\u003E\u003Ctd\u003Eint64\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Efixed32\u003C\u002Ftd\u003E\u003Ctd\u003E固定4个字节\u003C\u002Ftd\u003E\u003Ctd\u003Euint32\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Euint32\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Efixed64\u003C\u002Ftd\u003E\u003Ctd\u003E固定8个字节\u003C\u002Ftd\u003E\u003Ctd\u003Euint64\u003C\u002Ftd\u003E\u003Ctd\u003Elong\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u002Flong\u003C\u002Ftd\u003E\u003Ctd\u003Euint64\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Esfixed32\u003C\u002Ftd\u003E\u003Ctd\u003E固定4个字节\u003C\u002Ftd\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u003C\u002Ftd\u003E\u003Ctd\u003Eint32\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Esfixed64\u003C\u002Ftd\u003E\u003Ctd\u003E固定8个字节\u003C\u002Ftd\u003E\u003Ctd\u003Eint64\u003C\u002Ftd\u003E\u003Ctd\u003Elong\u003C\u002Ftd\u003E\u003Ctd\u003Eint\u002Flong\u003C\u002Ftd\u003E\u003Ctd\u003Eint64\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Ebool\u003C\u002Ftd\u003E\u003Ctd\u003E固定一个字节\u003C\u002Ftd\u003E\u003Ctd\u003Ebool\u003C\u002Ftd\u003E\u003Ctd\u003Eboolean\u003C\u002Ftd\u003E\u003Ctd\u003Ebool\u003C\u002Ftd\u003E\u003Ctd\u003Ebool\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Estring\u003C\u002Ftd\u003E\u003Ctd\u003ELenth-Delimited\u003C\u002Ftd\u003E\u003Ctd\u003Euint64\u003C\u002Ftd\u003E\u003Ctd\u003EString\u003C\u002Ftd\u003E\u003Ctd\u003Estr\u002Funicode\u003C\u002Ftd\u003E\u003Ctd\u003Estring\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Ebytes\u003C\u002Ftd\u003E\u003Ctd\u003ELenth-Delimited\u003C\u002Ftd\u003E\u003Ctd\u003Estring\u003C\u002Ftd\u003E\u003Ctd\u003EByteString\u003C\u002Ftd\u003E\u003Ctd\u003Estr\u003C\u002Ftd\u003E\u003Ctd\u003E[]byte\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003Ebytes\u003C\u002Ftd\u003E\u003Ctd\u003ELenth-Delimited\u003C\u002Ftd\u003E\u003Ctd\u003Estring\u003C\u002Ftd\u003E\u003Ctd\u003EByteString\u003C\u002Ftd\u003E\u003Ctd\u003Estr\u003C\u002Ftd\u003E\u003Ctd\u003E[]byte\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003Cblockquote data-pid=\"SbhGhNfw\"\u003E⚡ 注：这里读者先有个大概的印象，后面会详细介绍每个数据类型。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E5 Protobuf 编码方法\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"N4w9zWWy\"\u003E在详细介绍 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 的数据类型之前，这里先了解一下 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 的编码，在后面介绍每个数据类型的时候会用到这些知识点。\u003C\u002Fp\u003E\u003Ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Cth\u003Ewire-type\u003C\u002Fth\u003E\u003Cth\u003E名称\u003C\u002Fth\u003E\u003Cth\u003E说明\u003C\u002Fth\u003E\u003Cth\u003E类型\u003C\u002Fth\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E0\u003C\u002Ftd\u003E\u003Ctd\u003EVarint\u003C\u002Ftd\u003E\u003Ctd\u003E可变长整形\u003C\u002Ftd\u003E\u003Ctd\u003E非ZigZag编码类型：int32, uint32, int64, uint64, bool, enum；\u003Cbr\u002F\u003EZigZag编码类型：sint32, sint64\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E1\u003C\u002Ftd\u003E\u003Ctd\u003E64-bits\u003C\u002Ftd\u003E\u003Ctd\u003E固定8个字节大小\u003C\u002Ftd\u003E\u003Ctd\u003Efixed64, sfixed64, double\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E2\u003C\u002Ftd\u003E\u003Ctd\u003ELength-delimited\u003C\u002Ftd\u003E\u003Ctd\u003ELength + Body方式\u003C\u002Ftd\u003E\u003Ctd\u003Estring, bytes, embedding message, packed repeated fields\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E5\u003C\u002Ftd\u003E\u003Ctd\u003E32-bits\u003C\u002Ftd\u003E\u003Ctd\u003E固定4个字节大小\u003C\u002Ftd\u003E\u003Ctd\u003Efixed32, sfixed32, float\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003Cblockquote data-pid=\"SPulhCha\"\u003E⚡ 注意：wire_type 为 3、4 的编码类型官方已经弃用，所以这里也不在介绍。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E5.1 Varint\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Ch3\u003E\u003Cb\u003E5.1.1 Varint 是什么？\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp data-pid=\"hv5kL6F6\"\u003E\u003Ccode\u003EVarint\u003C\u002Fcode\u003E  编码是一种可变长的编码方式，值越小的数字，使用越少的字节数表示。它的原理是通过减少表示数字的字节数从而实现数据体积压缩。\u003C\u002Fp\u003E\u003Cp data-pid=\"boN_2bAF\"\u003E首先，先理解几个概念，因为后面需要用到这些概念：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"hyvqnDIz\"\u003E\u003Cb\u003Efield-number\u003C\u002Fb\u003E：如以下 \u003Ccode\u003Emessage\u003C\u002Fcode\u003E 中的最后一列的数字；\u003C\u002Fli\u003E\u003Cli data-pid=\"d0i5K-zt\"\u003E\u003Cb\u003Ewire-type\u003C\u002Fb\u003E：编码类型，比如 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 的编码类型为 0；\u003C\u002Fli\u003E\u003Cli data-pid=\"HaOMU8zS\"\u003E\u003Cb\u003Emsb\u003C\u002Fb\u003E：全称 \u003Ccode\u003Emost significant bit\u003C\u002Fcode\u003E，指的是每个字节的最高位 （例如：\u003Ccode\u003E0x80\u003C\u002Fcode\u003E 的 二进制是 \u003Ccode\u003E10000000\u003C\u002Fcode\u003E，其最高位是 1，即 msb 为 1）。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"fW7afuZ3\"\u003E然后，我们看 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 是怎样编码的，先了解一下 \u003Ccode\u003ETag信息\u003C\u002Fcode\u003E 和 \u003Ccode\u003EData信息\u003C\u002Fcode\u003E：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"J-4vth8S\"\u003E\u003Cb\u003ETag 信息\u003C\u002Fb\u003E：主要存储 \u003Ccode\u003Efield-number\u003C\u002Fcode\u003E 和 \u003Ccode\u003Ewire-type\u003C\u002Fcode\u003E；\u003C\u002Fli\u003E\u003Cli data-pid=\"VdsXrS8A\"\u003E\u003Cb\u003EData 信息\u003C\u002Fb\u003E：编码后的序列。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cblockquote data-pid=\"RxvgPKFz\"\u003EVarint 编码序列 = Tag信息  + Data信息。\u003C\u002Fblockquote\u003E\u003Ch3\u003E\u003Cb\u003E5.1.2 Tag 信息\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp data-pid=\"Cu61oH6U\"\u003E使用一个字节来表示 Tag 信息，高 5 位表示 \u003Ccode\u003Efield-number\u003C\u002Fcode\u003E，低 3 位表示 \u003Ccode\u003Ewire-type\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E [7] [6] [5] [4] [3] [2]  [1]  [0]\n|&lt;----- field -----&gt;|&lt;-- wire --&gt;|\n        number           type \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cblockquote data-pid=\"zVjtQus6\"\u003E注：这个使用一个字节并非编码后的一个字节，而是编码前的一个字节，编码后可能是两个字节。为什么呢？因为 计算好 Tag 之后，还要经过 Varint 编码才是最终的编码，即  Tag = VarintEncode( field-number &lt;&lt; 3 | wire_type)。\u003C\u002Fblockquote\u003E\u003Ch3\u003E\u003Cb\u003E5.1.3 Data 信息\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp data-pid=\"mPUWIv-V\"\u003E在 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 中，\u003Ccode\u003Eint\u003C\u002Fcode\u003E 类型的编码是固定的，无论数值大小，都使用固定 \u003Ccode\u003E4\u003C\u002Fcode\u003E 个字节来存储。假如数值为 \u003Ccode\u003E1\u003C\u002Fcode\u003E，二进制为 \u003Ccode\u003E00000000 00000000 00000000 00000001\u003C\u002Fcode\u003E，其实有效值只有最后一个字节 \u003Ccode\u003E00000001\u003C\u002Fcode\u003E，前三个字节是\u003Cb\u003E浪费\u003C\u002Fb\u003E的。\u003C\u002Fp\u003E\u003Cp data-pid=\"vqBc5m35\"\u003E如果使用 \u003Ccode\u003Elength\u003C\u002Fcode\u003E + \u003Ccode\u003Ebody\u003C\u002Fcode\u003E 的方式编码呢？\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"2iCuRESM\"\u003E\u003Ccode\u003Elength\u003C\u002Fcode\u003E 能不能和 \u003Ccode\u003ETag\u003C\u002Fcode\u003E 公用一个字节？整形最大 \u003Ccode\u003E8\u003C\u002Fcode\u003E 个字节，二进制 \u003Ccode\u003E1000\u003C\u002Fcode\u003E，所以需要占用 \u003Ccode\u003E4\u003C\u002Fcode\u003E 位，\u003Ccode\u003Ewire-type\u003C\u002Fcode\u003E不能再压缩了，\u003Ccode\u003Efield-number\u003C\u002Fcode\u003E 压缩之后只剩下 \u003Ccode\u003E1 bit （5 - 4  = 1）\u003C\u002Fcode\u003E，这限制了 \u003Ccode\u003Emessage\u003C\u002Fcode\u003E 中的字段数量，此方案不可行；\u003C\u002Fli\u003E\u003Cli data-pid=\"64mEGa11\"\u003E使用单独字段表示length，那么编码之后为 \u003Ccode\u003E00000001 00000001\u003C\u002Fcode\u003E，第一个\u003Ccode\u003E00000001\u003C\u002Fcode\u003E 为 \u003Ccode\u003Elength\u003C\u002Fcode\u003E，第二个为值，加上 \u003Ccode\u003ETag\u003C\u002Fcode\u003E 一个字节，总共 \u003Ccode\u003E3\u003C\u002Fcode\u003E 个字节。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"7pnVIJs2\"\u003E但是，\u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码可以做到总共可以只用 \u003Ccode\u003E2\u003C\u002Fcode\u003E 个字节来表示值  \u003Ccode\u003E1\u003C\u002Fcode\u003E。这是怎么做到的？\u003C\u002Fp\u003E\u003Cblockquote data-pid=\"LE1aNOdG\"\u003E注：Varint的每个字节只有低7位存储数据，最高位（即msb）作为标志位，0 代表后面没有再跟字节了，1 代表后面的字节还是属于当前字段的，可以继续读一个字节，以此类推 ……。\u003C\u002Fblockquote\u003E\u003Cp data-pid=\"mJXpgmyr\"\u003E\u003Ccode\u003E1\u003C\u002Fcode\u003E 的 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码的 \u003Ccode\u003Edata\u003C\u002Fcode\u003E 为 \u003Ccode\u003E00000001\u003C\u002Fcode\u003E，即\u003Ccode\u003E0（msb） + 0000001\u003C\u002Fcode\u003E（低 \u003Ccode\u003E7\u003C\u002Fcode\u003E 位）。\u003C\u002Fp\u003E\u003Cp data-pid=\"poIn2Vq6\"\u003E下面详细分析该编码。\u003C\u002Fp\u003E\u003Cp data-pid=\"uCkpCM3z\"\u003E在 「基于 Protobuf 的编程示例」一节的示例中，\u003Ccode\u003Eint32\u003C\u002Fcode\u003E 类型的 \u003Ccode\u003Ei32\u003C\u002Fcode\u003E 字段（\u003Ccode\u003Efield-number\u003C\u002Fcode\u003E 为 \u003Ccode\u003E1\u003C\u002Fcode\u003E），其值为 \u003Ccode\u003E300\u003C\u002Fcode\u003E 的时候，编码结果为 \u003Ccode\u003E08 ac 02\u003C\u002Fcode\u003E，怎么得来的？\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E比如这个int32类型字段的值为300，那么序列化之后：\n08 ac 02\n |  |__|___ 值\n |_________ 元数据 (field-number &lt;&lt; 3 | wire-type) = (1 &lt;&lt; 3 | 0) = 0x08\n​\nac 02 是怎么得来的？\n​\ni32的值为 300\n|__ 0x012c             \u002F\u002F十六进制\n|__ 00000001 00101100  \u002F\u002F二进制\n|__ 0000000100101100   \u002F\u002F合并\n|__ 00 0000010 0101100 \u002F\u002F重新按7位一组切割\n|__ 0000010 0101100    \u002F\u002F高位全0的组省略\n|__ 0101100 0000010    \u002F\u002F逆序，因为使用小端字节序，\n|__ 10101100 00000010  \u002F\u002F每一组加上msb，除了最后一组是msb是0，其他的都为1\n|__ ac 02               \u002F\u002F十六进制\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cblockquote data-pid=\"hRldp8ws\"\u003E⚡  注：\u003Cbr\u002F\u003E计算机硬件有两种储存数据的方式：大端字节序（big endian）和小端字节序（little endian）。\u003Cbr\u002F\u003E举例来说，数值\u003Ccode\u003E0x2211\u003C\u002Fcode\u003E使用两个字节储存：高位字节是\u003Ccode\u003E0x22\u003C\u002Fcode\u003E，低位字节是\u003Ccode\u003E0x11\u003C\u002Fcode\u003E。\u003Cbr\u002F\u003E大端字节序：高位字节在前，低位字节在后，这是人类读写数值的方法，即以\u003Ccode\u003E0x2211\u003C\u002Fcode\u003E形式存储；\u003Cbr\u002F\u003E小端字节序：低位字节在前，高位字节在后，即以\u003Ccode\u003E0x1122\u003C\u002Fcode\u003E形式储存。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E5.2 ZigZag 编码\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Ch3\u003E\u003Cb\u003E5.2.1 ZigZag 编码解决了什么问题？\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp data-pid=\"lvTwWuF4\"\u003E\u003Cb\u003E先看下背景\u003C\u002Fb\u003E。假如 \u003Ccode\u003Eint32\u003C\u002Fcode\u003E 类型的字段，其值为 \u003Ccode\u003E-1\u003C\u002Fcode\u003E 时，在内存中，因为使用了补码，所以存储为 \u003Ccode\u003Effffffff\u003C\u002Fcode\u003E（4个字节），然后在 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 序列化的之前会强制转换成 \u003Ccode\u003Eint64\u003C\u002Fcode\u003E 类型，这样其值会变为\u003Ccode\u003Effffffff ffffffff\u003C\u002Fcode\u003E。转换成 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码时，会加上 \u003Ccode\u003ETag\u003C\u002Fcode\u003E ，以及 \u003Ccode\u003Emsb\u003C\u002Fcode\u003E ，总共是 \u003Ccode\u003E10\u003C\u002Fcode\u003E 个字节。我们希望其绝对值越小，编码之后使用越少的字节数表示，显然这里编码之后得到的结果和我们期望的结果相悖的，基于这样的原因，才引入了 \u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编码，主要作用是对负数的压缩处理。\u003C\u002Fp\u003E\u003Ch3\u003E\u003Cb\u003E5.2.2 ZigZag是怎么编码的？\u003C\u002Fb\u003E\u003C\u002Fh3\u003E\u003Cp data-pid=\"fBaxFlkh\"\u003E很简单，两个公式就搞定了，没有复杂的编码转换。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"n\"\u003Ezigzag32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003En\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003En\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E^\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003En\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E31\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002F对于 sint32\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ezigzag64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003En\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003En\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E^\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003En\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&gt;&gt;\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E63\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E)\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002F对于 sint64\n\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"Q6gUQwKY\"\u003E一般情况下我们认为，使用较多的是小整数（确切地说应该是绝对值小的整数），那么较小的整数应使用更少的字节数来编码，\u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编码正是如此，如下表格：\u003C\u002Fp\u003E\u003Ctable data-draft-node=\"block\" data-draft-type=\"table\" data-size=\"normal\" data-row-style=\"normal\"\u003E\u003Ctbody\u003E\u003Ctr\u003E\u003Cth\u003En\u003C\u002Fth\u003E\u003Cth\u003E十六进制\u003C\u002Fth\u003E\u003Cth\u003Ezigzag(n)\u003C\u002Fth\u003E\u003Cth\u003Evarint(zigzag(n))\u003C\u002Fth\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E0\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 00\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 00\u003C\u002Ftd\u003E\u003Ctd\u003E00\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E-1\u003C\u002Ftd\u003E\u003Ctd\u003Eff ff ff ff\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 01\u003C\u002Ftd\u003E\u003Ctd\u003E01\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E1\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 01\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 02\u003C\u002Ftd\u003E\u003Ctd\u003E02\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E-2\u003C\u002Ftd\u003E\u003Ctd\u003Eff ff ff fe\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 03\u003C\u002Ftd\u003E\u003Ctd\u003E03\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E2\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 02\u003C\u002Ftd\u003E\u003Ctd\u003E00 00 00 04\u003C\u002Ftd\u003E\u003Ctd\u003E04\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E...\u003C\u002Ftd\u003E\u003Ctd\u003E...\u003C\u002Ftd\u003E\u003Ctd\u003E...\u003C\u002Ftd\u003E\u003Ctd\u003E...\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E2147483647\u003C\u002Ftd\u003E\u003Ctd\u003E7f ff ff ff\u003C\u002Ftd\u003E\u003Ctd\u003Eff ff ff fe\u003C\u002Ftd\u003E\u003Ctd\u003Eff ff ff fe\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003Ctr\u003E\u003Ctd\u003E-2147483648\u003C\u002Ftd\u003E\u003Ctd\u003E80 00 00 00\u003C\u002Ftd\u003E\u003Ctd\u003Eff ff ff ff\u003C\u002Ftd\u003E\u003Ctd\u003Eff ff ff ff\u003C\u002Ftd\u003E\u003C\u002Ftr\u003E\u003C\u002Ftbody\u003E\u003C\u002Ftable\u003E\u003Ch2\u003E\u003Cb\u003E5.3 Length-delimited\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"UcywhwAU\"\u003E这种编码很容易理解，就是 \u003Ccode\u003Elength + body\u003C\u002Fcode\u003E 的方式，使用一个 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 类型表示 \u003Ccode\u003Elength\u003C\u002Fcode\u003E，然后 \u003Ccode\u003Elength\u003C\u002Fcode\u003E 的后面接着 \u003Ccode\u003Elength\u003C\u002Fcode\u003E 个字节的内容。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   string str = 14;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;string&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 14, wire_type = 5 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"U_ZDAJAH\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E72\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E06\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E73\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E74\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E72\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E69\u003C\u002Fspan\u003E 6e \u003Cspan class=\"m\"\u003E67\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"eKW408RR\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E72 06 73 74 72 69 6e 67\n|  |  s  t  r  i  n  g\n|  |  |__|__|__|__|__|__ body 的 ASCII 码\n|  |__ length = 6 = 0x06\n|__ Tag (field-number &lt;&lt; 3 | wire-type) = (14 &lt;&lt; 3 | 5) = 114 = 0x72\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch2\u003E\u003Cb\u003E6 如何正确使用每种类型\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Ch2\u003E\u003Cb\u003E6.1 int32\u002Fuint32\u002Fsint32\u002Fint64\u002Fuint64\u002Fsint64\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"D56vUEHV\"\u003E\u003Cb\u003E测试 - 1\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 1, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 2, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_u32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 3, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_u64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 4, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_si32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 5, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_si64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 6, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"9pDx6tw3\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E10\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E18\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E20\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E28\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E30\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E04\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"hgqVGC7C\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E08 01  |__ i32\n10 02  |__ i64\n18 01  |__ u32\n20 02  |__ u64\n28 02  |__ si32\n30 04  |__ si64\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"Qhen-ZhB\"\u003E\u003Cb\u003E测试 - 2\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 1, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 2, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_u32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 3, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_u64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 4, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_si32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 5, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_si64\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 6, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"nmNFttcS\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E ff ff ff ff ff ff ff ff ff \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E10\u003C\u002Fspan\u003E fe ff ff ff ff ff ff ff ff \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E18\u003C\u002Fspan\u003E ff ff ff ff 0f \u003Cspan class=\"m\"\u003E20\u003C\u002Fspan\u003E fe ff ff ff ff ff ff ff ff \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E28\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E30\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E03\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"ujmTmAsH\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E08 ff ff ff ff ff ff ff ff ff 01  |___ i32\n10 fe ff ff ff ff ff ff ff ff 01  |___ i64\n18 ff ff ff ff 0f                 |___ u32\n20 fe ff ff ff ff ff ff ff ff 01  |___ u64\n28 01                             |___ si32\n30 03                             |___ si64\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"uVpRrTRG\"\u003E\u003Cb\u003E如何选型？\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"tMj5oUZq\"\u003E从编码步骤来看：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"JLUbs-k5\"\u003E\u003Ccode\u003Eint32\u002Fuint32\u002Fint64\u002Fuint64\u003C\u002Fcode\u003E：直接进行 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码；\u003C\u002Fli\u003E\u003Cli data-pid=\"kp_Ls9tN\"\u003E\u003Ccode\u003Esint32\u002Fsint64\u003C\u002Fcode\u003E：先进行 \u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编号，然后再对前者结果进行 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码，多了一个步骤。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"pHqKfUTT\"\u003E从编码结果字节数来看：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"FPNin88Z\"\u003E\u003Ccode\u003Eint32\u002Fint64\u003C\u002Fcode\u003E：横向比较 \u003Ccode\u003Eint32\u003C\u002Fcode\u003E 和 \u003Ccode\u003Eint64\u003C\u002Fcode\u003E 编码结果一样，但是 \u003Ccode\u003Eint64\u003C\u002Fcode\u003E 能够表示更大的数；\u003C\u002Fli\u003E\u003Cli data-pid=\"PnLarWYm\"\u003E\u003Ccode\u003Euint32\u002Fuint64\u003C\u002Fcode\u003E：横向比较 \u003Ccode\u003Euint32\u003C\u002Fcode\u003E 和 \u003Ccode\u003Euint64\u003C\u002Fcode\u003E 编码结果一样，但是 \u003Ccode\u003Euint64\u003C\u002Fcode\u003E 能够表示更大的数；\u003C\u002Fli\u003E\u003Cli data-pid=\"qoH_H2a9\"\u003E\u003Ccode\u003Esint32\u002Fsint64\u003C\u002Fcode\u003E：横向比较 \u003Ccode\u003Esint32\u003C\u002Fcode\u003E 和 \u003Ccode\u003Esint64\u003C\u002Fcode\u003E 编码结果一样，但是 \u003Ccode\u003Esint64\u003C\u002Fcode\u003E 能够表示更大的数；\u003C\u002Fli\u003E\u003Cli data-pid=\"dHlV-epe\"\u003E纵向比较：正数的时候，编码都一样，反而 \u003Ccode\u003Esint32\u003C\u002Fcode\u003E 和 \u003Ccode\u003Esint64\u003C\u002Fcode\u003E 多了一个步骤（\u003Ccode\u003EZigZag\u003C\u002Fcode\u003E编码），但是负数的情况 \u003Ccode\u003Esint32\u003C\u002Fcode\u003E 和 \u003Ccode\u003Esint64\u003C\u002Fcode\u003E 使用的字节数较少。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"sG_qu7kQ\"\u003E综上所述，这样选型：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"pbcZfS41\"\u003E如果确定是正数：\u003Cbr\u002F\u003E\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"ydr82aqb\"\u003E如果数值确定小于等于 \u003Ccode\u003EUINT32_MAX\u003C\u002Fcode\u003E，可以用 \u003Ccode\u003Euint32\u003C\u002Fcode\u003E；\u003C\u002Fli\u003E\u003Cli data-pid=\"Q-TN-YCT\"\u003E如果数值可能大于 \u003Ccode\u003EUINT32_MAX\u003C\u002Fcode\u003E，则可以用 \u003Ccode\u003Euint64\u003C\u002Fcode\u003E；\u003C\u002Fli\u003E\u003Cli data-pid=\"lyU8QxQL\"\u003E虽然序列化后结果一样，但是考虑到前者可能在内存分配上会少一点，这里说“可能”，是因为还和内存对齐有关系）。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"Sl0oVREv\"\u003E如果可能是负数，其ZigZag编码之后确定是正数：\u003Cbr\u002F\u003E\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"uwDtckkf\"\u003E如果ZigZag编码后的值确定小于等于 \u003Ccode\u003EINT32_MAX\u003C\u002Fcode\u003E 且大于等于 \u003Ccode\u003EINT32_MIN\u003C\u002Fcode\u003E，可以用 \u003Ccode\u003Esint32\u003C\u002Fcode\u003E；\u003C\u002Fli\u003E\u003Cli data-pid=\"7dpslEcY\"\u003E如果ZigZag编码后的值确定可能大于 \u003Ccode\u003EINT32_MAX\u003C\u002Fcode\u003E 或者 \u003Ccode\u003E小于 INT32_MIN\u003C\u002Fcode\u003E，则用 \u003Ccode\u003Esint64\u003C\u002Fcode\u003E；\u003C\u002Fli\u003E\u003Cli data-pid=\"070Aucze\"\u003E虽然序列化后结果一样，但是考虑到前者可能在内存分配上会少一点，这里说“可能”，是因为还和内存对齐有关系）。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003C\u002Ful\u003E\u003Cblockquote data-pid=\"l1eGSsDI\"\u003E⚡ 注：到这里，如果是对 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 比较了解的读者，可能已经发现，以上少考虑了一种情况。因为 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码后的每个字节只有低 \u003Ccode\u003E7\u003C\u002Fcode\u003E 位表示 数据（最高位是 \u003Ccode\u003Emsb\u003C\u002Fcode\u003E），那样的话，\u003Ccode\u003E4\u003C\u002Fcode\u003E 个字节能够表示的最大数为 \u003Ccode\u003E2^28 - 1\u003C\u002Fcode\u003E（不考虑符号），\u003Ccode\u003E8\u003C\u002Fcode\u003E 个字节能够表示的最大数为 \u003Ccode\u003E2^56 - 1\u003C\u002Fcode\u003E（不考虑符号）。\u003Cbr\u002F\u003E\u003Ccode\u003EC++\u003C\u002Fcode\u003E 中的 \u003Ccode\u003Euint32_t\u003C\u002Fcode\u003E  可以表示的最大数为  \u003Ccode\u003E2^32-1\u003C\u002Fcode\u003E，\u003Ccode\u003Euint64_t\u003C\u002Fcode\u003E 可以表示的最大数为 \u003Ccode\u003E2^64 - 1\u003C\u002Fcode\u003E，那岂不是说在值 大于 \u003Ccode\u003E2^28 - 1\u003C\u002Fcode\u003E 或者 \u003Ccode\u003E2^56 - 1\u003C\u002Fcode\u003E 的情况下，其 \u003Ccode\u003EProtobuf\u003C\u002Fcode\u003E 编码后字节数还比对应的 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 类型的字节数还多了？\u003Cbr\u002F\u003E在 「6.2 fixed32\u002Fsfixed32\u002Ffixed64\u002Fsfixed64」中就提供了解决方案。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E6.2 fixed32\u002Fsfixed32\u002Ffixed64\u002Fsfixed64\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"q88bbDxq\"\u003E\u003Ccode\u003Efixed32\u002Ffixed64\u003C\u002Fcode\u003E 分别对应 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 类型的 \u003Ccode\u003Euint32_t\u003C\u002Fcode\u003E 和 \u003Ccode\u003Euint64_t\u003C\u002Fcode\u003E，\u003Ccode\u003Esfixed32\u002Fsfixed64\u003C\u002Fcode\u003E 分别对应 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 类型的 \u003Ccode\u003Eint32_t\u003C\u002Fcode\u003E 和 \u003Ccode\u003Eint64_t\u003C\u002Fcode\u003E。没有经过任何编码，分别使用固定的 \u003Ccode\u003E4\u003C\u002Fcode\u003E 个字节 和 \u003Ccode\u003E8\u003C\u002Fcode\u003E 个字节表示该值。\u003C\u002Fp\u003E\u003Cp data-pid=\"HWR7faqQ\"\u003E\u003Ccode\u003Esfixed32\u002Fsfixed64\u003C\u002Fcode\u003E 也是分别使用了固定 \u003Ccode\u003E4\u003C\u002Fcode\u003E 个字节 和 \u003Ccode\u003E8\u003C\u002Fcode\u003E 个字节表示该值，只不过先经过 \u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编码然后再存储。\u003C\u002Fp\u003E\u003Cp data-pid=\"Ol2g1H4P\"\u003E综上所述，可以这样选型：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"o0xymBAA\"\u003E如果确定是正数：\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"Smbcp86O\"\u003E如果数值确定小于等于 \u003Ccode\u003EUINT32_MAX\u003C\u002Fcode\u003E 且大于 \u003Ccode\u003E2^28-1\u003C\u002Fcode\u003E，可以用 \u003Ccode\u003Efixed32\u003C\u002Fcode\u003E（比如：这是一个表示时间戳的字段）；\u003C\u002Fli\u003E\u003Cli data-pid=\"JsUBXpIZ\"\u003E如果数值确定可能大于 \u003Ccode\u003E2^56-1\u003C\u002Fcode\u003E，则可以用 \u003Ccode\u003Efixed64\u003C\u002Fcode\u003E（比如纯数字订单号：\u003Ccode\u003E2021083011405200001\u003C\u002Fcode\u003E，\u003Ccode\u003E20210830\u003C\u002Fcode\u003E（日期）+\u003Ccode\u003E114052\u003C\u002Fcode\u003E（时间）+ \u003Ccode\u003E00001\u003C\u002Fcode\u003E（\u003Ccode\u003E5\u003C\u002Fcode\u003E 位系列号））\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cli data-pid=\"kKpKsyPN\"\u003E如果可能是负数，其 \u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编码后确定是正数：\u003C\u002Fli\u003E\u003Cul\u003E\u003Cli data-pid=\"JgWRJhh4\"\u003E如果 \u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编码后的值确定小于等于 \u003Ccode\u003EINT32_MAX\u003C\u002Fcode\u003E 且大于 \u003Ccode\u003E2^28-1\u003C\u002Fcode\u003E，可以用 \u003Ccode\u003Esfixed32\u003C\u002Fcode\u003E；\u003C\u002Fli\u003E\u003Cli data-pid=\"CODua6bT\"\u003E如果 \u003Ccode\u003EZigZag\u003C\u002Fcode\u003E 编码后的值确定可能大于 \u003Ccode\u003E2^56-1\u003C\u002Fcode\u003E，则可以用 \u003Ccode\u003Esfixed64\u003C\u002Fcode\u003E。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003C\u002Ful\u003E\u003Ch2\u003E\u003Cb\u003E6.3 float\u002Fdouble\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"yAat-hAy\"\u003E\u003Ccode\u003Efloat\u003C\u002Fcode\u003E 是使用固定 \u003Ccode\u003E4\u003C\u002Fcode\u003E 个字节来表示浮点数，\u003Ccode\u003Edouble\u003C\u002Fcode\u003E 是使用固定 \u003Ccode\u003E8\u003C\u002Fcode\u003E 个字节来表示浮点数。\u003C\u002Fp\u003E\u003Cp data-pid=\"ImWsfOOf\"\u003E有时候我们可以灵活一点，不一定需要用浮点数的类型类表示浮点数，比如有这样一个需求：使用一个字段来表示分数，满分一分，有效值扩展到小数点后 \u003Ccode\u003E2\u003C\u002Fcode\u003E 位小数（如：\u003Ccode\u003E99.98\u003C\u002Fcode\u003E分），如果使用 \u003Ccode\u003Efloat\u003C\u002Fcode\u003E 编码结果为 \u003Ccode\u003E5\u003C\u002Fcode\u003E 个字节（\u003Ccode\u003ETag\u003C\u002Fcode\u003E \u003Ccode\u003E1\u003C\u002Fcode\u003E个字节 + 固定 \u003Ccode\u003E4\u003C\u002Fcode\u003E 个字节）。\u003C\u002Fp\u003E\u003Cp data-pid=\"YStpraKw\"\u003E我们换一种思路，把分数转换成整型（如：\u003Ccode\u003E9998\u003C\u002Fcode\u003E），选型为 \u003Ccode\u003Eint32\u003C\u002Fcode\u003E，那么使用的是 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 编码，最后的结果只需 \u003Ccode\u003E3\u003C\u002Fcode\u003E 个字节。\u003C\u002Fp\u003E\u003Cp data-pid=\"GkVhR6jt\"\u003E\u003Cb\u003E测试-1\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   int32 i32 = 1;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   float fl  = 12;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * }\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E9998\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E     \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 1, wire_type = 0 (varint)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_fl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mf\"\u003E99.98\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E     \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 12, wire_type = 5 (float)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"ZD_waLtN\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E 8e 4e \u003Cspan class=\"m\"\u003E65\u003C\u002Fspan\u003E c3 f5 c7 \u003Cspan class=\"m\"\u003E42\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"gSbTv333\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E08 8e 4e        |__ i32\n65 c3 f5 c7 42  |__ fl\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"lH3POCSQ\"\u003E\u003Ccode\u003Edouble\u003C\u002Fcode\u003E 也是按同样的思路分析，这里就不再细抠图。\u003C\u002Fp\u003E\u003Ch2\u003E\u003Cb\u003E6.4 string\u002Fbytes\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"arLx-0Zy\"\u003E\u003Ccode\u003Estring\u003C\u002Fcode\u003E 和 \u003Ccode\u003Ebytes\u003C\u002Fcode\u003E 都是字符串，使用了 \u003Ccode\u003ELength-delimited\u003C\u002Fcode\u003E 的编码方式，见「5.3 Length-delimited」。但是string会做 字符串编码检查，仅支持\u003Ccode\u003EUTF-8\u003C\u002Fcode\u003E编码或者\u003Ccode\u003E7-bit ASCII\u003C\u002Fcode\u003E编码的文本，而 \u003Ccode\u003Ebytes\u003C\u002Fcode\u003E 可以是任意字符串。\u003C\u002Fp\u003E\u003Ch2\u003E\u003Cb\u003E6.5 repeated\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"60FLWZp_\"\u003E\u003Ccode\u003Erepeated\u003C\u002Fcode\u003E 顾名思义，是重复这个字段，其主要是补充数组功能这块的空白，类似于 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 语言中的 \u003Ccode\u003Evector\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\u003Cp data-pid=\"giUYqyT8\"\u003E\u003Ccode\u003Erepeated\u003C\u002Fcode\u003E 使用了 \u003Ccode\u003ELength-delimited\u003C\u002Fcode\u003E 的编码方式，见「5.3 Length-delimited」。先看一下它的序列化模型：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003ETag\u003Cspan class=\"o\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003ELength\u003Cspan class=\"o\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003EData-1\u003Cspan class=\"o\"\u003E][\u003C\u002Fspan\u003EData-2\u003Cspan class=\"o\"\u003E][\u003C\u002Fspan\u003EData-3\u003Cspan class=\"o\"\u003E]\u003C\u002Fspan\u003E...\u003Cspan class=\"o\"\u003E[\u003C\u002Fspan\u003EData-n\u003Cspan class=\"o\"\u003E]\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"XTccNrpy\"\u003E\u003Cb\u003E测试 - 1\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   repeated int32 vec = 16;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eadd_vec\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 16, wire_type = 2 (Length-Delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eadd_vec\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 16, wire_type = 2 (Length-Delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"suQP_czQ\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E82\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"Vf9BNsd8\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E82 01  |__ Tag\n02     |__ Length\n01 02  |__ 值 1 和 2\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"HK-o2hlT\"\u003E\u003Cb\u003E测试 - 2\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   repeated SubTest vec = 16;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eadd_vec\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 16, wire_type = 2 (Length-Delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eadd_vec\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 16, wire_type = 2 (Length-Delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"27iI12V2\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E82\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E82\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"1u9F32zh\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E82 01 02 08 01 \u002F\u002Fvec[0]\n82 01  |__ Tag\n02     |__ Length\n08 01  |__ Subtest值, 08-&gt; Tag, 01 -&gt; 值\n​\n82 01 02 08 02 \u002F\u002Fvec[1]\n82 01  |__ Tag\n02     |__ Length\n08 02  |__ Subtest值, 08-&gt; Tag, 02 -&gt; 值\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"WBwba9h1\"\u003E这里笔者觉得很怪，为什么每个 \u003Ccode\u003Erepeated item\u003C\u002Fcode\u003E 都要重复 \u003Ccode\u003ETag\u003C\u002Fcode\u003E 和 \u003Ccode\u003ELength\u003C\u002Fcode\u003E 呢，这不是会增加无畏的字节码？\u003C\u002Fp\u003E\u003Cblockquote data-pid=\"yku0yMAv\"\u003E❓ 问题：不应该是这种方式编码后体积更小吗？为什么不用这种方法呢？\u003C\u002Fblockquote\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E82 01 02 08 01 08 02\n82 01  |__ Tag\n02     |__ Length\n08 01  |__ vec[0] SubTest值, 08 -&gt; Tag, 01 -&gt; 值\n08 02  |__ vec[1] SubTest值, 08 -&gt; Tag, 02 -&gt; 值\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"f3VB23MN\"\u003E这是因为如果 \u003Ccode\u003Erepeated\u003C\u002Fcode\u003E 类型是基础类型（比如 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E） 时，会做 \u003Ccode\u003Epacked\u003C\u002Fcode\u003E 优化（也就是压缩）。\u003C\u002Fp\u003E\u003Cp data-pid=\"d-i2hypr\"\u003E\u003Cb\u003E综上所述\u003C\u002Fb\u003E：\u003C\u002Fp\u003E\u003Cp data-pid=\"FXSyQjqs\"\u003E如果不是很必要，\u003Ccode\u003Erepeated\u003C\u002Fcode\u003E 不要使用复杂的类型，就使用 \u003Ccode\u003EVarint\u003C\u002Fcode\u003E 的类型就可以了。\u003C\u002Fp\u003E\u003Cp data-pid=\"3y1ZE_T8\"\u003E比如有这样一个需求，需要存储一个列表，列表的 \u003Ccode\u003Eitem\u003C\u002Fcode\u003E 包含两个字段，一个是 \u003Ccode\u003Eappid\u003C\u002Fcode\u003E，一个是整形的 \u003Ccode\u003Escore\u003C\u002Fcode\u003E。那么不建议使用这种：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-protobuf\"\u003E\u003Cspan class=\"kd\"\u003Emessage\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EItem\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Eint64\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eappid\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Eint64\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Escore\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Emessage\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"k\"\u003Erepeated\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003EItem\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evec\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"tjXS6NBj\"\u003E可以使用下面这种（这种序列化知乎包体会小很多，\u003Ccode\u003Evec size\u003C\u002Fcode\u003E 越大，小得越明显）：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-protobuf\"\u003E\u003Cspan class=\"kd\"\u003Emessage\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"k\"\u003Erepeated\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint64\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evec_appid\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"k\"\u003Erepeated\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Eint64\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evec_score\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch2\u003E\u003Cb\u003E6.6 embedding message\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"iFiTeRT8\"\u003E\u003Ccode\u003Eembedding message\u003C\u002Fcode\u003E，也就是 \u003Ccode\u003Emessage\u003C\u002Fcode\u003E 中某个字段的类型是一个 \u003Ccode\u003Emessage\u003C\u002Fcode\u003E 的类型，使用了 \u003Ccode\u003ELength-delimited\u003C\u002Fcode\u003E 编码方式。\u003C\u002Fp\u003E\u003Cp data-pid=\"97YXsIXO\"\u003E\u003Cb\u003E测试 - 1\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message SubTest {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   int32 i32 = 1;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * }\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   SubTest test = 18; \u002F\u002Fembedding message\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 18, wire_type = 2 (Length-delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emutable_test\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"PsR8bZwB\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n\u003Cspan class=\"m\"\u003E92\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"K8kbfHJb\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E92 01   |__ Tag\n02      |__ Length\n08 01   |__ Data, SubTest值, 08 -&gt; Tag, 01 -&gt; 值\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch2\u003E\u003Cb\u003E6.7 map\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"TmAtU1TE\"\u003E\u003Ccode\u003Emap\u003C\u002Fcode\u003E 的底层实现是哈希表。类似 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 语言中的 \u003Ccode\u003Eunordered_map\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\u003Cp data-pid=\"NusIYpjI\"\u003E\u003Ccode\u003Emap\u003C\u002Fcode\u003E 使用了  \u003Ccode\u003ELength-delimited\u003C\u002Fcode\u003E 编码方式。\u003C\u002Fp\u003E\u003Cp data-pid=\"fE94KwBV\"\u003E\u003Cb\u003E测试-1\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   map&lt;int32, int32&gt;  mp = 17;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 17, wire_type = 2 (Length-Delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emutable_mp\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Einsert\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E10\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E});\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emutable_mp\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Einsert\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E11\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E});\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emutable_mp\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Einsert\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E({\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E3\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E12\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E});\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"YPi30Zrh\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\n8a \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E04\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E10\u003C\u002Fspan\u003E 0a 8a \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E04\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E10\u003C\u002Fspan\u003E 0b 8a \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E04\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E03\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E10\u003C\u002Fspan\u003E 0c\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"MZofSf_x\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E 8a 01  04 08 01 10 0a  |__ Key-Value-Group[0]\n |__|   |  |__|  |__|______ Value (10-&gt; Tag ①, 0a -&gt; 值)\n    |   |     |____________ Key   (08-&gt; Tag ②, 01 -&gt; 值)\n    |   |__________________ Length\n    |______________________ Tag\n    \n    ①：10 = 2 &lt;&lt; 3 | 0 = 16 = 0x10 \n       (map的value field-number 固定为 2)\n    ②：08 = 1 &lt;&lt; 3 | 0 = 8 = 0x08 \n       (map的Key field-number 固定为 1)\n \n 8a 01  04 08 02 10 0b  |__ Key-Value-Group[1]\n 8a 01  04 08 03 10 0c  |__ Key-Value-Group[2]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cblockquote data-pid=\"ksjBdWqC\"\u003E⚠️  注：值得注意的是每一组 \u003Ccode\u003Ekey-value\u003C\u002Fcode\u003E 都会带上  \u003Ccode\u003E8a 01\u003C\u002Fcode\u003E  这个 \u003Ccode\u003ETag\u003C\u002Fcode\u003E，以及  \u003Ccode\u003E04\u003C\u002Fcode\u003E  这个 \u003Ccode\u003ELength\u003C\u002Fcode\u003E。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E6.8 any\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cblockquote data-pid=\"DL3ZPLmN\"\u003E源文件：\u003Ccode\u003Einclude\u002Fgoogle\u002Fprotobuf\u002Fany.proto\u003C\u002Fcode\u003E\u003C\u002Fblockquote\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-protobuf\"\u003E\u003Cspan class=\"n\"\u003Esyntax\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;proto3&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kn\"\u003Epackage\u003C\u002Fspan\u003E \u003Cspan class=\"nn\"\u003Egoogle\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eprotobuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ecsharp_namespace\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;Google.Protobuf.WellKnownTypes&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ego_package\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;google.golang.org\u002Fprotobuf\u002Ftypes\u002Fknown\u002Fanypb&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejava_package\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;com.google.protobuf&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejava_outer_classname\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;AnyProto&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ejava_multiple_files\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"kc\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eobjc_class_prefix\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;GPB&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E​\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"kd\"\u003Emessage\u003C\u002Fspan\u003E \u003Cspan class=\"nc\"\u003EAny\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Etype_url\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"kt\"\u003Ebytes\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Evalue\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"a6GW5FPk\"\u003E去掉注释之后，也就一个 \u003Ccode\u003Emessage\u003C\u002Fcode\u003E，\u003Ccode\u003Etype_url\u003C\u002Fcode\u003E 用来存储类型描述信息，\u003Ccode\u003Evalue\u003C\u002Fcode\u003E 用来存储序列化（ \u003Ccode\u003EC++\u003C\u002Fcode\u003E 是\u003Ccode\u003ESerializeToString\u003C\u002Fcode\u003E 函数）之后的字符串。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message SubTest {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   int32 i32 = 1;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * }\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   google.protobuf.Any any = 21;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESubTest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Est1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Est1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Emutable_any\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E-&gt;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003EPackFrom\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Est1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Ffield_number = 21, wire_type = 2 (Lenth-Delimited)\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"c1\"\u003E\u002F\u002Fstd::cout &lt;&lt; t1.any().type_url() &lt;&lt; std::endl;\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"gU7yXxJg\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\naa \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E28\u003C\u002Fspan\u003E 0a \u003Cspan class=\"m\"\u003E22\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E74\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E79\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E70\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E65\u003C\u002Fspan\u003E 2e \u003Cspan class=\"m\"\u003E67\u003C\u002Fspan\u003E 6f 6f \u003Cspan class=\"m\"\u003E67\u003C\u002Fspan\u003E 6c \u003Cspan class=\"m\"\u003E65\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E61\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E70\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E69\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E73\u003C\u002Fspan\u003E 2e \u003Cspan class=\"m\"\u003E63\u003C\u002Fspan\u003E 6f 6d 2f 6d \u003Cspan class=\"m\"\u003E79\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E74\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E65\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E73\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E74\u003C\u002Fspan\u003E 2e \u003Cspan class=\"m\"\u003E53\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E75\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E62\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E54\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E65\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E73\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E74\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E12\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E02\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E08\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"vhgSTvHs\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003Eaa 01           |__ Tag\n28              |__ Length (40个字符)\n0a 22 74 79 70 65 2e 67 6f 6f 67 6c 65 61 70 69 73 2e 63 6f 6d 2f 6d 79 74 65 73 74 2e 53 75 62 54 65 73 74  |__ 第一个字段（string type_url）\n12 02 08 01     |__ 第二个字段（bytes value = 2）\n​\n第一个字段（string type_url）：\n0a              |__ Tag\n22              |__ Length (34个字符)\n74 79 70 65 2e 67 6f 6f 67 6c 65 61 70 69 73 2e 63 6f 6d 2f 6d 79 74 65 73 74 2e 53 75 62 54 65 73 74        |__ 字符串的ASCCII码（以下是对应的字符）\nt  y  p  e  .  g  o  o  g  l  e  a  p  i  s  .  c  o  m  \u002F  m  y  t  e  s  t  .  S  u  b  T  e  s  t\n​\n第二个字段（bytes value = 2）：\n12              |__ Tag\n02              |__ Length\n08 01           |__ mytest::SubTest的编码: 08 -&gt; Tag, 01 -&gt; 值\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cblockquote data-pid=\"43dENhHb\"\u003E⚡ 注：Any 使用到了\u003Ccode\u003Ereflecttion\u003C\u002Fcode\u003E（反射）功能，\u003Ccode\u003EC++\u003C\u002Fcode\u003E 编译链接时不能使用 \u003Ccode\u003E-lprotobuf-lite\u003C\u002Fcode\u003E，而要使用 \u003Ccode\u003E-lprotobuf\u003C\u002Fcode\u003E。相关介绍请见 「7 可选项 optimize_for」。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E6.9 oneof\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"RSoKsV55\"\u003E 如果需求有一条包含许多字段的消息，并且最多同时设置一个字段，那么可以使用 \u003Ccode\u003Eoneof\u003C\u002Fcode\u003E 特性来节省内存。\u003C\u002Fp\u003E\u003Cp data-pid=\"sU68zilg\"\u003E\u003Ccode\u003Eoneof\u003C\u002Fcode\u003E 字段类似于常规字段，除了 \u003Ccode\u003Eoneof\u003C\u002Fcode\u003E 共享内存的所有字段之外，最多可以同时设置一个字段。设置 \u003Ccode\u003Eoneof\u003C\u002Fcode\u003E  的任何成员都会自动清除所有其他成员。可以使用 \u003Ccode\u003Ecase()\u003C\u002Fcode\u003E 或 \u003Ccode\u003EWhichOneof()\u003C\u002Fcode\u003E方法检查 \u003Ccode\u003Eoneof\u003C\u002Fcode\u003E  中的哪个值被设置(如果有的话)，具体取决于您选择的语言。\u003C\u002Fp\u003E\u003Cp data-pid=\"G52fHnar\"\u003E\u003Ccode\u003Eoneof\u003C\u002Fcode\u003E 不能使用 \u003Ccode\u003Erepeated\u003C\u002Fcode\u003E 字段。\u003C\u002Fp\u003E\u003Cp data-pid=\"cU7bwFtl\"\u003E\u003Cb\u003E测试-1\u003C\u002Fb\u003E：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-cpp\"\u003E\u003Cspan class=\"cm\"\u003E\u002F* message Test {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   oneof object {\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *     float   one_fl  = 19;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *     string  one_str = 20;\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E *   }\n\u003C\u002Fspan\u003E\u003Cspan class=\"cm\"\u003E * } *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"k\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"kt\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"nf\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESubTest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Est1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Est1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_i32\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mi\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Emytest\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ETest\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_one_fl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"mf\"\u003E0.1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ecout\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;one_str:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eone_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;, one_fl:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eone_fl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eendl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eset_one_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;string&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ecout\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;one_str:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eone_str\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;, one_fl:&#34;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eone_fl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E&lt;&lt;\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Eendl\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"c1\"\u003E\u002F\u002F optimize_for = LITE_RUNTIME 时会 crash，因为 one_fl 被释放掉。\n\u003C\u002Fspan\u003E\u003Cspan class=\"c1\"\u003E\u003C\u002Fspan\u003E  \u003Cspan class=\"n\"\u003Estd\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E::\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Estring\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Et1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESerializeToString\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"o\"\u003E&amp;\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Edump_hexstring\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"s\"\u003E&#34;==== test_1 ====&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Ebuf\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E);\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"err\"\u003E​\u003C\u002Fspan\u003E\n\u003Cspan class=\"kt\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Emain\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E()\u003C\u002Fspan\u003E \u003Cspan class=\"p\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"n\"\u003Etest_1\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E();\u003C\u002Fspan\u003E\n  \u003Cspan class=\"k\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"mi\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"p\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"TbR9KR5D\"\u003E编译和执行结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003Eone_str:, one_fl:0.1\none_str:string, one_fl:0\n\u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E \u003Cspan class=\"nv\"\u003Etest_1\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E====\u003C\u002Fspan\u003E:\na2 \u003Cspan class=\"m\"\u003E01\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E06\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E73\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E74\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E72\u003C\u002Fspan\u003E \u003Cspan class=\"m\"\u003E69\u003C\u002Fspan\u003E 6e \u003Cspan class=\"m\"\u003E67\u003C\u002Fspan\u003E\n​\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"f-TEOmc1\"\u003E分析结果：\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003Eone_str:, one_fl:0.1\none_str:string, one_fl:0\n| 设置 one_str 的时候，one_fl被清空了，\n| 操作（触发内存分配如执行set_xxx或者mutable_xxxx函数）\n| 任何一个成员的时候，会清空所有其他成员。\n==== test_1 ====:\na2 01 06 73 74 72 69 6e 67\n|__|  |  s  t  r  i  n  g  _____ 字符串\n   |  |_________________________ Length\n   |____________________________ Tag\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Ch2\u003E\u003Cb\u003E7 可选项 optimize_for\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-protobuf\"\u003E\u003Cspan class=\"n\"\u003Esyntax\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"s\"\u003E&#34;proto3&#34;\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\n\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"k\"\u003Eoption\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003Eoptimize_for\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"n\"\u003ESPEED\u003C\u002Fspan\u003E\u003Cspan class=\"p\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"o\"\u003E\u002F\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ESPEED\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E（默认）、\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ECODE_SIZE\u003C\u002Fspan\u003E\u003Cspan class=\"err\"\u003E、\u003C\u002Fspan\u003E\u003Cspan class=\"n\"\u003ELITE_RUNTIME\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"jvZvX3oL\"\u003E\u003Cb\u003ESPEED\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"QnjEUTnT\"\u003E表示生成的代码运行效率高，但是由此生成的代码编译后会占用更多的空间。 \u003C\u002Fp\u003E\u003Cp data-pid=\"Vd2qT8Eb\"\u003E\u003Cb\u003ECODE_SIZE\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"y1XGOX28\"\u003E和SPEED恰恰相反，代码运行效率较低，但是由此生成的代码编译后会占用更少的空间，通常用于资源有限的平台，如移动设备。\u003C\u002Fp\u003E\u003Cp data-pid=\"odQgC9jW\"\u003E\u003Cb\u003ELITE_RUNTIME\u003C\u002Fb\u003E\u003C\u002Fp\u003E\u003Cp data-pid=\"Sa-nZiob\"\u003E生成的代码执行效率高，同时生成代码编译后的所占用的空间也是非常少，但是它会缺少一些属性像 \u003Ccode\u003Ereflection\u003C\u002Fcode\u003E（反射）功能。在 \u003Ccode\u003EC++\u003C\u002Fcode\u003E 中依赖 \u003Ccode\u003Elibprotobuf-lite\u003C\u002Fcode\u003E 库，而非 \u003Ccode\u003Elibprotobuf\u003C\u002Fcode\u003E 库。\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-bash\"\u003E$ \u003Cspan class=\"nb\"\u003Ecd\u003C\u002Fspan\u003E \u002Fusr\u002Flocal\u002FCellar\u002Fprotobuf\u002F3.17.3\u002Flib\u002F\n$ ls -lh *.a\n-r--r--r--  \u003Cspan class=\"m\"\u003E1\u003C\u002Fspan\u003E baron  admin   835K Jun  \u003Cspan class=\"m\"\u003E8\u003C\u002Fspan\u003E 22:15 libprotobuf-lite.a\n-r--r--r--  \u003Cspan class=\"m\"\u003E1\u003C\u002Fspan\u003E baron  admin   4.1M Jun  \u003Cspan class=\"m\"\u003E8\u003C\u002Fspan\u003E 22:15 libprotobuf.a\n...\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cblockquote data-pid=\"d1AInIsu\"\u003E⚡ 注：看 lite 库的体积大小仅仅 非lite库的 1\u002F5 ~ 1\u002F4 左右。\u003C\u002Fblockquote\u003E\u003Ch2\u003E\u003Cb\u003E8 附录\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Ch2\u003E\u003Cb\u003E8.1 补码编码\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"cEDY_WQc\"\u003E我们先来看一下三个概念：源码、反码、补码\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"ieuU_wuh\"\u003E原码：最高位为符号位，剩余位表示绝对值；\u003C\u002Fli\u003E\u003Cli data-pid=\"YCB856Uv\"\u003E反码：除符号位外，对原码剩余位依次取反；\u003C\u002Fli\u003E\u003Cli data-pid=\"lfofuf97\"\u003E补码：正数补码为其自身，负数补码为除符号位外对原码剩余位依次取反然后加1。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp data-pid=\"VF5WZ9Ef\"\u003E如果计算机存储正数时，存储的是原码：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"kXMuuLOb\"\u003E数字 \u003Ccode\u003E0\u003C\u002Fcode\u003E  的表示\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E正数0： [0000 0000]原 \n负数0： [1000 0000]原 \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cul\u003E\u003Cli data-pid=\"7jIyEDzv\"\u003E原码中还存在加法错误的问题\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E1 + (−1) = [0000 0001]原 + [1000 0001]原 = [1000 0010]原 = −2\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"V-o7LS11\"\u003E如果存储的是补码呢？\u003C\u002Fp\u003E\u003Cdiv class=\"highlight\"\u003E\u003Cpre\u003E\u003Ccode class=\"language-text\"\u003E正数0 = 负数0 = [0000 0000]补\n​\n1 + (−1) = [0000 0001]补 + [1111 1111]补 = [0000 0000]补 = 0\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003Cp data-pid=\"cAJ1g-1H\"\u003E没错，计算机存储整数时采用的是\u003Ccode\u003E补码\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\u003Cp data-pid=\"FUChDuez\"\u003E此外，整数的补码有一些有趣的性质：\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli data-pid=\"wTSQZYrD\"\u003E左移 \u003Ccode\u003E1\u003C\u002Fcode\u003E 位（\u003Ccode\u003En &lt;&lt; 1\u003C\u002Fcode\u003E），无论正数还是负数，相当于乘以 \u003Ccode\u003E2\u003C\u002Fcode\u003E ；对于正数，若大于\u003Ccode\u003EMAX_INT\u002F2\u003C\u002Fcode\u003E（\u003Ccode\u003E1076741823\u003C\u002Fcode\u003E），则会发生溢出，导致左移1位后为负数\u003C\u002Fli\u003E\u003Cli data-pid=\"_maZax4I\"\u003E右移 \u003Ccode\u003E31\u003C\u002Fcode\u003E 位（\u003Ccode\u003En &gt;&gt; 31\u003C\u002Fcode\u003E），对于正数，则返回\u003Ccode\u003E0x00000000\u003C\u002Fcode\u003E；对于负数，则返回\u003Ccode\u003E0xffffffff\u003C\u002Fcode\u003E。\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003E\u003Cb\u003E9 参考文献\u003C\u002Fb\u003E\u003C\u002Fh2\u003E\u003Cp data-pid=\"un1kfJq_\"\u003E\u003Ca href=\"https:\u002F\u002Flink.zhihu.com\u002F?target=https%3A\u002F\u002Fdevelopers.google.com\u002Fprotocol-buffers\u002Fdocs\u002Fproto3%23json\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\"\u003ELanguage Guide (proto3)  |  Protocol Buffers  |  Google Developer\u003C\u002Fa\u003E\u003C\u002Fp\u003E","adminClosedComment":false,"topics":[{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19564722","type":"topic","id":"19564722","name":"protobuf"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19552826","type":"topic","id":"19552826","name":"编程语言"},{"url":"https:\u002F\u002Fwww.zhihu.com\u002Fapi\u002Fv4\u002Ftopics\u002F19554298","type":"topic","id":"19554298","name":"编程"}],"voteupCount":20,"voting":0,"heavyUpStatus":"allow_heavy_up","column":{"description":"","canManage":false,"intro":"编程开发、系统架构、开源软件等技术干货分享中 ~","isFollowing":false,"urlToken":"c_1417572457507713024","id":"c_1417572457507713024","articlesCount":10,"acceptSubmission":true,"title":"我和我的架构师","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fc_1417572457507713024","commentPermission":"all","created":1630755611,"updated":1630756239,"imageUrl":"https:\u002F\u002Fpica.zhimg.com\u002F4b70deef7_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6.jpg?source=172ae18b","uid":"811149941132103680","userType":"people","isFollowing":false,"urlToken":"qing-feng-32-87-12","id":"98c41cc0c09fe4fa6e50ac1e1dfc816f","description":"","name":"津的技术专栏","isAdvertiser":false,"headline":"编程开发、系统架构、开源软件等技术干货分享中 ~","gender":1,"url":"\u002Fpeople\u002F98c41cc0c09fe4fa6e50ac1e1dfc816f","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":0,"type":"column"},"commentCount":4,"contributions":[{"id":33519240,"state":"accepted","type":"first_publish","column":{"description":"","canManage":false,"intro":"编程开发、系统架构、开源软件等技术干货分享中 ~","isFollowing":false,"urlToken":"c_1417572457507713024","id":"c_1417572457507713024","articlesCount":10,"acceptSubmission":true,"title":"我和我的架构师","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fc_1417572457507713024","commentPermission":"all","created":1630755611,"updated":1630756239,"imageUrl":"https:\u002F\u002Fpica.zhimg.com\u002F4b70deef7_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6.jpg?source=172ae18b","uid":"811149941132103680","userType":"people","isFollowing":false,"urlToken":"qing-feng-32-87-12","id":"98c41cc0c09fe4fa6e50ac1e1dfc816f","description":"","name":"津的技术专栏","isAdvertiser":false,"headline":"编程开发、系统架构、开源软件等技术干货分享中 ~","gender":1,"url":"\u002Fpeople\u002F98c41cc0c09fe4fa6e50ac1e1dfc816f","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":0,"type":"column"}}],"isTitleImageFullScreen":false,"upvotedFollowees":[],"commercialInfo":{"isCommercial":false,"plugin":{}},"suggestEdit":{"status":false,"reason":"","tip":"","url":"","title":""},"reason":"","annotationAction":[],"canTip":false,"tipjarorsCount":0,"isLabeled":false,"hasPublishingDraft":false,"isFavorited":false,"favlistsCount":70,"isNormal":true,"status":0,"shareText":"深入浅出：如何正确使用 protobuf - 来自知乎专栏「我和我的架构师」，作者: 津的技术专栏 https:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F406832315 （想看更多？下载 @知乎 App：http:\u002F\u002Fweibo.com\u002Fp\u002F100404711598 ）","canComment":{"status":true,"reason":""},"mcnFpShow":-1,"isVisible":true,"isLiked":false,"likedCount":2,"hasColumn":true,"republishers":[],"isNewLinkCard":true,"emojiReaction":{"cryFaceCount":0,"cryFaceHasSet":false,"hugCount":0,"hugHasSet":false,"likeCount":2,"likeHasSet":false,"onlookerCount":0,"onlookerHasSet":false},"abParam":{"qaHiddenVoteup":"1"},"attachedInfo":"kgIkCgkxNzg1Mzc3MzUSCTQwNjgzMjMxNRgHIgpJTUFHRV9URVhU","shareGuide":{"hasPositiveBubble":false,"hasTimeBubble":false,"hitShareGuideCluster":false},"settings":{"tableOfContents":{"enabled":false}},"canReference":false,"reactionInstruction":{}}},"columns":{"c_1417572457507713024":{"description":"","canManage":false,"intro":"编程开发、系统架构、开源软件等技术干货分享中 ~","isFollowing":false,"urlToken":"c_1417572457507713024","id":"c_1417572457507713024","articlesCount":10,"acceptSubmission":true,"title":"我和我的架构师","url":"https:\u002F\u002Fzhuanlan.zhihu.com\u002Fc_1417572457507713024","commentPermission":"all","created":1630755611,"updated":1630756239,"imageUrl":"https:\u002F\u002Fpica.zhimg.com\u002F4b70deef7_720w.jpg?source=172ae18b","author":{"isFollowed":false,"avatarUrlTemplate":"https:\u002F\u002Fpic1.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6.jpg?source=172ae18b","uid":"811149941132103680","userType":"people","isFollowing":false,"urlToken":"qing-feng-32-87-12","id":"98c41cc0c09fe4fa6e50ac1e1dfc816f","description":"","name":"津的技术专栏","isAdvertiser":false,"headline":"编程开发、系统架构、开源软件等技术干货分享中 ~","gender":1,"url":"\u002Fpeople\u002F98c41cc0c09fe4fa6e50ac1e1dfc816f","avatarUrl":"https:\u002F\u002Fpicx.zhimg.com\u002Fv2-5555b2affad0a417b148c9e8977612f6_l.jpg?source=172ae18b","isOrg":false,"type":"people"},"followers":0,"type":"column"}},"topics":{},"roundtables":{},"favlists":{},"comments":{},"notifications":{},"ebooks":{},"activities":{},"feeds":{},"pins":{},"promotions":{},"drafts":{},"chats":{},"posts":{},"zvideos":{},"zvideoContributions":{},"briefs":{},"eduCourses":{}},"currentUser":"c29982ea4958b35f1d733b99ef5bf579","account":{"lockLevel":{},"unlockTicketStatus":false,"unlockTicket":null,"challenge":[],"errorStatus":false,"message":"","isFetching":false,"accountInfo":{},"urlToken":{"loading":false},"cardUserInfo":{"vipInfo":{}},"handleWidget":{},"widgetList":[],"userWidgetId":""},"settings":{"socialBind":null,"inboxMsg":null,"notification":{},"email":{},"privacyFlag":null,"blockedUsers":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"blockedFollowees":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"ignoredTopics":{"isFetching":false,"paging":{"pageNo":1,"pageSize":6},"data":[]},"restrictedTopics":null,"laboratory":{}},"notification":{},"people":{"profileStatus":{},"activitiesByUser":{},"answersByUser":{},"answersSortByVotesByUser":{},"answersIncludedByUser":{},"votedAnswersByUser":{},"thankedAnswersByUser":{},"voteAnswersByUser":{},"thankAnswersByUser":{},"topicAnswersByUser":{},"zvideosByUser":{},"articlesByUser":{},"articlesSortByVotesByUser":{},"articlesIncludedByUser":{},"pinsByUser":{},"questionsByUser":{},"commercialQuestionsByUser":{},"favlistsByUser":{},"followingByUser":{},"followersByUser":{},"mutualsByUser":{},"followingColumnsByUser":{},"followingQuestionsByUser":{},"followingFavlistsByUser":{},"followingTopicsByUser":{},"publicationsByUser":{},"columnsByUser":{},"allFavlistsByUser":{},"brands":null,"creationsByUser":{},"creationsSortByVotesByUser":{},"creationsFeed":{},"infinity":{},"batchUsers":{},"profileInfinity":null},"env":{"ab":{"config":{"params":[],"experiments":[],"chains":[],"encodedParams":"CjwbAD8ARwC0AGkBagF0ATsCzALXAtgCtwPWBFEFiwWMBZ4FMQbrBicHdAh5CPQJawq+CnELhwvlC+YL+AwSHgAAAAABAQAAAAAAAAQBAAABAQAAAAYDAAAAAAAAAA=="},"triggers":{}},"abV2":{"config":{"paramMap":{"in_editor_title":{"value":"1","abId":"rl-pineditor_title-1"},"ws_invite":{"value":"0"},"ws_rec":{"value":"0"},"pm_new_task":{"value":"0"},"ws_pc_route":{"value":"0"}},"abMap":{"rl-pineditor_title-1":{"abId":"rl-pineditor_title-1","layerId":"rl-pineditor_title","diversionType":2}}},"triggers":{}},"userAgent":{"Edge":false,"IE":false,"Wechat":false,"Weibo":false,"QQ":false,"MQQBrowser":false,"Qzone":false,"Mobile":false,"Android":false,"iOS":false,"isAppleDevice":false,"Zhihu":false,"ZhihuHybrid":false,"isBot":false,"Tablet":false,"UC":false,"Quark":false,"Sogou":false,"Qihoo":false,"Baidu":false,"BaiduApp":false,"Safari":false,"GoogleBot":false,"AndroidDaily":false,"iOSDaily":false,"WxMiniProgram":false,"BaiduMiniProgram":false,"QQMiniProgram":false,"JDMiniProgram":false,"isWebView":false,"isMiniProgram":false,"origin":"Mozilla\u002F5.0 (X11; Linux x86_64) AppleWebKit\u002F537.36 (KHTML, like Gecko) Chrome\u002F103.0.0.0 Safari\u002F537.36"},"appViewConfig":{},"ctx":{"path":"\u002Fp\u002F406832315","query":{},"href":"http:\u002F\u002Fzhuanlan.zhihu.com\u002Fp\u002F406832315","host":"zhuanlan.zhihu.com"},"trafficSource":"production","edition":{"beijing":true,"baidu":false,"sogou":false,"baiduBeijing":false,"sogouBeijing":false,"sogouInput":false,"oppoSearch":false,"baiduSearch":false,"googleSearch":false,"shenma":false,"miniProgram":false,"xiaomi":false},"theme":"light","appHeaderTheme":{"current":"normal","disable":true,"normal":{"bgColor":"GBK99A"},"custom":{"bgColor":"GBK99A"}},"enableShortcut":true,"referer":"https:\u002F\u002Fwww2.bing.com\u002F","xUDId":"AIAe75fvzhSPTpeNw8WYbUTCwgHWLCTfJt8=","mode":"ssr","conf":{},"xTrafficFreeOrigin":"","ipInfo":{"cityName":"北京","countryName":"中国","regionName":"北京","countryCode":"CN"},"logged":true,"vars":{"passThroughHeaders":{}}},"me":{"columnContributions":[]},"label":{"recognizerLists":{}},"ecommerce":{},"comments":{"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"parent":{}},"commentsV2":{"stickers":[],"commentWithPicPermission":{},"notificationsComments":{},"pagination":{},"collapsed":{},"reverse":{},"reviewing":{},"conversation":{},"conversationMore":{},"parent":{}},"pushNotifications":{"default":{"isFetching":false,"isDrained":false,"ids":[]},"follow":{"isFetching":false,"isDrained":false,"ids":[]},"vote_thank":{"isFetching":false,"isDrained":false,"ids":[]},"currentTab":"default","notificationsCount":{"default":0,"follow":0,"vote_thank":0}},"messages":{"data":{},"currentTab":"common","messageCount":0},"register":{"registerValidateSucceeded":null,"registerValidateErrors":{},"registerConfirmError":null,"sendDigitsError":null,"registerConfirmSucceeded":null},"login":{"loginUnregisteredError":false,"loginBindWechatError":false,"loginConfirmError":null,"sendDigitsError":null,"needSMSIdentify":false,"validateDigitsError":false,"loginConfirmSucceeded":null,"qrcodeLoginToken":"","qrcodeLoginScanStatus":0,"qrcodeLoginError":null,"qrcodeLoginReturnNewToken":false},"switches":{},"captcha":{"captchaNeeded":false,"captchaValidated":false},"sms":{"supportedCountries":[]},"chat":{"chats":{},"inbox":{"recents":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"strangers":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"friends":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"search":{"isFetching":false,"isDrained":false,"isPrevDrained":false,"result":[],"next":null,"key":null},"config":{"newCount":0,"strangerMessageSwitch":false,"strangerMessageUnread":false,"friendCount":0}},"global":{"isChatMqttExisted":false}},"emoticons":{"emoticonGroupList":[],"emoticonGroupDetail":{}},"creator":{"tools":{"question":{"invitationCount":{"questionFolloweeCount":0,"questionTotalCount":0}},"customPromotion":{"itemLists":{}},"recommend":{"recommendTimes":{}}},"explore":{},"rightsStatus":{},"levelUpperLimit":10,"mcn":{},"videoSupport":{},"textBenefit":{},"mcnManage":{},"tasks":{},"recentlyCreated":[],"announcement":{},"bannerList":[],"creatorsRecommendInfo":{}},"creators":{"bayesDomains":{"status":{},"options":{"topDomains":null,"allDomains":null,"editable":0},"contents":null},"school":{"tabs":[],"contents":[],"banner":null,"entities":{}},"faq":{"tabs":[],"article":{}},"knowledgeIncome":{},"safeguardRights":{},"analytics":{"all":{},"answer":{},"zvideo":{},"article":{},"pin":{},"singleContent":{}},"account":{"growthLevel":{}},"KMResource":{},"training":{},"ToolsQuestion":{"goodatTopics":[]},"ToolsHotspot":{"domains":[]},"ToolsSearchQuestion":{},"editorSetting":{},"MCNManage":{},"knowledgeTasks":{},"incomeAnalysis":{"income":{"aggregation":{}}},"creationManage":{"editModal":{"status":false}},"activity":{},"announcement":{},"home":{"currentCreatorUrlToken":null,"rights":[],"newRights":[],"applyStatus":{},"scoreInfo":{},"menusShowControlByServer":{"bVipRecomend":false,"creationRelationship":false},"newTasks":{"creatorTask":{"tasks":[],"des":[]}}}},"answers":{"voters":{},"copyrightApplicants":{},"favlists":{},"newAnswer":{},"entityWords":{},"concernedUpvoters":{},"simpleConcernedUpvoters":{},"paidContent":{},"settings":{}},"recommendation":{"homeRecommendations":[]},"shareTexts":{},"articles":{"voters":{},"concernedUpvoters":{}},"previewPost":{},"favlists":{"relations":{}},"columns":{"voters":{}},"reward":{"answer":{},"article":{},"question":{}},"video":{"data":{},"shareVideoDetail":{},"last":{}},"topstory":{"recommend":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"follow":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followWonderful":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"sidebar":null,"announcement":{},"hotList":[],"guestFeeds":{"isFetching":false,"isDrained":false,"afterId":0,"items":[],"next":null},"followExtra":{"isNewUser":null,"isFetched":false,"followCount":0,"followers":[]},"hotDaily":{"data":[],"paging":{}},"hotHighlight":{"isFetching":false,"isDrained":false,"data":[],"paging":{}},"banner":{},"commercialBanner":{"show":false,"banner":{},"trackData":{}},"video":{"items":[],"next":null,"isLoading":false,"isDrained":false}},"readStatus":{},"column":{},"requestColumn":{"categories":[],"error":null},"articleContribution":{"contributeRequests":[],"deleteContributeIdList":[],"handledContributeIdList":[],"recommendedColumns":[],"pinnedColumns":[],"sentContributeRequestsIdList":[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"c_1417572457507713024"]},"columnContribution":{"contributeRequests":[],"autoInviteEnabled":false,"recommendedContributors":[],"contributionInvitation":null},"draftHistory":{"history":{},"drafts":{}},"upload":{},"articleDraft":{"titleImage":"","titleImageSize":{},"isTitleImageFullScreen":false,"canTitleImageFullScreen":false,"title":"","titleImageUploading":false,"error":"","content":"","draftLoading":false,"updating":false,"globalLoading":false,"pendingVideo":{"resource":null,"error":null},"deleteFail":{"fail":false},"recommendTopics":[],"selectedColumn":0,"articleDisclaimers":[]},"articleDrafts":{"isDrained":false,"isLoading":false,"items":[]},"columnAutocomplete":{"users":[],"friends":[]},"columnCollection":{},"userProfit":{"permission":{"permissionStatus":{"zhiZixuan":0,"recommend":-1,"task":0,"plugin":0,"infinity":0},"visible":false}},"mcn":{"bindInfo":{},"memberCategoryList":[],"producerList":[],"categoryList":[],"lists":{},"banners":{},"protocolStatus":{"isAgreedNew":true,"isAgreedOld":true},"probationCountdownDays":0},"zvideos":{"campaignVideoList":{},"campaigns":{},"tagoreCategory":[],"recommendations":{},"insertable":{},"recruit":{"form":{"platform":"","nickname":"","followerCount":"","domain":"","contact":""},"submited":false,"ranking":[]},"qyActivityData":{},"talkActivityData":{},"party2022ActivityData":{},"batchVideos":{},"contribution":{"selectedContribution":null,"campaign":null,"configs":{},"contributionLists":{},"recommendQuestions":{"isLoading":true,"paging":{"isEnd":false,"isStart":true,"totals":0},"data":[]},"questionSearchResults":{"isLoading":true,"paging":{"isEnd":false,"isStart":true,"totals":0},"data":[]}},"creationReferences":{},"zvideoCollection":{},"zvideoGrant":{},"collectData":{"isFetching":false,"list":[]},"videoSource":{"isLoaded":false}},"republish":{},"commentPermission":{},"creatorRightStatus":{"list":[]},"adPromotion":{"answer":{},"article":{}}},"fetchHost":"www.zhihu.com","subAppName":"column","spanName":"Post","canaryConfig":{"test_canary":"0","use_new_player":"1","player_vendor":"1","use_hevc":"1","upload_use_signature":"1","use_backdrop_blur":"0","article_title_imagex":"0"}}</script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/vendor.8551e0b87fc43b2e5529.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/react.production.min.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/react-dom.production.min.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/react-dom-server.browser.production.min.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/runtime.app.7c5038017dcf17d5f66e.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/lib-2ec050f6.app.d775035239add1474147.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/lib-29107295.app.a5891096834538104d7e.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/lib-79b5cf47.app.7ec9842ac1b68669fb3a.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/lib-330004dc.app.0392aba96165d5f92d6c.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/lib-0e5ce61e.app.6d8a39a9f40142a4724c.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/5459.app.9d5586c01c265c2677c2.js"></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/column.app.53d9a84092165f45bf26.js"></script><script defer="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/aria.js" id="ariascripts" wapforceoldfixed="false" loaddata="false"></script><script src="./深入浅出：如何正确使用 protobuf - 知乎_files/hm.js" async=""></script><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/zap.js"></script><div><div style="display: none;"><i>想来知乎工作？请发送邮件到 jobs@zhihu.com</i></div></div><script src="./深入浅出：如何正确使用 protobuf - 知乎_files/push.js"></script><div><div><div class="css-8pdeid"></div></div></div><script crossorigin="" src="./深入浅出：如何正确使用 protobuf - 知乎_files/emoticon.js"></script><div><div><div class="Editable-languageSuggestions" style="left: -1179px; top: -999px;"><div><div class="Popover"><label class="Editable-languageSuggestionsInput Input-wrapper"><input autocomplete="off" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-activedescendant="AutoComplete7-0" id="Popover6-toggle" aria-haspopup="true" aria-owns="Popover6-content" class="Input" placeholder="选择语言" value=""><svg width="24" height="24" viewBox="0 0 24 24" fill="#afbdcf" class="Zi Zi--Select"><path fill-rule="evenodd" d="M12.53 3.47a.75.75 0 0 0-1.06 0l-5 5a.75.75 0 0 0 1.06 1.06L12 5.06l4.47 4.47a.75.75 0 1 0 1.06-1.06l-5-5Zm-5 11a.75.75 0 0 0-1.06 1.06l5 5a.75.75 0 0 0 1.06 0l5-5a.75.75 0 1 0-1.06-1.06L12 18.94l-4.47-4.47Z" clip-rule="evenodd"></path></svg></label></div></div></div></div></div></body></html>