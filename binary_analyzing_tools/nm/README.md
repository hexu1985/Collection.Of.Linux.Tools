好的，我们来详细说明 Linux 下的 `nm` 命令。

### 1. 命令概述

`nm`（Name List）命令是 Linux 及其它类 Unix 系统中的一个重要工具，用于**显示二进制目标文件（通常是库文件和可执行文件）的符号表**。符号表中包含了程序中定义的函数、全局变量以及引用的外部函数等信息。

通过 `nm`，开发者可以查看一个程序或库提供了哪些函数，又需要哪些外部函数，这对于调试、链接错误分析以及反向工程都非常有帮助。

---

### 2. 基本语法

```bash
nm [选项] <文件>
```

*   **文件**：可以是目标文件 (`.o`)、静态库文件 (`.a`)、共享库文件 (`.so`) 或可执行文件。

---

### 3. 常用选项

| 选项 | 全称 | 说明 |
| :--- | :--- | :--- |
| `-a` | `--debug-syms` | 显示所有符号，包括调试符号（通常以调试方式编译的程序会有很多这类符号）。 |
| `-g` | `--extern-only` | 仅显示外部（全局）符号。 |
| `-l` | `--line-numbers` | 使用调试信息，显示每个符号在源代码中对应的行号。需要文件附带调试信息 (`-g` 选项编译)。 |
| `-n` | `--numeric-sort` | 按符号地址的数值顺序排序，而不是按字母顺序。 |
| `-p` | `--no-sort` | 不排序，按符号在文件中的原始顺序显示。 |
| `-r` | `--reverse-sort` | 反向排序。 |
| `-S` | `--print-size` | 同时显示符号的大小。 |
| `-s` | `--print-armap` | 对于归档文件（静态库 `.a`），列出其内容目标文件的所有索引，而不仅仅是符号。 |
| `-u` | `--undefined-only` | 仅显示未定义的符号（即该文件引用但未定义的符号，需要外部提供）。 |
| `-C` | `--demangle` | **将 C++ 的修饰名（mangled name）解码为易读的函数签名**。**非常常用！** |
| `-D` | `--dynamic` | 显示动态符号，而不是普通的符号。对于动态库和可执行文件更有用。 |
| `-h` | `--help` | 显示帮助信息。 |
| `-V` | `--version` | 显示版本信息。 |

---

### 4. 输出符号类型详解

`nm` 命令输出的每一行通常包含三部分（如果使用 `-S` 选项则有四部分）：

`[地址] [类型] [符号名]`

或者

`[地址] [大小] [类型] [符号名]`

**最重要的部分是第二列的“类型”（一个字母）**，它说明了符号的性质：

| 类型字符 | 说明 |
| :--- | :--- |
| **A** | 符号的值是绝对的，在链接过程中不会被改变。 |
| **B** | 符号位于未初始化的数据段（BSS），如全局变量 `static int i;`。 |
| **C** | 公共/未初始化的符号。 |
| **D** | 符号位于已初始化的数据段，如全局变量 `int i = 10;`。 |
| **G** | 符号位于已初始化的数据段，用于小对象。 |
| **I** | 间接引用另一个符号。 |
| **N** | 调试符号。 |
| **R** | 符号位于只读数据段，如 `const` 全局变量。 |
| **T** | 符号位于代码段（文本段），通常是**函数**。 |
| **U** | **未定义的符号**。该符号在本目标文件中被引用，但并未在此定义。**需要从其他库或目标文件中链接进来**。 |
| **W** | 弱符号（Weak symbol），如果未被其他库定义，不会导致链接错误。 |
| **V** | 弱对象符号。 |
| **-** | a.out 目标文件中的 stabs 符号。 |
| **?** | 未知类型的符号。 |

**小写字母**：通常表示该符号是**局部（local）** 的，在文件外部不可见。例如：
*   `t`：局部函数。
*   `d`：局部已初始化变量。
*   `b`：局部未初始化变量（BSS）。

---

### 5. 常用示例

假设我们有一个名为 `main` 的可执行文件和一个名为 `libmath.a` 的静态库。

1.  **查看可执行文件的所有符号（不反修饰）**
    ```bash
    nm main
    ```
    输出可能包含大量难以阅读的 C++ 符号（如 `_Z4funcv`）。

2.  **查看可执行文件的所有符号（C++ 反修饰，更易读）**
    ```bash
    nm -C main
    ```
    输出会将 `_Z4funcv` 显示为 `func()`。

3.  **按地址排序查看符号**
    ```bash
    nm -n main
    ```

4.  **仅查看未定义的符号（即需要外部链接的符号）**
    ```bash
    nm -u main
    # 或使用反修饰
    nm -uC main
    ```
    这对于排查“未定义的引用”链接错误非常有用。

5.  **查看静态库的符号**
    ```bash
    nm libmath.a
    ```
    这会显示库中所有目标文件 (`.o`) 的符号。

6.  **查看动态符号（对于共享库 `.so` 或可执行文件）**
    ```bash
    nm -D libxxx.so
    ```

7.  **显示符号大小及其在源码中的行号（需要 `-g` 编译）**
    ```bash
    nm -SlC main
    ```
    输出示例：
    ```
    0000000000401106 0000000000000015 T func()    /home/user/project/main.cpp:10
    ```
    这表示函数 `func()` 位于地址 `0x401106`，大小为 `0x15` 字节，定义在 `main.cpp` 的第 10 行。

---

### 6. 应用场景总结

*   **调试链接错误**：使用 `nm -uC` 查看哪些符号未定义，使用 `nm -C` 查看目标文件或库是否包含了所需的符号。
*   **分析二进制文件结构**：了解程序有哪些函数和全局变量。
*   **验证编译结果**：检查函数或变量是否按预期被编译（如是否被优化掉，是否是弱符号等）。
*   **反向工程**：分析第三方库提供的接口。

`nm` 是系统程序员、嵌入式开发者和逆向工程师工具箱中一个非常基础且强大的工具。
